#TRUSTED 025eafb434446d0aa4873362d017b932bea8471beb274b129096ba6856c795d9a2e073b2055d1a0c4581fb9bc59893c61f184a0ad4cc8f2967626c131382535ac21ec9e2ddbc7514522835d383f4f46f498455d8ca2ef543b09f923ed1f36e518c7bca62a41d0f4fa331aa575f68a841720884a200f9be168176f74f880e1a1e653729d9780d8ca9ee5653085b52df0e4b0ed94c77c327b1a6021238fbc23282e69b84d34fb6a62dfdac4fddec26cc16136af9bb0731830a81fc9dd48e6d9baa41b3bc5a52bffed42ed9b7fc55430d022e3eafb0ecde45dbbd53e5bc4983921e85f934ed94cab5ba3bd9779d980b13b6d853f321d93138d19f6ac2f2bb5847793d950a5ecc74cda565de00cbf95533c971603bc05d262c8163cc397c1c956c65ce0ca6bfd2360e994599cf017036e23f2f4388c32f9244cc1edd1c31b9faec37fbf6ee993ba52b7132021d15a9db326573a31319441ba5e046639a206f19bfed70c527be9e100372a26bc04b9794b93b84c1aafc6dba2a9496feaad55a5d32d9f1ae56d70f2d602e95d6eba2dd1cf803265d71c5b529fbe7b209934bc3a8889820dedd8d51e00d671078bcf1c0f08811010272ec1d616c3980ce5082b4c0f9cdf812ed96e126c2a37397c145301514d84c6e820b11494218c15c9dcbdc478d635db07abcd98e8c867b0a8610784aa1db3cf32fccb889d2c4b927e3ffb0aeae94
#TRUST-RSA-SHA256 4b95b6b46f0024312b7a5f79171766ccd2657d763564f12aa1ecb067fc23fad6061b303326f4f3c5d14f795133b252d8315b24349756f8e761bfc718504661be8c3954b7f3c23eeefc9d7f7eb1e360dc7582e43b8dba468f9689af24cf3bd0e14058c9da3ce163393f4ef778209d66883d863453ef6011bf711c57042da9345c1d6b402c05c41f39b84ddfde4e7aece28b044d5e7b231aa0b511a64b8f1409e290aa1710c5b8a313f9f026289e64a52e9e4af3a6f5a79468e5e7dd8881e2d8878a82abcec136178d6f139b7bd2bedda8de21d9bba1f6ef93eae46b2e797899f6aecf312ee2b209656b6151437a7ebf41440f52e9e26dcdea14381d76ca9897a0300e4bf929109977973850f8471148d1ce18effab73a734730330e85d061414213f23067843266aa345adff15503e69bb60a7c1fa9d1808c8f08bf75c2d7eb49204a3976308f3362084f8eed3b39faa163c55d7c37dbf52eb3567b8cadb2b537630741d677431c797d2bc8a4253ad1525edd815e883e10954dbfc2f9dc784857082c8c25ac2e353571848431d094bb19936ac47f6434e937be8898f545aa6970f1cb262e5268690aef2ef8644353506d080e6255e2e80af451447e5dbfc00d958f8f947cb0f750c6fc2e644f7ba188b65ca7a1ddceefa6ea7050e4cc57e0713316edc3d48416c22ca0679b63fb1d06e08df1074380652aa4eeb8e4d8910f2f0c
#
# This script is Copyright (C) 2004-2025 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This script is released under the Tenable Subscription License and
# may not be used from within scripts released under another license
# without authorization from Tenable, Inc.
#
# See the following licenses for details:
#
# http://static.tenable.com/prod_docs/Nessus_6_SLA_and_Subscription_Agreement.pdf
#
# @PROFESSIONALFEED@
# $Revision: 1.0 $
# $Date: 2025/06/02 $
#
# description : This .audit is designed against the CIS Microsoft SQL Server 2019 Benchmark 1.5.0
#
#<ui_metadata>
#<display_name>CIS Microsoft SQL Server 2019 v1.5.0 L2 Database Engine</display_name>
#<spec>
#  <type>CIS</type>
#  <name>Microsoft SQL Server 2019</name>
#  <profile>L2 Database Engine</profile>
#  <version>1.5.0</version>
#  <link>https://workbench.cisecurity.org/benchmarks/18146</link>
#</spec>
#<labels>ms_sqldb,cis,microsoft_sql_server_2019</labels>
#<benchmark_refs>CSCv6,CSCv7,CSCv8,LEVEL</benchmark_refs>
#</ui_metadata>

<check_type:"MS_SQLDB">

<custom_item>
  type        : SQL_POLICY
  description : "7.3 Ensure Database Backups are Encrypted"
  info        : "Ensure Database Backups are Encrypted

Databases may contain sensitive data. Backups of this data allow the data to easily leave the Enterprise and secure environments. Encrypting the backup makes accessing the data much more difficult."
  solution    : "SQL Server backups need to 'Back up to a new media set', not 'Back up to the existing media set' in order to allow for encryption. The backup option to Encrypt Backup can be implemented after a Certificate or Asymmetric key has been applied to the SQL Server for this purpose.

Alternatively, encrypt the database with TDE. This automatically encrypts the backups as well. See 7.5

Impact:

A database backup accidentally exposed to the Internet or transmitted outside a secure environment can be easily restored to a SQL Server anywhere and its contents discovered."
  reference   : "800-171|3.13.16,800-171r3|03.13.08,800-53|SC-28(1),800-53r5|SC-28(1),CN-L3|8.1.4.7(b),CN-L3|8.1.4.8(b),CSF|PR.DS-1,CSF2.0|PR.DS-01,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(e)(2)(ii),ISO-27001-2022|A.5.33,ITSG-33|SC-28(1),LEVEL|2A,PCI-DSSv3.2.1|3.4,PCI-DSSv4.0|3.3.2,PCI-DSSv4.0|3.5.1,QCSC-v1|5.2.2,QCSC-v1|6.2,TBA-FIISB|28.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/18146"
  sql_request : "SELECT TOP 500 b.key_algorithm, b.encryptor_type, d.is_encrypted, b.database_name, b.server_name FROM msdb.dbo.backupset b inner join sys.databases d on b.database_name = d.name where b.key_algorithm IS NULL AND b.encryptor_type IS NULL AND d.is_encrypted = 0;"
  sql_types   : NULL
  sql_expect  : NULL
</custom_item>

<custom_item>
  type        : SQL_POLICY
  description : "7.4 Ensure Network Encryption is Configured and Enabled"
  info        : "Configuring and enabling network encryption ensures traffic between the application and the database system is encrypted. This will ensure compliance to security standards such as PCI DSS, which is required if connections are through a public network.

Network encryption can be configured in SQL Server either with self-signed certificates or TLS certificates.

Network encryption will ensure data transmitted over the network is protected, so attackers can't ex-filtrate passwords, and confidential data. This protects against man in the middle attack, and network sniffing attacks to ex-filtrate data transmitted between the database system and applications."
  solution    : "Refer to Microsoft SQL Server Encryption Documentation:

https://learn.microsoft.com/en-us/sql/relational-databases/security/encryption/sql-server-encryption"
  reference   : "800-171|3.1.13,800-171|3.5.2,800-171|3.13.8,800-171r3|03.05.07,800-171r3|03.05.12,800-171r3|03.13.08,800-53|AC-17(2),800-53|IA-5,800-53|IA-5(1),800-53|SC-8,800-53|SC-8(1),800-53r5|AC-17(2),800-53r5|IA-5,800-53r5|IA-5(1),800-53r5|SC-8,800-53r5|SC-8(1),CN-L3|7.1.2.7(g),CN-L3|7.1.3.1(d),CN-L3|8.1.2.2(a),CN-L3|8.1.2.2(b),CN-L3|8.1.4.1(c),CN-L3|8.1.4.7(a),CN-L3|8.1.4.8(a),CN-L3|8.2.4.5(c),CN-L3|8.2.4.5(d),CN-L3|8.5.2.2,CSCv7|14.4,CSCv8|3.10,CSF|PR.AC-1,CSF|PR.AC-3,CSF|PR.DS-2,CSF|PR.DS-5,CSF|PR.PT-4,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.AA-05,CSF2.0|PR.DS-02,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),HIPAA|164.312(e)(1),HIPAA|164.312(e)(2)(i),ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.14,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.17,ISO-27001-2022|A.5.33,ISO-27001-2022|A.6.7,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.6.2.2,ISO/IEC-27001|A.10.1.1,ISO/IEC-27001|A.13.2.3,ITSG-33|AC-17(2),ITSG-33|IA-5,ITSG-33|IA-5(1),ITSG-33|SC-8,ITSG-33|SC-8a.,ITSG-33|SC-8(1),LEVEL|2A,NESA|T4.3.1,NESA|T4.3.2,NESA|T4.5.1,NESA|T4.5.2,NESA|T5.2.3,NESA|T5.4.2,NESA|T7.3.3,NESA|T7.4.1,NIAv2|AM37,NIAv2|IE8,NIAv2|IE9,NIAv2|IE12,NIAv2|NS5d,NIAv2|NS6b,NIAv2|NS29,NIAv2|SS24,PCI-DSSv3.2.1|2.3,PCI-DSSv3.2.1|4.1,PCI-DSSv4.0|2.2.7,PCI-DSSv4.0|4.2.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|2.1,SWIFT-CSCv1|2.6,SWIFT-CSCv1|4.1,TBA-FIISB|29.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/18146"
  sql_request : "select distinct(encrypt_option) from sys.dm_exec_connections;"
  sql_types   : STRING
  sql_expect  : "TRUE"
</custom_item>

<custom_item>
  type        : SQL_POLICY
  description : "7.5 Ensure Databases are Encrypted with TDE"
  info        : "Ensure user databases are encrypted using Transparent Data Encryption (TDE). Backups of databases encrypted with TDE are automatically encrypted as well.

A malicious party who steals physical media like drives or backup tapes can restore or attach the database and browse its data.

One solution is to encrypt sensitive data in a database and use a certificate to protect the keys that encrypt the data. This solution prevents anyone without the keys from using the data."
  solution    : "Implement TDE encryption on each user database with sensitive data.

More info on how to do this is available here:

https://learn.microsoft.com/en-us/sql/relational-databases/security/encryption/transparent-data-encryption

Impact:

A database datafile, logfile or backup accidentally exposed to the Internet or transmitted outside a secure environment can be easily copied/restored to a SQL Server anywhere and its contents discovered."
  reference   : "800-171|3.5.2,800-171|3.13.16,800-171r3|03.05.07,800-171r3|03.13.08,800-53|IA-5(1),800-53|SC-28,800-53|SC-28(1),800-53r5|IA-5(1),800-53r5|SC-28,800-53r5|SC-28(1),CN-L3|8.1.4.7(b),CN-L3|8.1.4.8(b),CSCv7|14.8,CSCv8|3.11,CSF|PR.AC-1,CSF|PR.DS-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.DS-01,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(d),HIPAA|164.312(e)(2)(ii),ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.17,ISO-27001-2022|A.5.33,ITSG-33|IA-5(1),ITSG-33|SC-28,ITSG-33|SC-28a.,ITSG-33|SC-28(1),LEVEL|2A,NESA|T5.2.3,PCI-DSSv3.2.1|3.4,PCI-DSSv4.0|3.3.2,PCI-DSSv4.0|3.5.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|4.1,TBA-FIISB|28.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/18146"
  sql_request : "select database_id, name, is_encrypted from sys.databases where database_id > 4 and is_encrypted != 1;"
  sql_types   : NULL
  sql_expect  : NULL
</custom_item>

</check_type>
