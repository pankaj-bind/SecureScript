#TRUSTED ac05e0a73e3ec6c730e459e77eb3dc2d6c9012f2b062afd33739e1a748e5ff041f807a6c05a5069e7554c21154deff2067e4ceeef5c11bf07e907fbc8413d03eefc421964f01338b695ab5da45460f1ecc98fb654d24b37b6736a30aeea79233a3c6f75d26dec290efa8e258a2e1c0dd7aab128e560f21f8e1bb90d69a023b0073adb8bd1d587140c5c27181c97842b2e2583cdd56c7143e9d0b45c4135c9ac28cd4f61d7bc82274fd427644976a2de4c90aee13687254229b20dcfe23e225102f9733c89d5e1baf4fb94caa27b686a1567b0fcc349c57f743c94e6ad308b9b647f0d053efebea758c276c12be536fa67991a79b948c80ef9358c91f839f5a96a0c7073cf30b17bd419bb9d0960d6a927b13cd7dc558797fc99129beb1060a1935b7f1109ab997ea5dd0b802b599907391f3062af3fb681891dd50f6b9c8f80c371c57ee67c570ab2d078e5b586e39fa77760a36cbcea22025b59eb8a55663982ba1b4c193759f305cfa7c685e09a8d48e76f5f4fb58a7e1672ae9b68431cbc6573e848834ceb371d697e5bef045369360115e119ae6617efba09e21a59c57514457f98cda1eea07ee09ec6cb913f7cf2dcc9e54d7bbb70d16edf9812fca69c7c409489427f37e0781ed8bbd8de3d6b4abefe53e9244cca01ce18e920a583b9e64428bcabde2a53bff403f4943f06f2135f38fe5d30f3722a8d8737ceb3d3510
#TRUST-RSA-SHA256 6250dc1a3e62d15a914fa9f531ce779e54feb957cdec1fee843de57fa523d2002146342ab78c58f9584b134cf076ff06c6ffe4d4168772cce02632327b5f409b0db993bf4765cc12ef2e0ff316ae9b16eaff22205769a6b2874dc728cfa93c2b6bd5027bc9500a23853524c325952449ef1182b14a776497c604fc676148610eb2ca9513c9a47bc98c6ef6e33158e25e721fd323aa881ada6f57a245d6f3e5cae4fde3229448edbfcd1a62a0cf40db62b24a725b65994d00d9ace78a9ceab6e5ae3055f3fe3cb5baa7cc270be3602850e7400198eb0369add08de447232fe429aa46656ddd6e58f00dfd22041c68ed57b8eda3cc3a2c08d1193c407d71f6390471d0d183f0c1785de69659a6fff4bfb003533fb742c66e4477e9d004f60345fc1ee548bfb722d163de8d6fc0d9b107b0b2c68fa8f1a1e31fb171d809e4e6e12f966c37905c24f879a24dba53e46993768eadc796b1a68328d496c0360ad962d907636ce925323be1dc26cf86c8f1cbf340511dde096824a906148ac85bd4ef98d3a738276ac13fa2157127cdb87d07f024e040155c09be853c96f24ef6b2c39b1fea75ca80dc7c77b5b021e91573e543a49d85972882e859563ab7b5afb575fbc9f2ce67d4c3af22bab159d13488325e6a39bebbff0160c37404bb6144fc2c92d9ee5d7b5e9c68a35301512430617e481d711af4d1e1c83893f4a62faada5f66
#
# This script is Copyright (C) 2004-2025 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This script is released under the Tenable Subscription License and
# may not be used from within scripts released under another license
# without authorization from Tenable, Inc.
#
# See the following licenses for details:
#
# http://static.tenable.com/prod_docs/Nessus_6_SLA_and_Subscription_Agreement.pdf
#
# @PROFESSIONALFEED@
# $Revision: 1.0 $
# $Date: 2025/07/16 $
#
# description : This .audit is designed against the CIS VMware ESXi 7.0 Benchmark 1.5.0
#
#<ui_metadata>
#<display_name>CIS VMware ESXi 7.0 v1.5.0 L2 Bare Metal</display_name>
#<spec>
#  <type>CIS</type>
#  <name>VMware ESXi 7.0</name>
#  <profile>L2</profile>
#  <version>1.5.0</version>
#  <link>https://workbench.cisecurity.org/benchmarks/21406</link>
#</spec>
#<labels>unix,cis,vmware_esxi_7.0,vmware_esxi_unix</labels>
#<benchmark_refs>CSCv6,CSCv7,CSCv8,LEVEL</benchmark_refs>
#</ui_metadata>

<check_type:"Unix">

<if>
  <condition type:"AND">
    <custom_item>
      type        : CMD_EXEC
      description : "VMkernel found"
      cmd         : "uname -a"
      expect      : "VMkernel"
    </custom_item>
  </condition>

  <then>
    <report type:"PASSED">
      description : "CIS_VMware_ESXi_7.0_v1.5.0_L2.audit from CIS VMware ESXi 7.0 Benchmark v1.5.0"
      see_also    : "https://workbench.cisecurity.org/benchmarks/21406"
      show_output : YES
    </report>

    <custom_item>
      type        : CMD_EXEC
      description : "2.4 (L2) Ensure default self-signed certificate for ESXi communication is not used"
      info        : "The default certificate is self-signed, not signed by a trusted certificate authority (CA). It should be replaced with a valid certificate issued by a trusted CA. It should be noted that certificates are generated at time of install differing slightly from some self-signed certificate solutions.

Using the default self-signed certificate may increase risk related to man-in-the-middle (MITM) attacks.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
      solution    : "Backup and replace the details of the SSL certificate presented by the ESXi host and determine if it is issued by a trusted CA:

 - Log in to the ESXi Shell, either directly from the DCUI or from an SSH client, as a user with administrator privileges.
 - In the directory /etc/vmware/ssl, rename the existing certificates using the following commands:

mv rui.crt orig.rui.crt
mv rui.key orig.rui.key <xhtml:ol start=\"3\"> - Copy the certificates you want to use to /etc/vmware/ssl.
 - Rename the new certificate and key to rui.crt and rui.key.
 - Restart the host after you install the new certificate.

Alternatively, you can put the host into maintenance mode, install the new certificate, use the Direct Console User Interface (DCUI) to restart the management agents, and set the host to exit maintenance mode.

Leverage VMware's SSL Certificate Automation Tool to install CA-signed SSL certificates. For more information on this tool, please see [http://kb.vmware.com/kb/2057340](http://kb.vmware.com/kb/2057340).

Impact:

Replacing the default certificate might cause vCenter Server to stop managing the host. Disconnect and reconnect the host if vCenter Server cannot verify the new certificate."
      reference   : "800-171|3.4.1,800-171|3.4.2,800-171|3.4.6,800-171|3.4.7,800-171|3.13.1,800-171|3.13.2,800-171r3|03.04.01,800-171r3|03.04.02,800-171r3|03.04.06,800-171r3|03.16.01,800-53|CM-2,800-53|CM-6,800-53|CM-7,800-53|CM-7(1),800-53|CM-9,800-53|SA-3,800-53|SA-8,800-53|SA-10,800-53r5|CM-1,800-53r5|CM-2,800-53r5|CM-6,800-53r5|CM-7,800-53r5|CM-7(1),800-53r5|CM-9,800-53r5|SA-3,800-53r5|SA-8,800-53r5|SA-10,CSCv7|1.8,CSCv7|4.2,CSCv8|4.1,CSF|DE.AE-1,CSF|PR.DS-7,CSF|PR.IP-1,CSF|PR.IP-2,CSF|PR.IP-3,CSF|PR.PT-3,CSF2.0|DE.CM-09,CSF2.0|ID.AM-08,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-09,CSF2.0|PR.DS-10,CSF2.0|PR.IR-03,CSF2.0|PR.PS-01,CSF2.0|PR.PS-06,GDPR|32.1.b,HIPAA|164.306(a)(1),ISO-27001-2022|A.5.2,ISO-27001-2022|A.5.8,ISO-27001-2022|A.8.9,ISO-27001-2022|A.8.25,ISO-27001-2022|A.8.26,ISO-27001-2022|A.8.27,ISO-27001-2022|A.8.28,ISO-27001-2022|A.8.30,ISO-27001-2022|A.8.31,ISO-27001-2022|A.8.32,ITSG-33|CM-2,ITSG-33|CM-6,ITSG-33|CM-7,ITSG-33|CM-7(1),ITSG-33|CM-9,ITSG-33|SA-3,ITSG-33|SA-8,ITSG-33|SA-8a.,ITSG-33|SA-10,LEVEL|2M,NESA|T1.2.1,NESA|T1.2.2,NESA|T3.2.5,NESA|T3.4.1,NESA|T4.5.3,NESA|T4.5.4,NESA|T7.2.1,NESA|T7.5.1,NESA|T7.5.3,NESA|T7.6.1,NESA|T7.6.2,NESA|T7.6.3,NESA|T7.6.5,NIAv2|SS3,NIAv2|SS15a,NIAv2|SS16,NIAv2|VL2,PCI-DSSv3.2.1|2.2.2,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,SWIFT-CSCv1|2.3"
      see_also    : "https://workbench.cisecurity.org/benchmarks/21406"
      cmd         : "ls -al /etc/vmware/ssl/*rui*"
      expect      : "^Manual Review Required$"
      severity    : MEDIUM
    </custom_item>

    <if>
      <condition type:"AND">
        <custom_item>
          type        : FILE_CHECK
          description : "Check for existence of authorized_keys"
          file        : "/etc/ssh/keys-root/authorized_keys"
          required    : YES
        </custom_item>
      </condition>

      <then>
        <custom_item>
          type        : CMD_EXEC
          description : "5.7 (L2) Ensure the SSH authorized_keys file is empty"
          info        : "ESXi hosts come with Secure Shell (SSH), which can be configured to authenticate remote users using public key authentication. For day-to-day operations, the ESXi host should be in lockdown mode with the SSH service disabled. Lockdown mode does not prevent root users from logging in using keys. The presence of a remote user's public key in the /etc/ssh/keys-root/authorized_keys file on an ESXi host identifies the user as trusted, meaning the user is granted access to the host without providing a password.

Disabling authorized_keys access may limit your ability to run unattended remote scripts.

Keeping the authorized_keys file empty prevents users from circumventing the intended restrictions of lockdown mode."
          solution    : "To remove all keys from the authorized_keys file, perform the following:

 - Logon to the ESXi shell as root or another admin user.

 - SSH may need to be enabled first

<xhtml:ol start=\"2\"> - Edit the /etc/ssh/keys-root/authorized_keys file.
 - Remove all keys from the file and save the file."
          reference   : "800-171|3.1.1,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-171r3|03.01.01,800-171r3|03.01.02,800-171r3|03.01.05,800-171r3|03.01.05a.,800-171r3|03.01.05b.,800-171r3|03.03.08b.,800-53|AC-2,800-53|AC-3,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53r5|AC-2,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|9.2,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.33,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.15,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),LEVEL|2M,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
          see_also    : "https://workbench.cisecurity.org/benchmarks/21406"
          cmd         : "cat /etc/ssh/keys-root/authorized_keys | wc -l"
          expect      : "^0$"
        </custom_item>
      </then>

      <else>
        <report type:"PASSED">
          description : "5.7 (L2) Ensure the SSH authorized_keys file is empty"
          info        : "ESXi hosts come with Secure Shell (SSH), which can be configured to authenticate remote users using public key authentication. For day-to-day operations, the ESXi host should be in lockdown mode with the SSH service disabled. Lockdown mode does not prevent root users from logging in using keys. The presence of a remote user's public key in the /etc/ssh/keys-root/authorized_keys file on an ESXi host identifies the user as trusted, meaning the user is granted access to the host without providing a password.

Disabling authorized_keys access may limit your ability to run unattended remote scripts.

Keeping the authorized_keys file empty prevents users from circumventing the intended restrictions of lockdown mode."
          solution    : "To remove all keys from the authorized_keys file, perform the following:

 - Logon to the ESXi shell as root or another admin user.

 - SSH may need to be enabled first

<xhtml:ol start=\"2\"> - Edit the /etc/ssh/keys-root/authorized_keys file.
 - Remove all keys from the file and save the file."
          reference   : "800-171|3.1.1,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-171r3|03.01.01,800-171r3|03.01.02,800-171r3|03.01.05,800-171r3|03.01.05a.,800-171r3|03.01.05b.,800-171r3|03.03.08b.,800-53|AC-2,800-53|AC-3,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53r5|AC-2,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|9.2,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.33,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.15,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),LEVEL|2M,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
          see_also    : "https://workbench.cisecurity.org/benchmarks/21406"
        </report>
      </else>
    </if>
  </then>

  <else>
    <report type:"WARNING">
      description : "CIS_VMware_ESXi_7.0_v1.5.0_L2.audit from CIS VMware ESXi 7.0 Benchmark v1.5.0"
      info        : "NOTE: Nessus has not identified that the chosen audit applies to the target device."
      see_also    : "https://workbench.cisecurity.org/benchmarks/21406"
      show_output : YES
    </report>
  </else>
</if>

</check_type>
