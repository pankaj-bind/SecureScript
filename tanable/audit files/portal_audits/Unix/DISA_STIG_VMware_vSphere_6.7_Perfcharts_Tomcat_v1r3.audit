#TRUSTED 7e380acc1042053c496b594153dda59fdc27d0779291879e932ca5a6a9a2cefe9c01acaca9516ac3d15f4e928ce6de2946a0aff951b5bc40a7214c86f8e3ac1a0548fec21ca42350850c33082ff1fc10f3583a94fe8a1bb9125535a041114425fa99814669248aa8d1476ba803c7500057f25a059eb5e63c406b49e681c48d319d53197a2c8c6acbf4051937bab9545a0909820fb20a5fa946e31a359463d87e11a1b131505fb37829e5445c53b61e360a9e1578869a5df9992008c1f547d872987f3ae05fbbe184aa57fef35a57dd472329dfd39ea11021b5d540c09eed30331debedf73b16d007cff9c36dbb4fbb9f490c1f1e171ca966d250a9774f3d0243c582e3cd65a3785f9b2bb5aea0c00ab83cea99f8ea91e988e1600567c5ed64fbc64b476b3feef1e6eeec6bce52fbf47096ff34c5670714836619ea598517503d6bee4a42cdd2f8bd6fc6d701d9665cc05e237e71a5b0884d15d4dc46d2e9011d49238dad053b20a308a00e4eb35fb4e29bba539889a71433bd7070d6eaff5a13b7b0042c74ece568d436e34592e924c303662e6c6cb42b9ab039d972348289d5cacd59a2155c17db02c1d138a89e819016ec413671f8e1fdb2e111bec2b94f1271fb2109067bd9c01a4d94b2ea534806b63a0b4b1c385cbea98b1308ea97d5b0fef0006e28d28de53d43c1a5eb7d4a8cde9cf7365a2a3225b4d1bb8a931ac556
#TRUST-RSA-SHA256 562026ae54eb2647d3e4e2e5ad8f76211d3c8f19f87c4fa668d847528223fba75a262bd7912bf7e3cdf0fdf000e058d4201f9012a4a87ea117fa76441fdab24c3a57d935efcecda16bf2ec518884def51fb8f41b76fc26f552de0e1df77d829024c8c7c805d3249217af6313bdcd8d045c1f1d41864c66b9dbd31d5aecf907925e8e5a80ffe4581c60680013b1948a0d477e7af72fb246ee426df2fc5fed6a9e0f2e67bb0fabac0e7cd9ae40319c213b20b12dbd31d270eba131a30a04d496ce1dbb638d561302e6606fc2d44fc543c26a8f8b2bc3493dd3992ee603e133fcebd2dedeb5d32270c658a4d0a55be3de167542a030ea5d07d75fcb57b5aeca3072e5e399f3312ec4738fdcedee0ff178ecaa58421e6968a143dc7ecaa13832cf403c48224698cf553778d3ba15026d40c80dd918166fba2853560f885c3cb8dce44810877486d0962be53dd2af56e8a3f1334b5f661c3c81932eb937ae784b95ff76d25a8bac17684b44ab016d30d5451e283acbf4bec7bd9a9ede11c54a326481b20b9938bd739d301ca04597308132f0cbd3cd368dff4dc05fe2f2dbf970fcce693569deff8fb3055ffef73f3fca30f882a5e751fc759bf86cab54792b4c39e6eeefef712e2a146c72174717df501aaeca7cc8713e9a625b22c5cf466828bf89e2086419eef047a642a3525a54393bfc5ca40aceb2bc9175456d426728e728f2
#
# This script is Copyright (C) 2004-2024 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This script is released under the Tenable Subscription License and
# may not be used from within scripts released under another license
# without authorization from Tenable, Inc.
#
# See the following licenses for details:
#
# http://static.tenable.com/prod_docs/Nessus_6_SLA_and_Subscription_Agreement.pdf
#
# @PROFESSIONALFEED@
# $Revision: 1.1 $
# $Date: 2024/06/17 $
#
# Description : This document implements the security configuration as recommended by the
#               DISA VMware vSphere 6.7 Perfcharts Tomcat v1r3 STIG.
#
#<ui_metadata>
#<display_name>DISA STIG VMware vSphere 6.7 Perfcharts Tomcat v1r3</display_name>
#<spec>
#  <type>DISA STIG</type>
#  <name>VMware vSphere 6.7</name>
#  <profile>Perfcharts Tomcat</profile>
#  <version>1.3.0</version>
#  <link>https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip</link>
#</spec>
#<labels>disa,vmware_perfcharts_tomcat,agent,update_20230227</labels>
#<benchmark_refs>CAT,CCE,CCI,DISA_Benchmark,Group-ID,Rule-ID,STIG-ID,STIG-Legacy,Vuln-ID</benchmark_refs>
#</ui_metadata>

<check_type:"Unix">

<if>
  <condition type:"AND">
    <custom_item>
      type        : FILE_CHECK
      description : "Perfcharts Tomcat config exists"
      file        : "/usr/lib/vmware-perfcharts/tc-instance/conf/server.xml"
    </custom_item>
  </condition>

  <then>
    <report type:"PASSED">
      description : "DISA_STIG_VMware_vSphere_6.7_Perfcharts_Tomcat_v1r3.audit from DISA VMware vSphere 6.7 Perfcharts Tomcat v1r3 STIG"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
    </report>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000001 - Performance Charts must limit the amount of time that each TCP connection is kept alive."
      info        : "Denial of service (DoS) is one threat against web servers. Many DoS attacks attempt to consume web server resources in such a way that no more resources are available to satisfy legitimate requests.

In Tomcat, the 'connectionTimeout' attribute sets the number of milliseconds the server will wait after accepting a connection for the request URI line to be presented. This timeout will also be used when reading the request body (if any). This prevents idle sockets that are not sending HTTP requests from consuming system resources and potentially denying new connections."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/server.xml.

Navigate to each of the <Connector> nodes.

Configure each <Connector> node with the value:

connectionTimeout='20000'"
      reference   : "800-53|AC-10,800-53r5|AC-10,CAT|II,CCI|CCI-000054,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|AC-10,NESA|T5.5.1,QCSC-v1|5.2.1,QCSC-v1|5.2.2,Rule-ID|SV-239402r879511_rule,STIG-ID|VCPF-67-000001,Vuln-ID|V-239402"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/xmllint --xpath '/Server/Service/Connector/@connectionTimeout' /usr/lib/vmware-perfcharts/tc-instance/conf/server.xml"
      expect      : "^[\\s]*connectionTimeout[\\s]*=[\\s]*[\"']20000[\"'][\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000002 - Performance Charts must limit the number of concurrent connections permitted."
      info        : "Resource exhaustion can occur when an unlimited number of concurrent requests are allowed on a website, facilitating a denial-of-service attack. Unless the number of requests is controlled, the web server can consume enough system resources to cause a system crash.

Mitigating this kind of attack will include limiting the number of concurrent HTTP/HTTPS requests. In Tomcat, each incoming request requires a thread for the duration of that request. If more simultaneous requests are received than can be handled by the currently available request processing threads, additional threads will be created up to the value of the 'maxThreads' attribute."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/server.xml.

Navigate to the <Executor> mode with the name of 'tomcatThreadPool' and configure with the value 'maxThreads='300''.

Note: The <Executor> node should be configured as follows:

<Executor maxThreads='300' minSpareThreads='50' name='tomcatThreadPool' namePrefix='tomcat-http--'/>"
      reference   : "800-53|AC-10,800-53r5|AC-10,CAT|II,CCI|CCI-000054,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|AC-10,NESA|T5.5.1,QCSC-v1|5.2.1,QCSC-v1|5.2.2,Rule-ID|SV-239403r879511_rule,STIG-ID|VCPF-67-000002,Vuln-ID|V-239403"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/xmllint --xpath '/Server/Service/Executor/@maxThreads' /usr/lib/vmware-perfcharts/tc-instance/conf/server.xml"
      expect      : "^[\\s]*maxThreads[\\s]*=[\\s]*[\"']300[\"'][\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000003 - Performance Charts must limit the maximum size of a POST request."
      info        : "The 'maxPostSize' value is the maximum size in bytes of the POST that will be handled by the container FORM URL parameter parsing. Limiting its size will reduce exposure to a denial-of-service attack.

If 'maxPostSize' is not set, the default value of 2097152 (2MB) is used. Performance Charts is configured in its shipping state to not set a value for 'maxPostSize'."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/server.xml.

Navigate to each of the <Connector> nodes.

Remove any configuration for 'maxPostSize'."
      reference   : "800-53|AC-10,800-53r5|AC-10,CAT|II,CCI|CCI-000054,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|AC-10,NESA|T5.5.1,QCSC-v1|5.2.1,QCSC-v1|5.2.2,Rule-ID|SV-239404r879511_rule,STIG-ID|VCPF-67-000003,Vuln-ID|V-239404"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/xmllint --xpath '/Server/Service/Connector/@maxPostSize' /usr/lib/vmware-perfcharts/tc-instance/conf/server.xml"
      expect      : "^[\\s]*XPath[\\s]+set[\\s]+is[\\s]+empty[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000004 - Performance Charts must protect cookies from cross-site scripting (XSS)."
      info        : "Cookies are a common way to save session state over the HTTP(S) protocol. If an attacker can compromise session data stored in a cookie, they are better able to launch an attack against the server and its applications. When a cookie is tagged with the 'HttpOnly' flag, it tells the browser that this particular cookie should only be accessed by the originating server. Any attempt to access the cookie from client script is strictly forbidden.

Satisfies: SRG-APP-000001-WSR-000002, SRG-APP-000439-WSR-000154"
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/webapps/statsreport/WEB-INF/web.xml.

Navigate to the <session-config> node and configure it as follows:

<session-config>
      <cookie-config>
         <http-only>true</http-only>
         <secure>true</secure>
      </cookie-config>
      <session-timeout>6</session-timeout>
</session-config>"
      reference   : "800-171|3.13.8,800-53|AC-10,800-53|SC-8,800-53r5|AC-10,800-53r5|SC-8,CAT|II,CCI|CCI-000054,CCI|CCI-002418,CN-L3|8.1.2.2(a),CN-L3|8.1.2.2(b),CN-L3|8.1.4.7(a),CN-L3|8.1.4.8(a),CN-L3|8.2.4.5(c),CN-L3|8.2.4.5(d),CN-L3|8.5.2.2,CSF|PR.DS-2,CSF|PR.DS-5,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(e)(1),HIPAA|164.312(e)(2)(i),ITSG-33|AC-10,ITSG-33|SC-8,ITSG-33|SC-8a.,NESA|T4.3.1,NESA|T4.3.2,NESA|T4.5.1,NESA|T4.5.2,NESA|T5.5.1,NESA|T7.3.3,NESA|T7.4.1,NIAv2|IE8,NIAv2|IE9,NIAv2|IE12,NIAv2|NS29,NIAv2|SS24,PCI-DSSv3.2.1|2.3,PCI-DSSv3.2.1|4.1,PCI-DSSv4.0|2.2.7,PCI-DSSv4.0|4.2.1,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|6.2,Rule-ID|SV-239405r879511_rule,STIG-ID|VCPF-67-000004,Vuln-ID|V-239405"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/xmllint --format /usr/lib/vmware-perfcharts/tc-instance/webapps/statsreport/WEB-INF/web.xml | /usr/bin/sed 's/xmlns=\".*\"//g' | /usr/bin/xmllint --xpath '/web-app/session-config/cookie-config/http-only' -"
      expect      : "^[\\s]*<http-only>true</http-only>[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000005 - Performance Charts must record user access in a format that enables monitoring of remote access."
      info        : "Remote access can be exploited by an attacker to compromise the server. By recording all remote access activities, it will be possible to determine the attacker's location, intent, and degree of success.

Tomcat can be configured with an 'AccessLogValve', a component that can be inserted into the request processing pipeline to provide robust access logging. The AccessLogValve creates log files in the same format as those created by standard web servers. When AccessLogValve is properly configured, log files will contain all the forensic information necessary in the case of a security incident.

Satisfies: SRG-APP-000016-WSR-000005, SRG-APP-000095-WSR-000056, SRG-APP-000096-WSR-000057, SRG-APP-000097-WSR-000058, SRG-APP-000098-WSR-000059, SRG-APP-000098-WSR-000060, SRG-APP-000099-WSR-000061, SRG-APP-000100-WSR-000064, SRG-APP-000374-WSR-000172, SRG-APP-000375-WSR-000171"
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/server.xml.

Inside the <Host> node, add the 'AccessLogValve' <Valve> node entirely if it does not exist or update the existing pattern to match the following line:

<Valve className='org.apache.catalina.valves.AccessLogValve' directory='${vim.logdir}' pattern='%h %{X-Forwarded-For}i %l %u %t &quot;%r&quot; %s %b &quot;%{User-Agent}i&quot;' prefix='localhost_access_log' suffix='.txt'/>"
      reference   : "800-171|3.1.12,800-171|3.3.1,800-171|3.3.2,800-171|3.3.7,800-53|AC-17(1),800-53|AU-3,800-53|AU-8b.,800-53|AU-14(2),800-53r5|AC-17(1),800-53r5|AU-3,800-53r5|AU-8b.,800-53r5|AU-14,CAT|II,CCI|CCI-000067,CCI|CCI-000130,CCI|CCI-000131,CCI|CCI-000132,CCI|CCI-000133,CCI|CCI-000134,CCI|CCI-001462,CCI|CCI-001487,CCI|CCI-001889,CCI|CCI-001890,CN-L3|7.1.2.3(a),CN-L3|7.1.2.3(b),CN-L3|7.1.3.3(a),CN-L3|8.1.4.3(b),CN-L3|8.1.4.4(c),CN-L3|8.1.10.6(i),CSF|PR.AC-3,CSF|PR.PT-1,CSF|PR.PT-4,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO/IEC-27001|A.6.2.2,ITSG-33|AC-17(1),ITSG-33|AU-3,ITSG-33|AU-8,ITSG-33|AU-14a.,NESA|T3.6.2,NESA|T3.6.7,NESA|T5.4.4,NIAv2|AM34a,NIAv2|AM34b,NIAv2|AM34c,NIAv2|AM34d,NIAv2|AM34e,NIAv2|AM34f,NIAv2|AM34g,PCI-DSSv3.2.1|10.3,PCI-DSSv3.2.1|10.3.1,PCI-DSSv3.2.1|10.3.2,PCI-DSSv3.2.1|10.3.3,PCI-DSSv3.2.1|10.3.4,PCI-DSSv3.2.1|10.3.5,PCI-DSSv3.2.1|10.3.6,PCI-DSSv4.0|10.2.2,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|8.2.1,QCSC-v1|13.2,Rule-ID|SV-239406r879521_rule,STIG-ID|VCPF-67-000005,SWIFT-CSCv1|2.6,SWIFT-CSCv1|6.4,TBA-FIISB|37.4,Vuln-ID|V-239406"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/xmllint --format /usr/lib/vmware-perfcharts/tc-instance/conf/server.xml | /usr/bin/sed '2 s/xmlns=\".*\"//g' | /usr/bin/xmllint --xpath '/Server/Service/Engine/Host/Valve[@className=\"org.apache.catalina.valves.AccessLogValve\"]'/@pattern -"
      expect      : "^[\\s]*pattern[\\s]*=[\\s]*[\"'][\\s]*%h[\\s]+%\\{X-Forwarded-For\\}i[\\s]+%l[\\s]+%u[\\s]+%t[\\s]+(\"|'|&quot;)%r(\"|'|&quot;)[\\s]+%s[\\s]+%b[\\s]+(\"|'|&quot;)%\\{User-Agent\\}i(\"|'|&quot;)[\"'][\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK
      description : "VCPF-67-000006 - Performance Charts must generate log records for system startup and shutdown."
      info        : "Logging must be started as soon as possible when a service starts and when a service is stopped. Many forms of suspicious actions can be detected by analyzing logs for unexpected service starts and stops. Also, by starting to log immediately after a service starts, it becomes more difficult for suspicious activity to go unlogged.

On the VCSA, the 'vmware-vmon' service starts up the Java virtual machines (JVMs) for various vCenter processes, including Performance Charts, and the individual 'json' config files control the early JVM logging. Ensuring these 'json' files are configured correctly enables early Java 'stdout' and 'stderr' logging.

Satisfies: SRG-APP-000089-WSR-000047, SRG-APP-000092-WSR-000055"
      solution    : "Navigate to and open /etc/vmware/vmware-vmon/svcCfgfiles/perfcharts.json.

Below the last line of the 'PreStartCommandArg' block, add the following line:

'StreamRedirectFile' : '%VMWARE_LOG_DIR%/vmware/perfcharts/vmware-perfcharts-runtime.log',

Restart the appliance for changes to take effect."
      reference   : "800-171|3.3.1,800-171|3.3.2,800-171|3.3.8,800-53|AU-9,800-53|AU-12a.,800-53|AU-14(1),800-53r5|AU-9,800-53r5|AU-12a.,800-53r5|AU-14(1),CAT|II,CCI|CCI-000163,CCI|CCI-000169,CCI|CCI-001464,CN-L3|7.1.2.3(d),CN-L3|7.1.3.3(f),CN-L3|8.1.3.5(c),CN-L3|8.1.4.3(c),CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO/IEC-27001|A.12.4.2,ITSG-33|AU-9,ITSG-33|AU-12a.,ITSG-33|AU-14,NESA|M5.2.3,NESA|M5.5.2,NESA|T3.6.4,NESA|T8.2.9,NIAv2|SM5,NIAv2|SM6,PCI-DSSv3.2.1|10.1,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,Rule-ID|SV-239407r879559_rule,STIG-ID|VCPF-67-000006,SWIFT-CSCv1|6.4,Vuln-ID|V-239407"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      file        : "/etc/vmware/vmware-vmon/svcCfgfiles/perfcharts.json"
      regex       : "^[\\s]*[\"']StreamRedirectFile[\"'][\\s]*:"
      expect      : "^[\\s]*[\"']StreamRedirectFile[\"'][\\s]*:[\\s]*[\"']%VMWARE_LOG_DIR%/vmware/perfcharts/vmware-perfcharts-runtime.log[\"'],[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000007 - Performance Charts log files must only be modifiable by privileged users."
      info        : "Log data is essential in the investigation of events. The accuracy of the information is always pertinent. One of the first steps an attacker will undertake is the modification or deletion of log records to cover tracks and prolong discovery. The web server must protect the log data from unauthorized modification. Performance Charts restricts all modification of log files by default, but this configuration must be verified.

Satisfies: SRG-APP-000119-WSR-000069, SRG-APP-000120-WSR-000070"
      solution    : "At the command prompt, execute the following commands:

# chmod o-w <file>

# chown root:root <file>

Note: Substitute <file> with the listed file."
      reference   : "800-171|3.3.8,800-53|AU-9,800-53r5|AU-9,CAT|II,CCI|CCI-000163,CCI|CCI-000164,CN-L3|7.1.2.3(d),CN-L3|7.1.3.3(f),CN-L3|8.1.3.5(c),CN-L3|8.1.4.3(c),CSF|PR.PT-1,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO/IEC-27001|A.12.4.2,ITSG-33|AU-9,NESA|M5.2.3,NESA|M5.5.2,NESA|T3.6.4,NESA|T8.2.9,NIAv2|SM5,NIAv2|SM6,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|10.3.2,QCSC-v1|8.2.1,QCSC-v1|13.2,Rule-ID|SV-239408r879577_rule,STIG-ID|VCPF-67-000007,Vuln-ID|V-239408"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/find /storage/log/vmware/perfcharts/ -xdev -type f -a '(' -perm -o+w -o -not -user root -o -not -group root ')' -exec ls -ld {} \\; | /usr/bin/awk '{print} END {if (NR == 0) print \"pass\"; else print \"fail\"}'"
      expect      : "^pass$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000008 - Performance Charts application files must be verified for their integrity."
      info        : "Verifying that the Security Token Service application code is unchanged from its shipping state is essential for file validation and nonrepudiation of Performance Charts. There is no reason that the MD5 hash of the rpm original files should be changed after installation, excluding configuration files."
      solution    : "Reinstall the VCSA or roll back to a snapshot. Modifying the Performance Charts installation files manually is not supported by VMware."
      reference   : "800-171|3.4.5,800-53|CM-5(3),800-53r5|CM-14,CAT|II,CCI|CCI-001749,CSF|PR.IP-1,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|CM-5(3),NESA|T3.2.3,NESA|T5.1.1,NESA|T5.6.1,NESA|T7.5.1,NESA|T7.5.3,NESA|T7.6.3,QCSC-v1|7.2,Rule-ID|SV-239409r879584_rule,STIG-ID|VCPF-67-000008,Vuln-ID|V-239409"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/rpm -V VMware-perfcharts|grep '^..5......' | /usr/bin/grep '/usr/lib' | /usr/bin/grep -v -E '\.properties|\.conf|\.xml' | /usr/bin/awk '{print} END {if (NR == 0) print \"pass\"; else print \"fail\"}'"
      expect      : "^[\\s]*pass[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000009 - Performance Charts must only run one web app."
      info        : "VMware ships Performance Charts on the VCSA with one web app. Any other path is potentially malicious and must be removed."
      solution    : "For each unexpected directory returned in the check, run the following command:

# rm /usr/lib/vmware-sso/vmware-sts/webapps/<NAME>

Restart the service with the following command:

# service-control --restart vmware-perfcharts"
      reference   : "800-171|3.4.5,800-53|CM-5(3),800-53r5|CM-14,CAT|II,CCI|CCI-001749,CSF|PR.IP-1,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|CM-5(3),NESA|T3.2.3,NESA|T5.1.1,NESA|T5.6.1,NESA|T7.5.1,NESA|T7.5.3,NESA|T7.6.3,QCSC-v1|7.2,Rule-ID|SV-239410r879584_rule,STIG-ID|VCPF-67-000009,Vuln-ID|V-239410"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/echo $(/usr/bin/ls -A /usr/lib/vmware-perfcharts/tc-instance/webapps)"
      expect      : "^[\\s]*statsreport[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK_NOT
      description : "VCPF-67-000010 - Performance Charts must not be configured with unsupported realms."
      info        : "Performance Charts performs user authentication at the application level and not through Tomcat. Depending on the VCSA version, Performance Charts may come configured with a 'UserDatabaseRealm'. This should be removed as part of eliminating unnecessary features."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/server.xml.

Remove the <Realm> node returned in the check."
      reference   : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7a.,800-53r5|CM-7a.,CAT|II,CCI|CCI-000381,CN-L3|7.1.3.5(c),CN-L3|8.1.4.4(a),CSF|PR.IP-1,CSF|PR.PT-3,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|CM-7a.,NIAv2|SS15a,PCI-DSSv3.2.1|2.2.1,PCI-DSSv4.0|2.2.3,QCSC-v1|3.2,Rule-ID|SV-239411r879587_rule,STIG-ID|VCPF-67-000010,SWIFT-CSCv1|2.3,Vuln-ID|V-239411"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      file        : "/usr/lib/vmware-perfcharts/tc-instance/conf/server.xml"
      regex       : "UserDatabaseRealm"
      expect      : "UserDatabaseRealm"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK_NOT
      description : "VCPF-67-000011 - Performance Charts must have Multipurpose Internet Mail Extensions (MIME) that invoke OS shell programs disabled."
      info        : "MIME mappings tell the Performance Charts what type of program various file types and extensions are and what external utilities or programs are needed to execute the file type. By ensuring that various shell script MIME types are not included in web.xml, the server is protected against malicious users tricking the server into executing shell command files."
      solution    : "Open /usr/lib/vmware-perfcharts/tc-instance/conf/web.xml in a text editor.

Remove any and all of the following nodes lines:

<mime-type>application/x-csh</mime-type>
<mime-type>application/x-shar</mime-type>
<mime-type>application/x-sh</mime-type>
<mime-type>application/x-ksh</mime-type>"
      reference   : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7a.,800-53r5|CM-7a.,CAT|II,CCI|CCI-000381,CN-L3|7.1.3.5(c),CN-L3|8.1.4.4(a),CSF|PR.IP-1,CSF|PR.PT-3,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|CM-7a.,NIAv2|SS15a,PCI-DSSv3.2.1|2.2.1,PCI-DSSv4.0|2.2.3,QCSC-v1|3.2,Rule-ID|SV-239412r879587_rule,STIG-ID|VCPF-67-000011,SWIFT-CSCv1|2.3,Vuln-ID|V-239412"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      file        : "/usr/lib/vmware-perfcharts/tc-instance/conf/web.xml"
      regex       : "(x-csh|x-sh|x-shar|x-ksh)<"
      expect      : "(x-csh|x-sh|x-shar|x-ksh)<"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000012 - Performance Charts must have mappings set for Java servlet pages."
      info        : "Resource mapping is the process of tying a particular file type to a process in the web server that can serve that type of file to a requesting client and to identify which file types are not to be delivered to a client.

By not specifying which files can and cannot be served to a user, the web server could deliver to a user web server configuration files, log files, password files, etc.

Because Tomcat is a Java-based web server, the main file extension used is *.jsp. This check ensures that the *.jsp and *.jspx file types have been properly mapped to servlets."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/web.xml.

Inside the <web-app> parent node, add the following:

<servlet-mapping>
    <servlet-name>jsp</servlet-name>
    <url-pattern>*.jsp</url-pattern>
    <url-pattern>*.jspx</url-pattern>
  </servlet-mapping>"
      reference   : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7a.,800-53r5|CM-7a.,CAT|II,CCI|CCI-000381,CN-L3|7.1.3.5(c),CN-L3|8.1.4.4(a),CSF|PR.IP-1,CSF|PR.PT-3,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|CM-7a.,NIAv2|SS15a,PCI-DSSv3.2.1|2.2.1,PCI-DSSv4.0|2.2.3,QCSC-v1|3.2,Rule-ID|SV-239413r879587_rule,STIG-ID|VCPF-67-000012,SWIFT-CSCv1|2.3,Vuln-ID|V-239413"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/echo $(/usr/bin/xmllint --format /usr/lib/vmware-perfcharts/tc-instance/conf/web.xml | /usr/bin/sed '2 s/xmlns=\".*\"//g' | xmllint --xpath '/web-app/servlet-mapping/servlet-name[text()=\"jsp\"]/parent::servlet-mapping' -)"
      expect      : "^[\\s]*<servlet-mapping>[\\s]*<servlet-name>jsp</servlet-name>[\\s]*<url-pattern>\\*.jsp</url-pattern>[\\s]*<url-pattern>\\*.jspx</url-pattern>[\\s]*</servlet-mapping>[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK_NOT
      description : "VCPF-67-000013 - Performance Charts must not have the Web Distributed Authoring (WebDAV) servlet installed."
      info        : "WebDAV is an extension to the HTTP protocol that, when developed, was meant to allow users to create, change, and move documents on a server, typically a web server or web share. WebDAV is not widely used and has serious security concerns because it may allow clients to modify unauthorized files on the web server and must therefore be disabled.

Tomcat uses the 'org.apache.catalina.servlets.WebdavServlet' servlet to provide WebDAV services. Because the WebDAV service has been found to have an excessive number of vulnerabilities, this servlet must not be installed. Performance Charts does not configure WebDAV by default."
      solution    : "Open /usr/lib/vmware-perfcharts/tc-instance/conf/web.xml in a text editor.

Find the <servlet-name>webdav</servlet-name> node and remove the entire parent <servlet> block.

Find the <servlet-name>webdav</servlet-name> node and remove the entire parent <servlet-mapping> block."
      reference   : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7a.,800-53r5|CM-7a.,CAT|II,CCI|CCI-000381,CN-L3|7.1.3.5(c),CN-L3|8.1.4.4(a),CSF|PR.IP-1,CSF|PR.PT-3,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|CM-7a.,NIAv2|SS15a,PCI-DSSv3.2.1|2.2.1,PCI-DSSv4.0|2.2.3,QCSC-v1|3.2,Rule-ID|SV-239414r879587_rule,STIG-ID|VCPF-67-000013,SWIFT-CSCv1|2.3,Vuln-ID|V-239414"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      file        : "/usr/lib/vmware-perfcharts/tc-instance/conf/web.xml"
      regex       : "webdav"
      expect      : "webdav"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK
      description : "VCPF-67-000014 - Performance Charts must be configured with memory leak protection."
      info        : "The Java Runtime environment can cause a memory leak or lock files under certain conditions. Without memory leak protection, Performance Chart can continue to consume system resources that will lead to 'OutOfMemoryErrors' when reloading web applications.

Memory leaks occur when JRE code uses the context class loader to load a singleton. This will cause a memory leak if a web application class loader happens to be the context class loader at the time. The 'JreMemoryLeakPreventionListener' class is designed to initialize these singletons when Tomcat's common class loader is the context class loader. Proper use of JRE memory leak protection will ensure that the hosted application does not consume system resources and cause an unstable environment."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/server.xml.

Navigate to the <Server> node.

Add '<Listener className='org.apache.catalina.core.JreMemoryLeakPreventionListener'/>' to the <Server> node."
      reference   : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7a.,800-53r5|CM-7a.,CAT|II,CCI|CCI-000381,CN-L3|7.1.3.5(c),CN-L3|8.1.4.4(a),CSF|PR.IP-1,CSF|PR.PT-3,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|CM-7a.,NIAv2|SS15a,PCI-DSSv3.2.1|2.2.1,PCI-DSSv4.0|2.2.3,QCSC-v1|3.2,Rule-ID|SV-239415r879587_rule,STIG-ID|VCPF-67-000014,SWIFT-CSCv1|2.3,Vuln-ID|V-239415"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      file        : "/usr/lib/vmware-perfcharts/tc-instance/conf/server.xml"
      regex       : "<Listener[\\s]+className=[\"']org.apache.catalina.core.JreMemoryLeakPreventionListener[\"']/>"
      expect      : "<Listener[\\s]+className=[\"']org.apache.catalina.core.JreMemoryLeakPreventionListener[\"']/>"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000015 - Performance Charts must not have any symbolic links in the web content directory tree."
      info        : "A web server is designed to deliver content and execute scripts or applications on the request of a client or user. Containing user requests to files in the directory tree of the hosted web application and limiting the execution of scripts and applications guarantees that the user is not accessing information protected outside the application's realm.

By checking that no symbolic links exist in the document root, the web server is protected from users jumping outside the hosted application directory tree and gaining access to the other directories, including the system root."
      solution    : "At the command prompt, execute the following commands:

Note: Replace <file_name> for the name of any files that were returned.

# unlink <file_name>

Repeat the commands for each file that was returned."
      reference   : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7a.,800-53r5|CM-7a.,CAT|II,CCI|CCI-000381,CN-L3|7.1.3.5(c),CN-L3|8.1.4.4(a),CSF|PR.IP-1,CSF|PR.PT-3,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|CM-7a.,NIAv2|SS15a,PCI-DSSv3.2.1|2.2.1,PCI-DSSv4.0|2.2.3,QCSC-v1|3.2,Rule-ID|SV-239416r879587_rule,STIG-ID|VCPF-67-000015,SWIFT-CSCv1|2.3,Vuln-ID|V-239416"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/find /usr/lib/vmware-perfcharts/tc-instance/webapps/ -type l -ls | /usr/bin/awk '{print} END {if (NR == 0) print \"pass\"; else print \"fail\"}'"
      expect      : "^pass$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000016 - Performance Charts directory tree must have permissions in an 'out-of-the box' state - out-of-the box state."
      info        : "Accounts on a web server are to be kept to a minimum. Only administrators, web managers, developers, auditors, and web authors require accounts on the machine hosting the web server. The resources to which these accounts have access must also be closely monitored and controlled. Performance Charts files must be adequately protected with correct permissions as applied 'out of the box'.

Satisfies: SRG-APP-000211-WSR-000030, SRG-APP-000380-WSR-000072"
      solution    : "At the command prompt, execute the following command:

# chown perfcharts:cis <file_name>

Repeat the command for each file that was returned.

Note: Replace <file_name> for the name of the file that was returned."
      reference   : "800-171|3.4.5,800-171|3.13.3,800-53|CM-5(1),800-53|SC-2,800-53r5|CM-5(1),800-53r5|SC-2,CAT|II,CCI|CCI-001082,CCI|CCI-001813,CSF|PR.IP-1,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|CM-5(1),ITSG-33|SC-2,ITSG-33|SC-2a.,NESA|T3.4.1,NESA|T5.1.1,NESA|T5.6.1,NESA|T7.5.3,NIAv2|SS15b,QCSC-v1|7.2,Rule-ID|SV-239417r879631_rule,STIG-ID|VCPF-67-000016,Vuln-ID|V-239417"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/find /usr/lib/vmware-perfcharts/tc-instance/webapps/ -xdev -type f -a '(' -not -user perfcharts -o -not -group cis ')' -exec ls -A {} \\; | /usr/bin/grep -v '/usr/lib/vmware-perfcharts/tc-instance/webapps/statsreport/WEB-INF/web.xml' | /usr/bin/awk '{print} END {if (NR == 0) print \"pass\"; else print \"fail\"}'"
      expect      : "^pass$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK
      description : "VCPF-67-000017 - Performance Charts must fail to a known safe state if system initialization fails, shutdown fails, or aborts fail."
      info        : "Determining a safe state for failure and weighing that against a potential denial of service for users depends on what type of application the web server is hosting. For Performance Charts, it is preferable that the service abort startup on any initialization failure rather than continuing in a degraded, and potentially insecure, state."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/catalina.properties.

Add or change the following line:

org.apache.catalina.startup.EXIT_ON_INIT_FAILURE=true"
      reference   : "800-53|SC-24,800-53r5|SC-24,CAT|II,CCI|CCI-001190,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|SC-24,ITSG-33|SC-24a.,QCSC-v1|5.2.1,Rule-ID|SV-239418r879640_rule,STIG-ID|VCPF-67-000017,Vuln-ID|V-239418"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      file        : "/usr/lib/vmware-perfcharts/tc-instance/conf/catalina.properties"
      regex       : "^[\\s]*org.apache.catalina.startup.EXIT_ON_INIT_FAILURE[\\s]*="
      expect      : "^[\\s]*org.apache.catalina.startup.EXIT_ON_INIT_FAILURE[\\s]*=[\\s]*true[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000018 - Performance Charts must limit the number of allowed connections."
      info        : "Limiting the number of established connections to Performance Charts is a basic denial-of-service protection. Servers where the limit is too high or unlimited can potentially run out of system resources and negatively affect system availability."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/server.xml.

Configure the <Connector> node with the following value:

acceptCount='300'"
      reference   : "800-53|SC-5(1),800-53r5|SC-5(1),CAT|II,CCI|CCI-001094,CSF|DE.CM-1,CSF|PR.DS-4,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|SC-5(1),NESA|T3.3.1,NIAv2|GS8e,NIAv2|GS10c,QCSC-v1|8.2.1,Rule-ID|SV-239419r879650_rule,STIG-ID|VCPF-67-000018,Vuln-ID|V-239419"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/xmllint --xpath '/Server/Service/Connector/@acceptCount' /usr/lib/vmware-perfcharts/tc-instance/conf/server.xml"
      expect      : "^[\\s]*acceptCount[\\s]*=[\\s]*[\"']300[\"'][\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000019 - Performance Charts must set 'URIEncoding' to UTF-8 - URIEncoding to UTF-8."
      info        : "Invalid user input occurs when a user inserts data or characters into a hosted application's data entry field and the hosted application is unprepared to process that data. This results in unanticipated application behavior, potentially leading to an application compromise. Invalid user input is one of the primary methods employed when attempting to compromise an application.

An attacker can also enter Unicode characters into hosted applications in an effort to break out of the document home or root home directory or to bypass security checks. Performance Charts must be configured to use a consistent character set via the 'URIEncoding' attribute on the Connector nodes."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/server.xml.

Configure the <Connector> node with the value 'URIEncoding='UTF-8''."
      reference   : "800-53|SI-10,800-53r5|SI-10,CAT|II,CCI|CCI-001310,CN-L3|8.1.4.4(d),DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|SI-10,ITSG-33|SI-10a.,NESA|T7.3.1,NESA|T7.3.2,NIAv2|SS6e,Rule-ID|SV-239420r879652_rule,STIG-ID|VCPF-67-000019,Vuln-ID|V-239420"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/xmllint --xpath '/Server/Service/Connector/@URIEncoding' /usr/lib/vmware-perfcharts/tc-instance/conf/server.xml"
      expect      : "^[\\s]*URIEncoding[\\s]*=[\\s]*[\"']UTF-8[\"'][\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000020 - Performance Charts must use the 'setCharacterEncodingFilter' filter - filter-mapping"
      info        : "Invalid user input occurs when a user inserts data or characters into a hosted application's data entry field and the hosted application is unprepared to process that data. This results in unanticipated application behavior, potentially leading to an application compromise. Invalid user input is one of the primary methods employed when attempting to compromise an application.

An attacker can also enter Unicode characters into hosted applications in an effort to break out of the document home or root home directory or to bypass security checks.

VMware uses the standard Tomcat 'SetCharacterEncodingFilter' to provide a layer of defense against character encoding attacks. Filters are Java objects that perform filtering tasks on the request to a resource (a servlet or static content), the response from a resource, or both."
      solution    : "Open /usr/lib/vmware-perfcharts/tc-instance/conf/web.xml in a text editor.

Configure the <web-app> node with the child nodes listed below:

<filter-mapping>
    <filter-name>setCharacterEncodingFilter</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>

<filter>
    <filter-name>setCharacterEncodingFilter</filter-name>
    <filter-class>org.apache.catalina.filters.SetCharacterEncodingFilter</filter-class>
    <init-param>
      <param-name>encoding</param-name>
      <param-value>UTF-8</param-value>
    </init-param>
    <init-param>
      <param-name>ignore</param-name>
      <param-value>true</param-value>
    </init-param>
    <async-supported>true</async-supported>
</filter>"
      reference   : "800-53|SI-10,800-53r5|SI-10,CAT|II,CCI|CCI-001310,CN-L3|8.1.4.4(d),DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|SI-10,ITSG-33|SI-10a.,NESA|T7.3.1,NESA|T7.3.2,NIAv2|SS6e,Rule-ID|SV-239421r879652_rule,STIG-ID|VCPF-67-000020,Vuln-ID|V-239421"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/echo $(/usr/bin/xmllint --format /usr/lib/vmware-perfcharts/tc-instance/conf/web.xml | /usr/bin/sed 's/xmlns=\".*\"//g' | /usr/bin/xmllint --xpath '/web-app/filter-mapping/filter-name[text()=\"setCharacterEncodingFilter\"]/parent::filter-mapping' -)"
      expect      : "^[\\s]*<filter-mapping>[\\s]*<filter-name>setCharacterEncodingFilter</filter-name>[\\s]*<url-pattern>/\\*</url-pattern>[\\s]*</filter-mapping>[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000020 - Performance Charts must use the 'setCharacterEncodingFilter' filter - filter"
      info        : "Invalid user input occurs when a user inserts data or characters into a hosted application's data entry field and the hosted application is unprepared to process that data. This results in unanticipated application behavior, potentially leading to an application compromise. Invalid user input is one of the primary methods employed when attempting to compromise an application.

An attacker can also enter Unicode characters into hosted applications in an effort to break out of the document home or root home directory or to bypass security checks.

VMware uses the standard Tomcat 'SetCharacterEncodingFilter' to provide a layer of defense against character encoding attacks. Filters are Java objects that perform filtering tasks on the request to a resource (a servlet or static content), the response from a resource, or both."
      solution    : "Open /usr/lib/vmware-perfcharts/tc-instance/conf/web.xml in a text editor.

Configure the <web-app> node with the child nodes listed below:

<filter-mapping>
    <filter-name>setCharacterEncodingFilter</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>

<filter>
    <filter-name>setCharacterEncodingFilter</filter-name>
    <filter-class>org.apache.catalina.filters.SetCharacterEncodingFilter</filter-class>
    <init-param>
      <param-name>encoding</param-name>
      <param-value>UTF-8</param-value>
    </init-param>
    <init-param>
      <param-name>ignore</param-name>
      <param-value>true</param-value>
    </init-param>
    <async-supported>true</async-supported>
</filter>"
      reference   : "800-53|SI-10,800-53r5|SI-10,CAT|II,CCI|CCI-001310,CN-L3|8.1.4.4(d),DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|SI-10,ITSG-33|SI-10a.,NESA|T7.3.1,NESA|T7.3.2,NIAv2|SS6e,Rule-ID|SV-239421r879652_rule,STIG-ID|VCPF-67-000020,Vuln-ID|V-239421"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/echo $(/usr/bin/xmllint --format /usr/lib/vmware-perfcharts/tc-instance/conf/web.xml | /usr/bin/sed 's/xmlns=\".*\"//g' | /usr/bin/xmllint --xpath '/web-app/filter/filter-name[text()=\"setCharacterEncodingFilter\"]/parent::filter' -)"
      expect      : "^[\\s]*<filter>[\\s]*<filter-name>setCharacterEncodingFilter</filter-name>[\\s]*<filter-class>org.apache.catalina.filters.SetCharacterEncodingFilter</filter-class>[\\s]*<init-param>[\\s]*<param-name>encoding</param-name>[\\s]*<param-value>UTF-8</param-value>[\\s]*<param-name>ignore</param-name>[\\s]*<param-value>true</param-value>[\\s]*</init-param> <async-supported>true</async-supported>[\\s]*</filter>[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000021 - Performance Charts must set the welcome-file node to a default web page."
      info        : "Enumeration techniques, such as URL parameter manipulation, rely on being able to obtain information about the web server's directory structure by locating directories without default pages. In the scenario, the web server will display to the user a listing of the files in the directory being accessed.

By having a default hosted application web page, the anonymous web user will not obtain directory browsing information or an error message that reveals the server type and version. Ensuring that every document directory has an 'index.jsp' (or equivalent) file is one approach to mitigating the vulnerability."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/web.xml.

Add the following section under the <web-apps> node:

<welcome-file-list>
    <welcome-file>index.html</welcome-file>
    <welcome-file>index.htm</welcome-file>
    <welcome-file>index.jsp</welcome-file>
  </welcome-file-list>"
      reference   : "800-53|SI-11a.,800-53r5|SI-11a.,CAT|II,CCI|CCI-001312,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|SI-11b.,Rule-ID|SV-239422r879655_rule,STIG-ID|VCPF-67-000021,Vuln-ID|V-239422"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/echo $(/usr/bin/xmllint --format /usr/lib/vmware-perfcharts/tc-instance/conf/web.xml | /usr/bin/sed 's/xmlns=\".*\"//g' | /usr/bin/xmllint --xpath '/web-app/welcome-file-list' -)"
      expect      : "^[\\s]*<welcome-file-list>[\\s]*<welcome-file>index.html</welcome-file>[\\s]*<welcome-file>index.htm</welcome-file>[\\s]*<welcome-file>index.jsp</welcome-file>[\\s]*</welcome-file-list>[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000022 - Performance Charts must not show directory listings."
      info        : "Enumeration techniques, such as URL parameter manipulation, rely on being able to obtain information about the web server's directory structure by locating directories without default pages. In the scenario, the web server will display to the user a listing of the files in the directory being accessed. Ensuring that directory listing is disabled is one approach to mitigating the vulnerability."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/web.xml.

Set the <param-value> to 'false' in all <param-name>listing</param-name> nodes.

Note: The setting should look like the following:

<init-param>
      <param-name>listings</param-name>
      <param-value>false</param-value>
</init-param>"
      reference   : "800-53|SI-11a.,800-53r5|SI-11a.,CAT|II,CCI|CCI-001312,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|SI-11b.,Rule-ID|SV-239423r879655_rule,STIG-ID|VCPF-67-000022,Vuln-ID|V-239423"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/echo $(/usr/bin/xmllint --format /usr/lib/vmware-perfcharts/tc-instance/conf/web.xml | /usr/bin/sed 's/xmlns=\".*\"//g' | /usr/bin/xmllint --xpath '//param-name[text()=\"listings\"]/parent::init-param' -)"
      expect      : "^[\\s]*<init-param>[\\s]*<param-name>listings</param-name>[\\s]*<param-value>false</param-value>[\\s]*</init-param>[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000023 - Performance Charts must be configured to show error pages with minimal information."
      info        : "Web servers will often display error messages to client users, including enough information to aid in the debugging of the error. The information given back in error messages may display the web server type, version, patches installed, plug-ins and modules installed, type of code being used by the hosted application, and any backends being used for data storage.

This information could be used by an attacker to blueprint what type of attacks might be successful. Therefore, Performance Charts must be configured with a catch-all error handler that redirects to a standard 'error.jsp'."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/webapps/statsreport/WEB-INF/web.xml.

Add the following section under the <web-apps> node:

<error-page>
    <exception-type>java.lang.Throwable</exception-type>
    <location>/error.jsp</location>
  </error-page>"
      reference   : "800-53|SI-11a.,800-53r5|SI-11a.,CAT|II,CCI|CCI-001312,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|SI-11b.,Rule-ID|SV-239424r879655_rule,STIG-ID|VCPF-67-000023,Vuln-ID|V-239424"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/echo $(/usr/bin/xmllint --format /usr/lib/vmware-perfcharts/tc-instance/webapps/statsreport/WEB-INF/web.xml | /usr/bin/sed 's/xmlns=\".*\"//g' | /usr/bin/xmllint --xpath '/web-app/error-page/exception-type[\"text()=java.lang.Throwable\"]/parent::error-page' -)"
      expect      : "^[\\s]*<error-page>[\\s]*<exception-type>java.lang.Throwable</exception-type>[\\s]*<location>/http_error.jsp</location>[\\s]*</error-page>[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK_NOT
      description : "VCPF-67-000024 - Performance Charts must not enable support for TRACE requests."
      info        : "'Trace' is a technique for a user to request internal information about Tomcat. This is useful during product development but should not be enabled in production.

Allowing an attacker to conduct a Trace operation against Performance Charts will expose information that would be useful to perform a more targeted attack. Performance Charts provides the 'allowTrace' parameter as a way to disable responding to Trace requests."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/server.xml.

Navigate to and locate:
'allowTrace='true''

Remove the 'allowTrace='true'' setting."
      reference   : "800-53|SI-11a.,800-53r5|SI-11a.,CAT|II,CCI|CCI-001312,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|SI-11b.,Rule-ID|SV-239425r879655_rule,STIG-ID|VCPF-67-000024,Vuln-ID|V-239425"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      file        : "/usr/lib/vmware-perfcharts/tc-instance/conf/server.xml"
      regex       : "^[\\s]*allowTrace[\\s]*="
      expect      : "^[\\s]*allowTrace[\\s]*=[\\s]*[\"']?true[\"']?[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000025 - Performance Charts must have the debug option turned off."
      info        : "Information needed by an attacker to begin looking for possible vulnerabilities in a web server includes any information about the web server and plug-ins or modules being used. When debugging or trace information is enabled in a production web server, information about the web server, such as web server type, version, patches installed, plug-ins and modules installed, type of code being used by the hosted application, and any backends being used for data storage may be displayed. Because this information may be placed in logs and general messages during normal operation of the web server, an attacker does not need to cause an error condition to gain this information.

The Performance Charts Service can be configured to set the debugging level. By setting the debugging level to zero, no debugging information will be provided to a malicious user."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/web.xml.

Navigate to all <debug> nodes that are not set to '0'.

Set the <param-value> to '0' in all <param-name>debug</param-name> nodes.

Note: The debug setting should look like the following:

<init-param>
      <param-name>debug</param-name>
      <param-value>0</param-value>
    </init-param>"
      reference   : "800-53|SI-11a.,800-53r5|SI-11a.,CAT|II,CCI|CCI-001312,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|SI-11b.,Rule-ID|SV-239426r879655_rule,STIG-ID|VCPF-67-000025,Vuln-ID|V-239426"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/echo $(/usr/bin/xmllint --format /usr/lib/vmware-perfcharts/tc-instance/conf/web.xml | /usr/bin/sed 's/xmlns=\".*\"//g' | /usr/bin/xmllint --xpath '//param-name[text()=\"debug\"]/parent::init-param' -)"
      expect      : "^[\\s]*(XPath[\\s]+set[\\s]+is[\\s]+empty|<init-param>[\\s]*<param-name>debug</param-name>[\\s]*<param-value>0</param-value>[\\s]*</init-param>)[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK
      description : "VCPF-67-000026 - Performance Charts must properly configure log sizes and rotation - MaxFileSize"
      info        : "To ensure that the logging mechanism used by the web server has sufficient storage capacity in which to write the logs, the logging mechanism must be able to allocate log record storage capacity. Performance Charts properly sizes and configures log rotation during installation. This default configuration must be verified."
      solution    : "Open  /etc/vmware-perfcharts/log4j.properties with a text editor and add or change the following settings:

log4j.appender.LOGFILE.MaxFileSize=5MB
log4j.appender.LOGFILE.MaxBackupIndex=10"
      reference   : "800-53|AU-4,800-53r5|AU-4,CAT|II,CCI|CCI-001849,CSF|PR.DS-4,CSF|PR.PT-1,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ITSG-33|AU-4,NESA|T3.3.1,NESA|T3.6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,Rule-ID|SV-239427r879730_rule,STIG-ID|VCPF-67-000026,Vuln-ID|V-239427"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      file        : "/etc/vmware-perfcharts/log4j.properties"
      regex       : "^[\\s]*log4j.appender.LOGFILE.MaxFileSize[\\s]*="
      expect      : "^[\\s]*log4j.appender.LOGFILE.MaxFileSize[\\s]*=[\\s]*[\"']?5MB[\"']?[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK
      description : "VCPF-67-000026 - Performance Charts must properly configure log sizes and rotation - MaxBackupIndex"
      info        : "To ensure that the logging mechanism used by the web server has sufficient storage capacity in which to write the logs, the logging mechanism must be able to allocate log record storage capacity. Performance Charts properly sizes and configures log rotation during installation. This default configuration must be verified."
      solution    : "Open  /etc/vmware-perfcharts/log4j.properties with a text editor and add or change the following settings:

log4j.appender.LOGFILE.MaxFileSize=5MB
log4j.appender.LOGFILE.MaxBackupIndex=10"
      reference   : "800-53|AU-4,800-53r5|AU-4,CAT|II,CCI|CCI-001849,CSF|PR.DS-4,CSF|PR.PT-1,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ITSG-33|AU-4,NESA|T3.3.1,NESA|T3.6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,Rule-ID|SV-239427r879730_rule,STIG-ID|VCPF-67-000026,Vuln-ID|V-239427"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      file        : "/etc/vmware-perfcharts/log4j.properties"
      regex       : "^[\\s]*log4j.appender.LOGFILE.MaxBackupIndex[\\s]*="
      expect      : "^[\\s]*log4j.appender.LOGFILE.MaxBackupIndex[\\s]*=[\"']?10[\"']?[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000027 - Rsyslog must be configured to monitor and ship Performance Charts log files - localhost_access"
      info        : "Performance Charts produces a handful of logs that must be offloaded from the originating system. This information can then be used for diagnostic purposes, forensics purposes, or other purposes relevant to ensuring the availability and integrity of the hosted application.

Satisfies: SRG-APP-000358-WSR-000163, SRG-APP-000125-WSR-000071"
      solution    : "Navigate to and open /etc/vmware-syslog/stig-services-perfcharts.conf.

Create the file if it does not exist.

Set the contents of the file as follows:

input(type='imfile'
      File='/var/log/vmware/perfcharts/localhost_access_log.*.txt'
      Tag='perfcharts-localhost_access'
      Severity='info'
      Facility='local0')
input(type='imfile'
      File='/var/log/vmware/perfcharts/vmware-perfcharts-runtime.log.std*'
      Tag='perfcharts-runtime'
      Severity='info'
      Facility='local0')"
      reference   : "800-171|3.3.8,800-53|AU-4(1),800-53|AU-9(2),800-53r5|AU-4(1),800-53r5|AU-9(2),CAT|II,CCI|CCI-001348,CCI|CCI-001851,CN-L3|8.1.3.5(d),CN-L3|8.1.4.3(c),CSF|PR.DS-4,CSF|PR.PT-1,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO/IEC-27001|A.12.4.2,ITSG-33|AU-4,ITSG-33|AU-9(2),NESA|M5.2.3,NESA|M5.5.2,NESA|T3.3.1,NESA|T3.6.2,NIAv2|SS13e,PCI-DSSv3.2.1|10.5.3,PCI-DSSv3.2.1|10.5.4,PCI-DSSv4.0|10.3.3,QCSC-v1|8.2.1,QCSC-v1|13.2,Rule-ID|SV-239428r879731_rule,STIG-ID|VCPF-67-000027,Vuln-ID|V-239428"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/echo $(/usr/bin/cat /etc/vmware-syslog/stig-services-perfcharts.conf)"
      expect      : "input\\(type=\"imfile\" File=\"/var/log/vmware/perfcharts/localhost_access_log.\\*.txt\" Tag=\"perfcharts-localhost_access\" Severity=\"info\" Facility=\"local0\"\\)"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000027 - Rsyslog must be configured to monitor and ship Performance Charts log files - runtime"
      info        : "Performance Charts produces a handful of logs that must be offloaded from the originating system. This information can then be used for diagnostic purposes, forensics purposes, or other purposes relevant to ensuring the availability and integrity of the hosted application.

Satisfies: SRG-APP-000358-WSR-000163, SRG-APP-000125-WSR-000071"
      solution    : "Navigate to and open /etc/vmware-syslog/stig-services-perfcharts.conf.

Create the file if it does not exist.

Set the contents of the file as follows:

input(type='imfile'
      File='/var/log/vmware/perfcharts/localhost_access_log.*.txt'
      Tag='perfcharts-localhost_access'
      Severity='info'
      Facility='local0')
input(type='imfile'
      File='/var/log/vmware/perfcharts/vmware-perfcharts-runtime.log.std*'
      Tag='perfcharts-runtime'
      Severity='info'
      Facility='local0')"
      reference   : "800-171|3.3.8,800-53|AU-4(1),800-53|AU-9(2),800-53r5|AU-4(1),800-53r5|AU-9(2),CAT|II,CCI|CCI-001348,CCI|CCI-001851,CN-L3|8.1.3.5(d),CN-L3|8.1.4.3(c),CSF|PR.DS-4,CSF|PR.PT-1,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO/IEC-27001|A.12.4.2,ITSG-33|AU-4,ITSG-33|AU-9(2),NESA|M5.2.3,NESA|M5.5.2,NESA|T3.3.1,NESA|T3.6.2,NIAv2|SS13e,PCI-DSSv3.2.1|10.5.3,PCI-DSSv3.2.1|10.5.4,PCI-DSSv4.0|10.3.3,QCSC-v1|8.2.1,QCSC-v1|13.2,Rule-ID|SV-239428r879731_rule,STIG-ID|VCPF-67-000027,Vuln-ID|V-239428"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/echo $(/usr/bin/cat /etc/vmware-syslog/stig-services-perfcharts.conf)"
      expect      : "input\\(type=\"imfile\" File=\"/var/log/vmware/perfcharts/vmware-perfcharts-runtime.log.std\\*\" Tag=\"perfcharts-runtime\" Severity=\"info\" Facility=\"local0\"\\)"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK
      description : "VCPF-67-000028 - Performance Charts must be configured with the appropriate ports - http"
      info        : "Web servers provide numerous processes, features, and functionalities that use TCP/IP ports. Some of these processes may be deemed unnecessary or too unsecure to run on a production system. The ports that the Performance Charts listens on are configured in the 'catalina.properties' file and must be verified as accurate to their shipping state."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/catalina.properties.

Navigate to the ports specification section.

Add or modify the following lines:

bio.http.port=13080
bio.https.port=8443"
      reference   : "800-171|3.4.7,800-53|CM-7(1)(b),800-53r5|CM-7(1)(b),CAT|II,CCI|CCI-001762,CSF|PR.IP-1,CSF|PR.PT-3,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|CM-7(1),NIAv2|SS15a,PCI-DSSv3.2.1|2.2.2,QCSC-v1|3.2,Rule-ID|SV-239429r879756_rule,STIG-ID|VCPF-67-000028,SWIFT-CSCv1|2.3,Vuln-ID|V-239429"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      file        : "/usr/lib/vmware-perfcharts/tc-instance/conf/catalina.properties"
      regex       : "^[\\s]*bio.http.port[\\s]*="
      expect      : "^[\\s]*bio.http.port[\\s]*=[\\s]*13080[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK
      description : "VCPF-67-000028 - Performance Charts must be configured with the appropriate ports - https"
      info        : "Web servers provide numerous processes, features, and functionalities that use TCP/IP ports. Some of these processes may be deemed unnecessary or too unsecure to run on a production system. The ports that the Performance Charts listens on are configured in the 'catalina.properties' file and must be verified as accurate to their shipping state."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/conf/catalina.properties.

Navigate to the ports specification section.

Add or modify the following lines:

bio.http.port=13080
bio.https.port=8443"
      reference   : "800-171|3.4.7,800-53|CM-7(1)(b),800-53r5|CM-7(1)(b),CAT|II,CCI|CCI-001762,CSF|PR.IP-1,CSF|PR.PT-3,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|CM-7(1),NIAv2|SS15a,PCI-DSSv3.2.1|2.2.2,QCSC-v1|3.2,Rule-ID|SV-239429r879756_rule,STIG-ID|VCPF-67-000028,SWIFT-CSCv1|2.3,Vuln-ID|V-239429"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      file        : "/usr/lib/vmware-perfcharts/tc-instance/conf/catalina.properties"
      regex       : "^[\\s]*bio.https.port[\\s]*="
      expect      : "^[\\s]*bio.https.port[\\s]*=[\\s]*8443[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK
      description : "VCPF-67-000029 - Performance Charts must disable the shutdown port."
      info        : "An attacker has at least two reasons to stop a web server. The first is to cause a denial of service, and the second is to put in place changes the attacker made to the web server configuration.

If the Tomcat shutdown port feature is enabled, a shutdown signal can be sent to Performance Chart through this port. To ensure availability, the shutdown port must be disabled."
      solution    : "Navigate to and open /etc/vmware-eam/catalina.properties.

Navigate to the ports specification section.

Add or modify the following line:

base.shutdown.port=-1"
      reference   : "800-53|SC-5,800-53r5|SC-5,CAT|II,CCI|CCI-002385,CSF|DE.CM-1,CSF|PR.DS-4,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|SC-5,ITSG-33|SC-5a.,NESA|T3.3.1,NIAv2|GS8e,NIAv2|GS10c,QCSC-v1|8.2.1,Rule-ID|SV-239430r879806_rule,STIG-ID|VCPF-67-000029,Vuln-ID|V-239430"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      file        : "/usr/lib/vmware-perfcharts/tc-instance/conf/catalina.properties"
      regex       : "^[\\s]*base.shutdown.port[\\s]*="
      expect      : "^[\\s]*base.shutdown.port[\\s]*=[\\s]*-1[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000030 - Performance Charts must set the secure flag for cookies."
      info        : "The secure flag is an option that can be set by the application server when sending a new cookie to the user within an HTTP Response. The purpose of the secure flag is to prevent cookies from being observed by unauthorized parties due to the transmission of the cookie in clear text.

By setting the secure flag, the browser will prevent the transmission of a cookie over an unencrypted channel. Performance Charts is configured to only be accessible over a TLS tunnel, but this cookie flag is still a recommended best practice."
      solution    : "Navigate to and open /usr/lib/vmware-perfcharts/tc-instance/webapps/statsreport/WEB-INF/web.xml.

Navigate to the <session-config> node and configure it as follows:

<session-config>
    <cookie-config>
      <http-only>true</http-only>
      <secure>true</secure>
    </cookie-config>
    <session-timeout>6</session-timeout>
  </session-config>"
      reference   : "800-171|3.13.8,800-53|SC-8,800-53r5|SC-8,CAT|II,CCI|CCI-002418,CN-L3|8.1.2.2(a),CN-L3|8.1.2.2(b),CN-L3|8.1.4.7(a),CN-L3|8.1.4.8(a),CN-L3|8.2.4.5(c),CN-L3|8.2.4.5(d),CN-L3|8.5.2.2,CSF|PR.DS-2,CSF|PR.DS-5,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(e)(1),HIPAA|164.312(e)(2)(i),ITSG-33|SC-8,ITSG-33|SC-8a.,NESA|T4.3.1,NESA|T4.3.2,NESA|T4.5.1,NESA|T4.5.2,NESA|T7.3.3,NESA|T7.4.1,NIAv2|IE8,NIAv2|IE9,NIAv2|IE12,NIAv2|NS29,NIAv2|SS24,PCI-DSSv3.2.1|2.3,PCI-DSSv3.2.1|4.1,PCI-DSSv4.0|2.2.7,PCI-DSSv4.0|4.2.1,QCSC-v1|5.2.2,QCSC-v1|6.2,Rule-ID|SV-239431r879810_rule,STIG-ID|VCPF-67-000030,Vuln-ID|V-239431"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/echo $(/usr/bin/xmllint --format /usr/lib/vmware-perfcharts/tc-instance/webapps/statsreport/WEB-INF/web.xml | /usr/bin/sed 's/xmlns=\".*\"//g' | /usr/bin/xmllint --xpath '/web-app/session-config/cookie-config/secure' -)"
      expect      : "^[\\s]*<secure>true</secure>[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "VCPF-67-000031 - Performance Charts must be configured to limit access to internal packages."
      info        : "The 'package.access' entry in the 'catalina.properties' file implements access control at the package level. When this is properly configured, a Security Exception will be reported if an errant or malicious web app attempts to access the listed internal classes directly or if a new class is defined under the protected packages. Performance Charts comes preconfigured with the appropriate packages defined in 'package.access', and this configuration must be maintained."
      solution    : "Navigate to and open /usr/lib/vmware-sso/vmware-sts/conf/catalina.properties and ensure that the 'package.access' line is configured as follows:

package.access = \
sun.,\
org.apache.catalina.,\
org.apache.coyote.,\
org.apache.jasper.,\
org.apache.naming.resources.,\
org.apache.tomcat."
      reference   : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7a.,800-53r5|CM-7a.,CAT|II,CCI|CCI-000381,CN-L3|7.1.3.5(c),CN-L3|8.1.4.4(a),CSF|PR.IP-1,CSF|PR.PT-3,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|CM-7a.,NIAv2|SS15a,PCI-DSSv3.2.1|2.2.1,PCI-DSSv4.0|2.2.3,QCSC-v1|3.2,Rule-ID|SV-239432r879587_rule,STIG-ID|VCPF-67-000031,SWIFT-CSCv1|2.3,Vuln-ID|V-239432"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
      cmd         : "/usr/bin/echo $(/usr/bin/grep 'package.access' -A 6 /usr/lib/vmware-perfcharts/tc-instance/conf/catalina.properties)"
      expect      : "^[\\s]*package.access[\\s]*=[\\s]\\\\[\\s]+sun.,\\\\[\\s]+org.apache.catalina.,\\\\[\\s]+org.apache.coyote.,\\\\[\\s]+org.apache.jasper.,\\\\[\\s]+org.apache.naming.resources.,\\\\[\\s]+org.apache.tomcat.[\\s]*$"
    </custom_item>

    <report type:"WARNING">
      description : "VCPF-67-000999 - The version of Perfcharts running on the system must be a supported version."
      info        : "Security flaws with software applications are discovered daily. Vendors are constantly updating and patching their products to address newly discovered security vulnerabilities. Organizations (including any contractor to the organization) are required to promptly install security-relevant software updates (e.g., patches, service packs, and hot fixes). Flaws discovered during security assessments, continuous monitoring, incident response activities, or information system error handling must also be addressed expeditiously.

Organization-defined time periods for updating security-relevant software may vary based on a variety of factors including, for example, the security category of the information system or the criticality of the update (i.e., severity of the vulnerability related to the discovered flaw).

This requirement will apply to software patch management solutions that are used to install patches across the enclave and to applications that are not part of that patch management solution. For example, many browsers today provide the capability to install their own patch software. Patch criticality, as well as system criticality, will vary. Therefore, the tactical situations regarding the patch management process will also vary. This means the time period used must be a configurable parameter. Time frames for application of security-relevant software updates may be dependent upon the Information Assurance Vulnerability Management (IAVM) process.

The application will be configured to check for and install security-relevant software updates within an identified time period from the availability of the update. The specific time period will be defined by an authoritative source (e.g., IAVM, CTOs, DTMs, and STIGs).

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "Upgrade to a supported version."
      reference   : "800-171|3.14.1,800-53|SI-2c.,800-53r5|SI-2c.,CAT|I,CCI|CCI-002605,CN-L3|8.1.4.4(e),CN-L3|8.1.10.5(a),CN-L3|8.1.10.5(b),CN-L3|8.5.4.1(b),CN-L3|8.5.4.1(d),CN-L3|8.5.4.1(e),CSF|ID.RA-1,CSF|PR.IP-12,DISA_Benchmark|VMW_vSphere_6-7_Perfcharts_Tomcat_STIG,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|SI-2,NESA|T7.6.2,NESA|T7.7.1,NIAv2|AM38,NIAv2|AM39,NIAv2|SS14b,PCI-DSSv3.2.1|6.2,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.3,QCSC-v1|11.2,Rule-ID|SV-257279r919198_rule,STIG-ID|VCPF-67-000999,SWIFT-CSCv1|2.2,Vuln-ID|V-257279"
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
    </report>
  </then>

  <else>
    <report type:"WARNING">
      description : "DISA_STIG_VMware_vSphere_6.7_Perfcharts_Tomcat_v1r3.audit from DISA VMware vSphere 6.7 Perfcharts Tomcat v1r3 STIG"
      info        : "NOTE: Nessus has not identified that the chosen audit applies to the target device."
      see_also    : "https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_VMW_vSphere_6-7_Y23M07_STIG.zip"
    </report>
  </else>
</if>

</check_type>
