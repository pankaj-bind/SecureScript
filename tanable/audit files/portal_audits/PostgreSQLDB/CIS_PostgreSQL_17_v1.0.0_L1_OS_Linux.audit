#TRUSTED 956571806ea78831f4b5aa1412f078d9e06efb3730933434dc0768bdb6689ccf76b8dac329437eb26146c986f26686d231e57da8df75f5f6488d74ee88e83a2a2da3682e57c80401a590b5577c14265db050bc2407170dd707875ed90269dbb920ede9ec7aa68ea62d358611a7cfa550b0aa7a1160007eaca5fba777bf7e3c8da309607490c35ba9ee9381767a9678ed899ee075b9720051adaea02888a048a839daf448017ecdf266ccb770c23dedb67e0224b774de593c7333d1c4de786dd3da65a3c3f8068014088ead68c2c3bdcfe97f72ff8c3818c35e74214634359662d8ae090950238a586e4c49378e8cb0fc9a680c058c41438959689de2a671d23682b0b9dcfa4d653b68edca9e1415d527da3829ff97808730df88a86471b1d884a87f7b7ac0b7e3d998c93813315e31df90bd90812306c8c02ea9ae8d00f9049468f1c7c3f2e2b7dc9fafae50d694ec7a43c3c6bce50a34067d125451c0925861c9171d394b8adadde7651c1cd06f305aa9373ce530c43520a960d66f5b1480c3321e354bb0d4b1aaefeb794c545978992d880b6687ed73751d55728ea688a752712742af16891bca22b7aaf57531c9b40bb4fa0ffe4a3da04d23209fc59fcaab308edc1618fa60cba878b0bbee0774911b87ad4b1573fb1fa0813b35b68305375b3e31b81f8119ba4630f3c8747920f08d57c56b45ee6985d75f9754b1ac4347
#TRUST-RSA-SHA256 32c6005e1ef77002268e69fe78d1ad32c41e64ea709a0cf64a8e0b9391ee81aa663b6dca97453f18797de0788597ba95f72457867b2ca85f55badbc55d17444bc4dc61753656a25ee006ef6f28194266e179fc4d8854d8e276d55f46836fa53d0dd0f42b9c4d358eb8ede2bb2c3e8885b8d5d1a6f39c99814a416582c41e38c64bcbf5c6beca85fb1b61573918816b7e625a2d3556c8e92e8a6ff0e44d4aa8e11f1c94e2885c9d5a3d85f9783b83c39b1200fcac53d02dc6006467ef98f174817257094ac0c03416d7cfc871f350cb61f89be2a20ecc59c68bad47565d94756786fada6cfd528c3eb7d265909468fb45f2b473980a20678ef0f7416a54c89217c78a64b2a52ba76f8e8aeee3ab9261107f9c2da8362e2ff35d2c6447d5ad455ae1ae14b5b442973f95a9cd5090312fd93304cebffa38342889c69e7cf5f1584fc549a7d6c84abb112a1eab53bc80c4f95bc5ed2a0fdd69d4485b708d0477a3ce3711d1e4bcd63d8ce58c90fa7ea4772806aea85376f66afb8c19f2bed23a7cb7d4f17db85524c7800bc736b69e3b606cc4f607efdde162fffbfb9268fcc96504905914ec527f9d17065d4ca6c5ec90a8effb2024b071544b6471717b395327a24ff4a6ddfdc8c58aa4eaf2b6208edc5a31ebfeac7839148189a901e7c1045bbbd4af4b57cdad9e6c1da766e366dc7633d79b42c6e28b486ac4349dea29b681f4
#
# This script is Copyright (C) 2004-2025 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This script is released under the Tenable Subscription License and
# may not be used from within scripts released under another license
# without authorization from Tenable, Inc.
#
# See the following licenses for details:
#
# http://static.tenable.com/prod_docs/Nessus_6_SLA_and_Subscription_Agreement.pdf
#
# @PROFESSIONALFEED@
# $Revision: 1.0 $
# $Date: 2025/05/13 $
#
# description : This .audit is designed against the CIS PostgreSQL 17 Benchmark v1.0.0
#
#<ui_metadata>
#<display_name>CIS PostgreSQL 17 v1.0.0 L1 PostgreSQL</display_name>
#<spec>
#  <type>CIS</type>
#  <name>PostgreSQL 17</name>
#  <profile>L1 OS Linux</profile>
#  <version>1.0.0</version>
#  <link>https://workbench.cisecurity.org/benchmarks/19478</link>
#</spec>
#<labels>cis,distribution_independent_linux,postgres,postgresql_17</labels>
#<benchmark_refs>CSCv6,CSCv7,CSCv8,LEVEL</benchmark_refs>
#<variables>
#  <variable>
#    <name>PLATFORM_CHECK</name>
#    <default>/var/run/postgresql</default>
#    <description>Platform Check</description>
#    <info>Check if this file exists to determine if PostgreSQL is installed.</info>
#    <value_type>UNIX_FILE_PATH</value_type>
#  </variable>
#  <variable>
#    <name>PG_HOME_DIR</name>
#    <default>/var/lib/pgsql/17</default>
#    <description>pgsql home dir</description>
#    <info>full path to home dir</info>
#    <value_type>UNIX_FILE_PATH</value_type>
#  </variable>
#  <variable>
#    <name>PG_EXT_DIR</name>
#    <default>/usr/pgsql-17/share/extension</default>
#    <description>postgres extension directory</description>
#    <info>the directory in which postgres17 keeps extensions</info>
#    <value_type>UNIX_FILE_PATH</value_type>
#  </variable>
#  <variable>
#    <name>POSTGRES_CONFIG_PATH</name>
#    <default>/var/lib/pgsql/17/data/postgresql.conf</default>
#    <description>Postgres 17 Config File Path</description>
#    <info>The full path to postgresql.conf.</info>
#    <value_type>UNIX_FILE_PATH</value_type>
#  </variable>
#</variables>
#</ui_metadata>

<check_type:"Unix">

<if>
  <condition type:"AND">
    <custom_item>
      type        : FILE_CHECK
      description : "PostgreSQL exists"
      file        : "@PLATFORM_CHECK@"
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "Linux found"
      cmd         : "uname -a"
      expect      : "Linux"
    </custom_item>
  </condition>

  <then>
    <report type:"PASSED">
      description : "CIS_PostgreSQL_17_v1.0.0_L1_OS_Linux.audit from CIS PostgreSQL 17 Benchmark v1.0.0"
      see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
      show_output : YES
    </report>

    <custom_item>
      type        : CMD_EXEC
      description : "1.1 Ensure packages are obtained from authorized repositories"
      info        : "Standard Linux distributions, although possessing the requisite packages, often do not have PostgreSQL pre-installed. The installation process includes installing the binaries and the means to generate a data cluster. Package installation should include both the server and client packages. Contribution modules are optional depending upon one's architectural requirements (they are recommended though).

When obtaining and installing software packages (typically via dnf or apt ), it's imperative that packages are sourced only from valid and authorized repositories. For PostgreSQL, the canonical repositories are the official PostgreSQL YUM repository (yum.postgresql.org) and the official PostgreSQL APT repository (apt.postgresql.org). Your chosen PostgreSQL vendor may offer its own software repositories as well.

Being open-source, PostgreSQL packages are widely available across the internet through package aggregators and providers. However, using invalid or unauthorized sources for packages can lead to implementing untested, defective, or malicious software.

Many organizations choose to implement a local software repository within their organization. Care must be taken to ensure that only valid and authorized packages are downloaded and installed into such local repositories.

From a security perspective, it's imperative to verify the PostgreSQL binary packages are sourced from a valid software repository. For a complete listing of all PostgreSQL binaries available via configured repositories inspect the output from dnf provides '*libpq.so' or apt-file search /usr/pgsql-1*/lib/libpq.so.5

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
      solution    : "Alter the configured repositories so they only include valid and authorized sources of packages.

As an example of adding an authorized repository, we will install the PGDG repository RPM from '

yum.postgresql.org

':

# whoami
root
# dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm
Last metadata expiration check: 0:01:35 ago on Mon 03 Oct 2022 01:19:37 PM EDT.
[snip]
Installed:
  pgdg-redhat-repo-42.0-46.noarch

Complete!
# whoami
root
# dnf repolist all | egrep 'enabled$'
pgdg-common PostgreSQ enabled
pgdg12 PostgreSQ enabled
pgdg13 PostgreSQ enabled
pgdg14 PostgreSQ enabled
pgdg15 PostgreSQ enabled
pgdg16 PostgreSQ enabled
pgdg17 PostgreSQ enabled
rhel-9-for-x86_64-appstream-rpms Red Hat E enabled
rhel-9-for-x86_64-baseos-rpms Red Hat E enabled

If the version of PostgreSQL installed is not 1*.x or they did not come from a valid repository, the packages may be uninstalled using this command:

# whoami
root
# dnf remove $(rpm -qa|grep postgres)

To install the PGDG RPMs for PostgreSQL 1*.x, run:

# whoami
root
# dnf install -y postgresql17-{server,contrib}
<snip>
Installed:
<snip>
  postgresql17-17.0-1PGDG.rhel9.x86_64 postgresql17-contrib-17.0-1PGDG.rhel9.x86_64
  postgresql17-libs-17.0-1PGDG.rhel9.x86_64 postgresql17-server-17.0-1PGDG.rhel9.x86_64
Complete!"
      reference   : "800-171|3.4.1,800-171|3.4.7,800-171|3.7.1,800-171|3.7.2,800-171r3|03.04.06,800-171r3|03.04.10,800-171r3|03.07.04,800-53|CM-7(1),800-53|CM-8,800-53|MA-3,800-53r5|CM-7(1),800-53r5|CM-8,800-53r5|MA-3,CN-L3|8.1.10.2(a),CN-L3|8.1.10.2(b),CSCv7|2.1,CSCv8|2.1,CSF|DE.CM-7,CSF|ID.AM-1,CSF|ID.AM-2,CSF|PR.DS-3,CSF|PR.IP-1,CSF|PR.MA-1,CSF|PR.PT-3,CSF2.0|ID.AM-01,CSF2.0|ID.AM-02,CSF2.0|PR.PS-01,GDPR|32.1.b,HIPAA|164.306(a)(1),ISO-27001-2022|A.5.9,ISO-27001-2022|A.8.9,ITSG-33|CM-7(1),ITSG-33|CM-8,ITSG-33|MA-3,ITSG-33|MA-3a.,LEVEL|1M,NESA|T1.2.1,NESA|T1.2.2,NESA|T2.3.4,NESA|T5.4.4,NIAv2|SS15a,PCI-DSSv3.2.1|2.2.2,QCSC-v1|3.2,QCSC-v1|5.2.3,SWIFT-CSCv1|2.3"
      see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
      cmd         : "dnf repolist all | grep -E 'enabled$'"
      expect      : "^Manual Review Required$"
      severity    : MEDIUM
    </custom_item>

    <if>
      <condition auto:"WARNING" type:"OR">
        <custom_item>
          type        : CMD_EXEC
          description : "check rpm"
          cmd         : "dnf list installed \"postgres*\""
          expect      : "^Manual Review Required$"
          severity    : MEDIUM
        </custom_item>

        <custom_item>
          type        : CMD_EXEC
          description : "check deb"
          cmd         : "apt list --installed \"postgres*\""
          expect      : "^Manual Review Required$"
          severity    : MEDIUM
        </custom_item>
      </condition>

      <then>
        <report type:"PASSED">
          description : "1.2 Install only required packages"
          info        : "Depending on the distribution, several other packages next to the mandatory postgresql might have been installed upon a system.Typical add-on packages are:

 - postgresql-doc : PostgreSQL documentation.
 - phppgadmin : PostgreSQL web-based administration tool.
 - ...

Unused packages can increase the potential attack surface of the system.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
          solution    : "Examine the installed packages:

Debian:

dpkg -l $(apt-cache search postgresql --names-only| awk '{print $1}') 2>&1 | grep -v 'no packages found'

RHEL:

rpm -q $(dnf search postgresql | cut -d: -f1 | cut -d. -f1) 2>&1 | grep -Ev 'package.*is not installed'

Remove any identified packages that are undesired:

Debian:

apt purge <pkg>

RHEL:

dnf erase <pkg>"
          reference   : "800-171|3.4.2,800-171|3.4.6,800-171|3.4.7,800-171r3|03.04.02,800-171r3|03.04.06,800-53|CM-6,800-53|CM-7,800-53r5|CM-6,800-53r5|CM-7,CSCv8|4.8,CSF|PR.IP-1,CSF|PR.PT-3,CSF2.0|DE.CM-09,CSF2.0|PR.PS-01,GDPR|32.1.b,HIPAA|164.306(a)(1),ISO-27001-2022|A.8.9,ITSG-33|CM-6,ITSG-33|CM-7,LEVEL|1M,NIAv2|SS15a,PCI-DSSv3.2.1|2.2.2,SWIFT-CSCv1|2.3"
          see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
          show_output : YES
        </report>
      </then>
    </if>

    <custom_item>
      type        : CMD_EXEC
      description : "1.3 Ensure systemd Service Files Are Enabled"
      info        : "Confirm, and correct if necessary, the PostgreSQL systemd service is enabled.

Enabling the systemd service on the OS ensures the database service is active when a change of state occurs as in the case of a system startup or reboot."
      solution    : "Irrespective of package source, PostgreSQL services can be identified because it typically includes the text string \"postgresql\". PGDG installs do not automatically register the service as a \"want\" of the default systemd target. Multiple instances of PostgreSQL services often distinguish themselves using a version number.

# whoami
root
# systemctl enable postgresql-17
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql-17.service -> /usr/lib/systemd/system/postgresql-17.service.
# systemctl is-enabled postgresql-17.service
enabled"
      reference   : "800-171|3.4.1,800-171|3.4.2,800-171|3.4.6,800-171|3.4.7,800-171|3.13.1,800-171|3.13.2,800-171r3|03.04.01,800-171r3|03.04.02,800-171r3|03.04.06,800-171r3|03.16.01,800-53|CM-2,800-53|CM-6,800-53|CM-7,800-53|CM-7(1),800-53|CM-9,800-53|SA-3,800-53|SA-8,800-53|SA-10,800-53r5|CM-1,800-53r5|CM-2,800-53r5|CM-6,800-53r5|CM-7,800-53r5|CM-7(1),800-53r5|CM-9,800-53r5|SA-3,800-53r5|SA-8,800-53r5|SA-10,CSCv7|5.1,CSCv8|4.1,CSF|DE.AE-1,CSF|PR.DS-7,CSF|PR.IP-1,CSF|PR.IP-2,CSF|PR.IP-3,CSF|PR.PT-3,CSF2.0|DE.CM-09,CSF2.0|ID.AM-08,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-09,CSF2.0|PR.DS-10,CSF2.0|PR.IR-03,CSF2.0|PR.PS-01,CSF2.0|PR.PS-06,GDPR|32.1.b,HIPAA|164.306(a)(1),ISO-27001-2022|A.5.2,ISO-27001-2022|A.5.8,ISO-27001-2022|A.8.9,ISO-27001-2022|A.8.25,ISO-27001-2022|A.8.26,ISO-27001-2022|A.8.27,ISO-27001-2022|A.8.28,ISO-27001-2022|A.8.30,ISO-27001-2022|A.8.31,ISO-27001-2022|A.8.32,ITSG-33|CM-2,ITSG-33|CM-6,ITSG-33|CM-7,ITSG-33|CM-7(1),ITSG-33|CM-9,ITSG-33|SA-3,ITSG-33|SA-8,ITSG-33|SA-8a.,ITSG-33|SA-10,LEVEL|1A,NESA|T1.2.1,NESA|T1.2.2,NESA|T3.2.5,NESA|T3.4.1,NESA|T4.5.3,NESA|T4.5.4,NESA|T7.2.1,NESA|T7.5.1,NESA|T7.5.3,NESA|T7.6.1,NESA|T7.6.2,NESA|T7.6.3,NESA|T7.6.5,NIAv2|SS3,NIAv2|SS15a,NIAv2|SS16,NIAv2|VL2,PCI-DSSv3.2.1|2.2.2,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,SWIFT-CSCv1|2.3"
      see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
      cmd         : "systemctl is-enabled postgresql-14.service"
      expect      : "^[\\s]*enabled[\\s]*$"
    </custom_item>

    <if>
      <condition auto:"FAILED" type:"AND">
        <custom_item>
          type        : FILE_CHECK
          description : "check home dir permissions"
          file        : "@PG_HOME_DIR@"
          mask        : "077"
        </custom_item>

        <custom_item>
          type        : FILE_CHECK
          description : "check data dir permissions"
          file        : "@PG_HOME_DIR@/data"
          mask        : "077"
        </custom_item>

        <custom_item>
          type        : FILE_CHECK
          description : "check backups dir permissions"
          file        : "@PG_HOME_DIR@/backups"
          mask        : "077"
        </custom_item>

        <custom_item>
          type        : CMD_EXEC
          description : "check db dir"
          cmd         : "/usr/pgsql-17/bin/postgresql-17-check-db-dir ~postgres/17/data | /bin/awk '{print} END {if (NR == 0) print \"pass\" ; else print \"fail\"}'"
          expect      : "^pass$"
        </custom_item>
      </condition>

      <then>
        <report type:"PASSED">
          description : "1.4 Ensure Data Cluster Initialized Successfully"
          info        : "First-time installs of a given PostgreSQL major release require the instantiation of the database cluster. A database cluster is a collection of databases that are managed by a single server instance.

For the purposes of security, PostgreSQL enforces ownership and permissions of the data cluster such that:

 - An initialized data cluster is owned by the UNIX account that created it.
 - The data cluster cannot be accessed by other UNIX user accounts.
 - The data cluster cannot be created or owned by root
 - The PostgreSQL process cannot be invoked by root nor any UNIX user account other than the owner of the data cluster.

Incorrectly instantiating the data cluster will result in a failed installation."
          solution    : "Attempting to instantiate a data cluster to an existing non-empty directory will fail:

# whoami
root
# PGSETUP_INITDB_OPTIONS=\"-k\" /usr/pgsql-17/bin/postgresql-17-setup initdb
Data directory is not empty!

In the case of a cluster instantiation failure, one must delete/remove the entire data cluster directory and repeat the initdb command:

# whoami
root
# rm -rf ~postgres/17
# PGSETUP_INITDB_OPTIONS=\"-k\" /usr/pgsql-17/bin/postgresql-17-setup initdb
Initializing database ... OK"
          reference   : "800-171|3.1.1,800-171|3.1.4,800-171|3.1.5,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-171r3|03.01.02,800-171r3|03.01.04,800-171r3|03.01.05a.,800-171r3|03.08.02,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|MP-2,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|MP-2,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|3.3,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-2,CSF|PR.PT-3,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO-27001-2022|A.5.3,ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.33,ISO-27001-2022|A.7.7,ISO-27001-2022|A.7.10,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|MP-2,ITSG-33|MP-2a.,LEVEL|1A,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|SS13c,NIAv2|SS15c,NIAv2|SS29,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
          see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
          show_output : YES
        </report>
      </then>
    </if>

    <if>
      <condition auto:"FAILED" type:"AND">
        <custom_item>
          type        : FILE_CONTENT_CHECK_NOT
          description : "check user homes"
          file        : "~/.bashrc ~/.bash_profile ~/.profile"
          regex       : "^[\\s]*PGPASSWORD=.*$"
          expect      : "^[\\s]*PGPASSWORD=.*$"
        </custom_item>

        <custom_item>
          type        : FILE_CONTENT_CHECK_NOT
          description : "check /etc/environment"
          file        : "/etc/environment"
          regex       : "^[\\s]*PGPASSWORD=.*$"
          expect      : "^[\\s]*PGPASSWORD=.*$"
        </custom_item>
      </condition>

      <then>
        <report type:"PASSED">
          description : "1.6 Verify That 'PGPASSWORD' is Not Set in Users' Profiles"
          info        : "PostgreSQL can read a default database password from an environment variable called PGPASSWORD

Use of the PGPASSWORD environment variable implies PostgreSQL credentials are stored as clear text. Avoiding this may increase assurance that the confidentiality of PostgreSQL credentials is preserved."
          solution    : "Check which users and/or scripts are setting PGPASSWORD and change them to use a more secure authentication method."
          reference   : "800-171|3.5.2,800-171|3.13.16,800-171r3|03.05.07,800-171r3|03.13.08,800-53|IA-5(1),800-53|SC-28,800-53|SC-28(1),800-53r5|IA-5(1),800-53r5|SC-28,800-53r5|SC-28(1),CN-L3|8.1.4.7(b),CN-L3|8.1.4.8(b),CSCv8|3.11,CSF|PR.AC-1,CSF|PR.DS-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.DS-01,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(d),HIPAA|164.312(e)(2)(ii),ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.17,ISO-27001-2022|A.5.33,ITSG-33|IA-5(1),ITSG-33|SC-28,ITSG-33|SC-28a.,ITSG-33|SC-28(1),LEVEL|1A,NESA|T5.2.3,PCI-DSSv3.2.1|3.4,PCI-DSSv4.0|3.3.2,PCI-DSSv4.0|3.5.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|4.1,TBA-FIISB|28.1"
          see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
          show_output : YES
        </report>
      </then>
    </if>

    <custom_item>
      type        : CMD_EXEC
      description : "1.7 Verify That the 'PGPASSWORD' Environment Variable is Not in Use"
      info        : "PostgreSQL can read a default database password from an environment variablecalled PGPASSWORD

Using the PGPASSWORD environment variable implies PostgreSQL credentials are stored as clear text.Avoiding use of this environment variable can better safeguard the confidentiality of PostgreSQL credentials."
      solution    : "Check which users and/or scripts are setting PGPASSWORD and change themto use a more secure method."
      reference   : "800-171|3.5.2,800-171|3.13.16,800-171r3|03.05.07,800-171r3|03.13.08,800-53|IA-5(1),800-53|SC-28,800-53|SC-28(1),800-53r5|IA-5(1),800-53r5|SC-28,800-53r5|SC-28(1),CN-L3|8.1.4.7(b),CN-L3|8.1.4.8(b),CSCv8|3.11,CSF|PR.AC-1,CSF|PR.DS-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.DS-01,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(d),HIPAA|164.312(e)(2)(ii),ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.17,ISO-27001-2022|A.5.33,ITSG-33|IA-5(1),ITSG-33|SC-28,ITSG-33|SC-28a.,ITSG-33|SC-28(1),LEVEL|1A,NESA|T5.2.3,PCI-DSSv3.2.1|3.4,PCI-DSSv4.0|3.3.2,PCI-DSSv4.0|3.5.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|4.1,TBA-FIISB|28.1"
      see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
      cmd         : "grep PGPASSWORD /proc/*/environ 2>&1 | awk '{print} END {if (NR == 0) print \"pass\" ; else print \"fail\"}'"
      expect      : "^pass$"
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "2.1 Ensure the file permissions mask is correct"
      info        : "Files are always created using a default set of permissions. File permissions can be restricted by applying a permissions mask called the umask The postgres user account should use a umask of 0077 to deny file access to all user accounts except the owner.

The Linux OS defaults the umask to 0022 which means the owner and primary group can read and write the file, and other accounts are permitted to read the file. Not explicitly setting the umask to a value as restrictive as 0077 allows other users to read, write, or even execute files and scripts created by the postgres user account. The alternative to using a umask is explicitly updating file permissions after file creation using the command line utility chmod (a manual and error-prone process that is not advised)."
      solution    : "Depending upon the postgres user's environment, the umask is typically set in the initialization filebash_profile but may also be set inprofile orbashrc To set the umask, add the following to the appropriate profile file:

# whoami
postgres
# cd ~
# ls -ld .{bash_profile,profile,bashrc}
ls: cannot access .profile: No such file or directory
ls: cannot access .bashrc: No such file or directory
-rwx------. 1 postgres postgres 267 Aug 14 12:59 .bash_profile
# echo \"umask 077\" >> .bash_profile
# source .bash_profile
# umask
0077"
      reference   : "800-171|3.1.1,800-171|3.1.4,800-171|3.1.5,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-171r3|03.01.02,800-171r3|03.01.04,800-171r3|03.01.05a.,800-171r3|03.08.02,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|MP-2,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|MP-2,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|3.3,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-2,CSF|PR.PT-3,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO-27001-2022|A.5.3,ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.33,ISO-27001-2022|A.7.7,ISO-27001-2022|A.7.10,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|MP-2,ITSG-33|MP-2a.,LEVEL|1M,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|SS13c,NIAv2|SS15c,NIAv2|SS29,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
      see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
      cmd         : "su - postgres -c umask"
      expect      : "^[0-7]+77$"
    </custom_item>

    <custom_item>
      type        : FILE_CHECK
      description : "2.2 Ensure extension directory has appropriate ownership and permissions"
      info        : "The extension directory is the location of the PostgreSQL extensions. Extensions are storage engines or user defined functions (UDFs).

Limiting the accessibility of these objects will protect the confidentiality, integrity, and availability of the PostgreSQL database. If someone can modify extensions, then these extensions can be used to execute illicit instructions."
      solution    : "If needed, correct the permissions on the extension dir by executing:

# whoami
root
# chown -c root:root $(/usr/pgsql-17/bin/pg_config --sharedir)/extension
# chmod -c 0755 $(/usr/pgsql-17/bin/pg_config --sharedir)/extension

If the permissions needed correct, it is

imperative

that all extensions found in $(/usr/pgsql-17/bin/pg_config --sharedir)/extension are evaluated to ensure they have not been modified!"
      reference   : "800-171|3.1.1,800-171|3.1.4,800-171|3.1.5,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-171r3|03.01.02,800-171r3|03.01.04,800-171r3|03.01.05a.,800-171r3|03.08.02,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|MP-2,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|MP-2,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv8|3.3,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-2,CSF|PR.PT-3,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO-27001-2022|A.5.3,ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.33,ISO-27001-2022|A.7.7,ISO-27001-2022|A.7.10,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|MP-2,ITSG-33|MP-2a.,LEVEL|1A,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|SS13c,NIAv2|SS15c,NIAv2|SS29,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
      see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
      file        : "@PG_EXT_DIR@"
      owner       : "root"
      mask        : "022"
      group       : "root"
    </custom_item>

    <custom_item>
      type        : FIND_CMD
      description : "2.3 Disable PostgreSQL Command History"
      info        : "On Linux/UNIX, the PostgreSQL client logs most interactive statements to a history file.The default PostgreSQL history file is namedpsql_history in the user's home directory.

The PostgreSQL command history should be disabled.

Disabling the PostgreSQL command history reduces the probability of exposingsensitive information, such as passwords, encryption keys, or sensitive data."
      solution    : "For each OS user on the PostgreSQL server, perform the following steps to implement this setting:

 -

Removepsql_history if it exists.

# whoami
       root
       # rm -f ~<user>/.psql_history || true
       ```

    2. Use either of the techniques below to prevent it from being created again:

       1. Set the `HISTFILE` variable to `/dev/null` in `~<user>/.psqlrc`

          ```
          # whoami
          root
          # cat << EOF >> ~<user>/.psqlrc
          \\set HISTFILE /dev/null
          EOF
          ```

       2. Create `~<user>/.psql_history` as a symbolic to `/dev/null`.

          ```
          # whoami
          root
          # ln -s /dev/null $HOME/.psql_history
          ``
    3. Set the `PSQL_HISTORY` variable for all users:
       ```
        # whoami
        root
        # echo 'PSQL_HISTORY=/dev/null' >> /etc/environment
       ```"
      reference   : "800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-171r3|03.08.03,800-53|MP-6,800-53r5|MP-6,800-53r5|SR-12,CSCv8|3.5,CSF|PR.DS-3,CSF|PR.IP-6,GDPR|32.1.b,HIPAA|164.306(a)(1),ISO-27001-2022|A.5.10,ISO-27001-2022|A.7.10,ISO-27001-2022|A.7.14,ISO-27001-2022|A.8.10,ISO/IEC-27001|A.8.3.2,ITSG-33|MP-6,LEVEL|1A,NESA|T1.4.1,NESA|T1.4.2,NIAv2|MS5b,NIAv2|MS6,NIAv2|MS9,NIAv2|MS10a,NIAv2|MS10b,NIAv2|MS10c,NIAv2|MS10d,NIAv2|MS10e,NIAv2|MS10f,NIAv2|MS11a,NIAv2|MS11b,NIAv2|MS12a,NIAv2|MS12b,NIAv2|MS12c,NIAv2|MS13,NIAv2|MS14,NIAv2|MS17,NIAv2|MS18a,NIAv2|MS18b,NIAv2|MS18c,NIAv2|MS20,NIAv2|MS21,NIAv2|NS16,QCSC-v1|3.2,QCSC-v1|6.2"
      see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
      not_expect  : "\.psql_history$"
      exec        : "ls -la '{}' \\;"
      find_name   : ".psql_history"
      target      : "~"
      verbose     : YES
    </custom_item>

    <if>
      <condition auto:"WARNING" type:"AND">
        <custom_item>
          type        : FIND_CMD
          description : "look for .pg_service.conf files"
          not_expect  : ".+"
          find_name   : ".pg_service.conf"
          find_type   : "f"
          target      : "/"
          severity    : MEDIUM
        </custom_item>

        <custom_item>
          type        : FILE_CONTENT_CHECK_NOT
          description : "check for system-wide pg_service.conf file"
          file        : "/etc/sysconfig/pgsql/pg_service.conf"
          regex       : "^[\\s]*password"
          expect      : "^[\\s]*password"
          required    : NO
        </custom_item>
      </condition>

      <then>
        <report type:"PASSED">
          description : "2.4 Ensure Passwords are Not Stored in the service file"
          info        : "One can set a password in a PostgreSQL connection service file. Verify the password option is not used in a connection service file.

Using the password parameter may negatively impact the confidentiality of the user's password.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
          solution    : "Delete every password entry in the file(s) previously identified.

Impact:

The global configuration is by default readable for all users on the system.This is needed for global defaults (prompt, port, socket, etc.).If a password is present in this file then all users on the system may be able to access it."
          reference   : "800-171|3.5.2,800-171|3.13.16,800-171r3|03.05.07,800-171r3|03.13.08,800-53|IA-5(1),800-53|SC-28,800-53|SC-28(1),800-53r5|IA-5(1),800-53r5|SC-28,800-53r5|SC-28(1),CN-L3|8.1.4.7(b),CN-L3|8.1.4.8(b),CSCv8|3.11,CSF|PR.AC-1,CSF|PR.DS-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.DS-01,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(d),HIPAA|164.312(e)(2)(ii),ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.17,ISO-27001-2022|A.5.33,ITSG-33|IA-5(1),ITSG-33|SC-28,ITSG-33|SC-28a.,ITSG-33|SC-28(1),LEVEL|1M,NESA|T5.2.3,PCI-DSSv3.2.1|3.4,PCI-DSSv4.0|3.3.2,PCI-DSSv4.0|3.5.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|4.1,TBA-FIISB|28.1"
          see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
          show_output : YES
        </report>
      </then>
    </if>

    <custom_item>
      type        : CMD_EXEC
      description : "4.1 Ensure Interactive Login is Disabled"
      info        : "When created, the PostgreSQL user may have interactive access to the operating system, which means that the PostgreSQL user could login to the host as any other user would.

Preventing the PostgreSQL user from logging in interactively may reduce the impact of a compromised PostgreSQL account.There is also more accountability, as accessing the operating system where the PostgreSQL server lies will require the user's own account and the apprpriate sudo configuration.Interactive access by the PostgreSQL user is unnecessary and should be disabled."
      solution    : "Execute the following command:

# whoami
root
# passwd -l postgres

Impact:

This setting will prevent the PostgreSQL administrator from interactively logging into the operating system using the PostgreSQL user.Instead, the administrator will need to log in using one's own account and then sudo to the PostgreSQL administrator account."
      reference   : "800-171|3.1.5,800-171|3.1.6,800-171r3|03.01.06a.,800-171r3|03.01.06b.,800-53|AC-6(2),800-53|AC-6(5),800-53r5|AC-6(2),800-53r5|AC-6(5),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.10.6(a),CSCv8|5.4,CSF|PR.AC-4,CSF2.0|PR.AA-05,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO-27001-2022|A.5.15,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.18,ISO/IEC-27001|A.9.2.3,ITSG-33|AC-6(2),ITSG-33|AC-6(5),LEVEL|1M,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.6.1,NIAv2|AM1,NIAv2|AM23f,NIAv2|AM32,NIAv2|AM33,NIAv2|SS13c,NIAv2|SS15c,NIAv2|VL3a,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|5.2.2,QCSC-v1|6.2,SWIFT-CSCv1|1.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
      see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
      cmd         : "grep postgres /etc/shadow | cut -d: -f1-2 | grep \"postgres:!\" | awk '{print} END {if (NR > 0) print \"pass\" ; else print \"fail\"}'"
      expect      : "^pass$"
    </custom_item>

    <report type:"WARNING">
      description : "4.2 Ensure sudo is configured correctly"
      info        : "It is common to have more than one authorized individual administering the PostgreSQL service at the Operating System level. It is also quite common to permit login privileges to individuals on a PostgreSQL host who otherwise are not authorized to access the server's data cluster and files. Administering the PostgreSQL data cluster, as opposed to its data, is to be accomplished via a localhost login of a regular UNIX user account. Access to the postgres superuser account is restricted in such a manner as to interdict unauthorized access. sudo satisfies the requirements by escalating ordinary user account privileges as the PostgreSQL RDBMS superuser.

Without sudo there would be no capabilities to strictly control access to the superuser account nor to securely and authoritatively audit its use.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "As superuser root execute the following commands:

# whoami
root
# echo '%dba ALL=(postgres) PASSWD: ALL' > /etc/sudoers.d/postgres
# chmod 600 /etc/sudoers.d/postgres

This grants any Operating System user that is a member of the dba group the ability to use sudo -iu postgres to become the postgres user.

Ensure that all Operating System user's that need such access are members of the group."
      reference   : "800-171|3.1.5,800-171|3.1.6,800-171r3|03.01.06a.,800-171r3|03.01.06b.,800-53|AC-6(2),800-53|AC-6(5),800-53r5|AC-6(2),800-53r5|AC-6(5),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.10.6(a),CSCv7|4.3,CSCv8|5.4,CSF|PR.AC-4,CSF2.0|PR.AA-05,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO-27001-2022|A.5.15,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.18,ISO/IEC-27001|A.9.2.3,ITSG-33|AC-6(2),ITSG-33|AC-6(5),LEVEL|1M,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.6.1,NIAv2|AM1,NIAv2|AM23f,NIAv2|AM32,NIAv2|AM33,NIAv2|SS13c,NIAv2|SS15c,NIAv2|VL3a,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|5.2.2,QCSC-v1|6.2,SWIFT-CSCv1|1.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
      see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
    </report>

    <report type:"WARNING">
      description : "5.1 Do Not Specify Passwords in the Command Line"
      info        : "When a command is executed on the command line, for example

 - psql postgresql://postgres:PASSWORD@host

the password may be visible in the user's shell/command history or in the process list, thus exposing the password to other entities on the server.

If the password is visible in the process list or user's shell/command history, an attacker will be able to access the PostgreSQL database using the stolen credentials.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "-

Use the --password or -W terminal parameter without directly specifying the password and then enter the password when prompted.Substitute <user> with your username, e.g., root:

psql -u <user> --password
 -

Do not use a

Connection URI

with password included, e.g.

psql postgresql://postgres:PASSWORD@host

 -

If desired, configure apgpass file with the proper credentials and secure the file appropriately."
      reference   : "800-171|3.1.13,800-171|3.5.2,800-171|3.13.8,800-171r3|03.05.07,800-171r3|03.05.12,800-171r3|03.13.08,800-53|AC-17(2),800-53|IA-5,800-53|IA-5(1),800-53|SC-8,800-53|SC-8(1),800-53r5|AC-17(2),800-53r5|IA-5,800-53r5|IA-5(1),800-53r5|SC-8,800-53r5|SC-8(1),CN-L3|7.1.2.7(g),CN-L3|7.1.3.1(d),CN-L3|8.1.2.2(a),CN-L3|8.1.2.2(b),CN-L3|8.1.4.1(c),CN-L3|8.1.4.7(a),CN-L3|8.1.4.8(a),CN-L3|8.2.4.5(c),CN-L3|8.2.4.5(d),CN-L3|8.5.2.2,CSCv8|3.10,CSF|PR.AC-1,CSF|PR.AC-3,CSF|PR.DS-2,CSF|PR.DS-5,CSF|PR.PT-4,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.AA-05,CSF2.0|PR.DS-02,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),HIPAA|164.312(e)(1),HIPAA|164.312(e)(2)(i),ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.14,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.17,ISO-27001-2022|A.5.33,ISO-27001-2022|A.6.7,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.6.2.2,ISO/IEC-27001|A.10.1.1,ISO/IEC-27001|A.13.2.3,ITSG-33|AC-17(2),ITSG-33|IA-5,ITSG-33|IA-5(1),ITSG-33|SC-8,ITSG-33|SC-8a.,ITSG-33|SC-8(1),LEVEL|1M,NESA|T4.3.1,NESA|T4.3.2,NESA|T4.5.1,NESA|T4.5.2,NESA|T5.2.3,NESA|T5.4.2,NESA|T7.3.3,NESA|T7.4.1,NIAv2|AM37,NIAv2|IE8,NIAv2|IE9,NIAv2|IE12,NIAv2|NS5d,NIAv2|NS6b,NIAv2|NS29,NIAv2|SS24,PCI-DSSv3.2.1|2.3,PCI-DSSv3.2.1|4.1,PCI-DSSv4.0|2.2.7,PCI-DSSv4.0|4.2.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|2.1,SWIFT-CSCv1|2.6,SWIFT-CSCv1|4.1,TBA-FIISB|29.1"
      see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
    </report>

    <custom_item>
      type        : FILE_CONTENT_CHECK
      description : "6.10 Ensure Weak SSL/TLS Ciphers Are Disabled"
      info        : "The PostgreSQL ssl_ciphers directive specifies which Cipher Suites are allowed in the negotiation with the client.

In cryptography,

perfect forward secrecy

(PFS), also known as

forward secrecy

(FS), is a feature of specific key exchange protocols that give assurance that the session keys will not be compromised even if the private key of the server is compromised. For instance, RSA does not provide PFS, while the ECDHE (Elliptic-Curve Diffie-Hellman Ephemeral) and DHE (Diffie-Hellman Ephemeral) provides PFS.

ECDHE is the stronger protocol and should be preferred, while DHE may be allowed for greater compatibility with older clients.Only Cipher Suites with either the ECDHE or the DHE key exchange are allowed.

The SSL/TLS protocols support a large number of Cipher Suites including many weak and medium strength algorithms that are subject to man-in-the middle attacks and information disclosure. Some implementations even support the NULL Cipher Suite which allows a TLS connection without any cryptographic protection. Therefore, it is critical to ensure the configuration only allows strong algorithms greater than or equal to 128-bit to be negotiated with the client. Stronger 256-bit algorithms should be allowed and preferred.

Furthermore, during the TLS handshake, after the initial

Client Hello

and

Server Hello

, there is a pre-master secret generated, which is used to generate the master secret, and in turn generates the session key. When using protocols that do not provide forward secrecy, such as RSA, the pre-master secret is encrypted by the client with the server's public key and sent over the network. However, with protocols such as ECDHE (Elliptic-Curve Diffie-Hellman Ephemeral) the pre-master secret is not sent over the wire, even in encrypted format. The key exchange arrives at the shared secret in the clear using ephemeral keys that are not stored or used again. With forward secrecy, each session has a unique key exchange, so that future sessions are protected.

Note This recommendation is primarily targeted at those installs that cannot run in FIPS-mode, or need to further refine the allowable cipher list."
      solution    : "Add or modify the ssl_ciphers directive to the following value in the PostgreSQL configuration file ( postgresql.conf ):

ssl_ciphers = 'TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256,TLS_AES_128_CCM_SHA256,TLS_CHACHA20_POLY1305_SHA256,ECDHE-ECDSA-AES256-CCM,ECDHE-ECDSA-AES128-CCM,DHE-RSA-AES256-CCM,DHE-RSA-AES128-CCM,ECDHE-RSA-AES256-GCM-SHA384,ECDHE-RSA-AES128-GCM-SHA256,ECDHE-ECDSA-AES256-GCM-SHA384,ECDHE-ECDSA-AES128-GCM-SHA256,DHE-DSS-AES256-GCM-SHA384,DHE-DSS-AES128-GCM-SHA256,DHE-RSA-AES256-GCM-SHA384,DHE-RSA-AES128-GCM-SHA256'"
      reference   : "800-171|3.13.11,800-171r3|03.13.11,800-53|SC-13,800-53r5|SC-13,CSF|PR.DS-5,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(e)(2)(ii),ISO-27001-2022|A.8.24,ISO/IEC-27001|A.10.1.1,ITSG-33|SC-13,ITSG-33|SC-13a.,LEVEL|1A,NESA|M5.2.6,NESA|T7.4.1,NIAv2|CY3,NIAv2|CY4,NIAv2|CY5b,NIAv2|CY5c,NIAv2|CY5d,NIAv2|CY7,NIAv2|NS5e,QCSC-v1|6.2"
      see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
      file        : "@POSTGRES_CONFIG_PATH@"
      regex       : "(?i)^[\\s]*ssl_ciphers[\\s]*=[\\s]*'(.*)'"
      expect      : "(?i)^[\\s]*ssl_ciphers[\\s]*=[\\s]*'(,|(TLS_AES_256_GCM_SHA384)|(TLS_AES_128_GCM_SHA256)|(TLS_AES_128_CCM_SHA256)|(TLS_CHACHA20_POLY1305_SHA256)|(ECDHE\-ECDSA\-AES256\-CCM)|(ECDHE\-ECDSA\-AES128\-CCM)|(DHE\-RSA\-AES256\-CCM)|(DHE\-RSA\-AES128\-CCM)|(ECDHE\-RSA\-AES256\-GCM\-SHA384)|(ECDHE\-RSA\-AES128\-GCM\-SHA256)|(ECDHE\-ECDSA\-AES256\-GCM\-SHA384)|(ECDHE\-ECDSA\-AES128\-GCM\-SHA256)|(DHE\-DSS\-AES256\-GCM\-SHA384)|(DHE\-DSS\-AES128\-GCM\-SHA256)|(DHE\-RSA\-AES256\-GCM\-SHA384)|(DHE\-RSA\-AES128\-GCM\-SHA256)|(ECDHE\-ECDSA\-CHACHA20\-POLY1305)|(ECDHE\-RSA\-CHACHA20\-POLY1305)|(DHE\-RSA\-CHACHA20\-POLY1305))+'"
    </custom_item>

    <if>
      <condition auto:"FAILED" type:"AND">
        <custom_item>
          type        : CMD_EXEC
          description : "fips-mode-setup"
          cmd         : "fips-mode-setup --check"
          expect      : "FIPS mode is enabled."
        </custom_item>

        <custom_item>
          type        : CMD_EXEC
          description : "openssl version"
          cmd         : "openssl version"
          expect      : "FIPS"
        </custom_item>
      </condition>

      <then>
        <report type:"PASSED">
          description : "6.7 Ensure FIPS 140-2 OpenSSL Cryptography Is Used"
          info        : "Install, configure, and use OpenSSL on a platform that has a NIST certified FIPS 140-2 installation of OpenSSL. This provides PostgreSQL instances the ability to generate and validate cryptographic hashes to protect unclassified information requiring confidentiality and cryptographic protection, in accordance with the data owner's requirements.

Federal Information Processing Standard (FIPS) Publication 140-2 is a computer security standard developed by a U.S. Government and industry working group for validating the quality of cryptographic modules. Use of weak, or untested, encryption algorithms undermines the purposes of utilizing encryption to protect data. PostgreSQL uses OpenSSL for the underlying encryption layer.

The database and application must implement cryptographic modules adhering to the higher standards approved by the federal government since this provides assurance they have been tested and validated. It is the responsibility of the data owner to assess the cryptography requirements in light of applicable federal laws, Executive Orders, directives, policies, regulations, and standards.

For detailed information, refer to NIST FIPS Publication 140-2,

Security Requirements for Cryptographic Modules

. Note that the product's cryptographic modules must be validated and certified by NIST as FIPS-compliant. The security functions validated as part of FIPS 140-2 for cryptographic modules are described in FIPS 140-2 Annex A. Currently, only Red Hat Enterprise Linux is certified as a FIPS 140-2 distribution of OpenSSL. For other operating systems, users must obtain or build their own FIPS 140-2 OpenSSL libraries."
          solution    : "Configure OpenSSL to be FIPS compliant as PostgreSQL uses OpenSSL for cryptographic modules. To configure OpenSSL to be FIPS 140-2 compliant, see the

official RHEL Documentation

. Below is a general summary of the steps required:

To switch the system to FIPS mode in RHEL 9:

# whoami
root
# fips-mode-setup --enable
Kernel initramdisks are being regenerated. This might take some time.
Setting system policy to FIPS
Note: System-wide crypto policies are applied on application start-up.
It is recommended to restart the system for the change of policies
to fully take place.
FIPS mode will be enabled.
Please reboot the system for the setting to take effect.

Restart your system to allow the kernel to switch to FIPS mode:

# whoami
root
# reboot

After the restart, you can check the current state of FIPS mode:

# whoami
root
# fips-mode-setup --check
FIPS mode is enabled."
          reference   : "800-171|3.1.13,800-171|3.5.2,800-171|3.13.8,800-171r3|03.05.07,800-171r3|03.05.12,800-171r3|03.13.08,800-53|AC-17(2),800-53|IA-5,800-53|IA-5(1),800-53|SC-8,800-53|SC-8(1),800-53r5|AC-17(2),800-53r5|IA-5,800-53r5|IA-5(1),800-53r5|SC-8,800-53r5|SC-8(1),CN-L3|7.1.2.7(g),CN-L3|7.1.3.1(d),CN-L3|8.1.2.2(a),CN-L3|8.1.2.2(b),CN-L3|8.1.4.1(c),CN-L3|8.1.4.7(a),CN-L3|8.1.4.8(a),CN-L3|8.2.4.5(c),CN-L3|8.2.4.5(d),CN-L3|8.5.2.2,CSCv7|14.4,CSCv8|3.10,CSF|PR.AC-1,CSF|PR.AC-3,CSF|PR.DS-2,CSF|PR.DS-5,CSF|PR.PT-4,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.AA-05,CSF2.0|PR.DS-02,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),HIPAA|164.312(e)(1),HIPAA|164.312(e)(2)(i),ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.14,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.17,ISO-27001-2022|A.5.33,ISO-27001-2022|A.6.7,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.6.2.2,ISO/IEC-27001|A.10.1.1,ISO/IEC-27001|A.13.2.3,ITSG-33|AC-17(2),ITSG-33|IA-5,ITSG-33|IA-5(1),ITSG-33|SC-8,ITSG-33|SC-8a.,ITSG-33|SC-8(1),LEVEL|1A,NESA|T4.3.1,NESA|T4.3.2,NESA|T4.5.1,NESA|T4.5.2,NESA|T5.2.3,NESA|T5.4.2,NESA|T7.3.3,NESA|T7.4.1,NIAv2|AM37,NIAv2|IE8,NIAv2|IE9,NIAv2|IE12,NIAv2|NS5d,NIAv2|NS6b,NIAv2|NS29,NIAv2|SS24,PCI-DSSv3.2.1|2.3,PCI-DSSv3.2.1|4.1,PCI-DSSv4.0|2.2.7,PCI-DSSv4.0|4.2.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|2.1,SWIFT-CSCv1|2.6,SWIFT-CSCv1|4.1,TBA-FIISB|29.1"
          see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
          show_output : YES
        </report>
      </then>
    </if>

    <custom_item>
      type        : CMD_EXEC
      description : "8.2 Ensure the backup and restore tool, 'pgBackRest', is installed and configured"
      info        : "pgBackRest aims to be a simple, reliable backup and restore system that can seamlessly scale up to the largest databases and workloads. Instead of relying on traditional backup tools like tar and rsync pgBackRest implements all backup features internally and uses a custom protocol for communicating with remote systems. Removing reliance on tar and rsync allows for better solutions to database-specific backup challenges. The custom remote protocol allows for more flexibility and limits the types of connections that are required to perform a backup which increases security.

The native PostgreSQL backup facility pg_dump provides adequate logical backup operations but does not provide for Point In Time Recovery (PITR). The PostgreSQL facility pg_basebackup performs a physical backup of the database files and does provide for PITR, but it is constrained by single threading. Both of these methodologies are standard in the PostgreSQL ecosystem and appropriate for particular backup/recovery needs. pgBackRest offers another option with much more robust features and flexibility.

pgBackRest is open-source software developed to perform efficient backups on PostgreSQL databases that measure in tens of terabytes and greater. It supports per-file checksums, compression, partial/failed backup resume, high-performance parallel transfer, asynchronous archiving, tablespaces, expiration, full/differential/incremental backups, local/remote operation via SSH or TLS, hard-linking, restore, backup encryption and more. pgBackRest is written in C and does not depend on rsync or tar but instead performs its own deltas which give it maximum flexibility. Finally, pgBackRest provides an easy-to-use internal repository listing backup details accessible via the pgbackrest info command, as illustrated below.

$ pgbackrest info
stanza: proddb01
status: ok

db (current)
wal archive min/max (17.0-1): 000000010000000000000012 / 000000010000000000000017

  full backup: 20231012-153106F
      timestamp start/stop: 2023-10-12 15:31:06 / 2023-10-12 15:31:49
      wal start/stop: 000000010000000000000012 / 000000010000000000000012
      database size: 29.4MB, backup size: 29.4MB
      repository size: 3.4MB, repository backup size: 3.4MB

  diff backup: 20231012-153106F_20231012-173109D
      timestamp start/stop: 2023-10-12 17:31:09 / 2023-10-12 17:31:19
      wal start/stop: 000000010000000000000015 / 000000010000000000000015
      database size: 29.4MB, backup size: 2.6MB
      repository size: 3.4MB, repository backup size: 346.8KB
      backup reference list: 20231012-153106F

  incr backup: 20231012-153106F_20231012-183114I
      timestamp start/stop: 2023-10-12 18:31:14 / 2023-10-12 18:31:22
      wal start/stop: 000000010000000000000017 / 000000010000000000000017
      database size: 29.4MB, backup size: 8.2KB
      repository size: 3.4MB, repository backup size: 519B
      backup reference list: 20231012-153106F, 20231012-153106F_20231012-173109D"
      solution    : "pgBackRest is not installed nor configured for PostgreSQL by default, but instead is maintained as a GitHub project. Fortunately, it is a part of the PGDG repository and can be easily installed:

# whoami
root
# subscription-manager repos --enable codeready-builder-for-rhel-9-$(arch)-rpms && dnf -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
<snip>
Installed:
  epel-release-9-8.el9.noarch

Complete!
# dnf -y install pgbackrest
<snip>
Installed:
  libssh2-1.11.0-1.el9.x86_64 pgbackrest-2.53.1-1PGDG.rhel9.x86_64

Complete!

Once installed, pgBackRest must be configured for things like stanza name, backup location, retention policy, logging, etc. Please consult the

configuration guide

.

If employing pgBackRest for your backup/recovery solution, ensure the repository, base backups, and WAL archives are stored on a reliable file system separate from the database server. Further, the external storage system where backups reside should have limited access to only those system administrators as necessary. Finally, as with any backup/recovery solution, stringent testing must be conducted. A backup is only good if it can be restored successfully."
      reference   : "800-171|3.8.9,800-171r3|03.08.09,800-53|CP-9,800-53|CP-10,800-53r5|CP-9,800-53r5|CP-10,CSCv7|10.1,CSCv7|10.2,CSCv8|11.2,CSF|PR.IP-4,CSF|RC.RP-1,CSF|RS.RP-1,CSF2.0|PR.DS-01,CSF2.0|PR.DS-10,CSF2.0|PR.DS-11,CSF2.0|RC.RP,CSF2.0|RC.RP-01,CSF2.0|RC.RP-02,CSF2.0|RC.RP-03,CSF2.0|RC.RP-05,GDPR|32.1.b,GDPR|32.1.c,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(ii),ISO-27001-2022|A.5.29,ISO-27001-2022|A.5.33,ISO-27001-2022|A.8.13,ISO/IEC-27001|A.12.3.1,ITSG-33|CP-9,ITSG-33|CP-10,ITSG-33|CP-10a.,LEVEL|1A,NESA|M5.2.3,NESA|T2.2.4,QCSC-v1|5.2.3,QCSC-v1|10.2.1,QCSC-v1|11.2"
      see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
      cmd         : "pgbackrest"
      expect      : "^pgBackRest .+$"
    </custom_item>
  </then>

  <else>
    <report type:"WARNING">
      description : "CIS_PostgreSQL_17_v1.0.0_L1_OS_Linux.audit from CIS PostgreSQL 17 Benchmark v1.0.0"
      info        : "NOTE: Nessus has not identified that the chosen audit applies to the target device."
      see_also    : "https://workbench.cisecurity.org/benchmarks/19478"
      show_output : YES
    </report>
  </else>
</if>

</check_type>
