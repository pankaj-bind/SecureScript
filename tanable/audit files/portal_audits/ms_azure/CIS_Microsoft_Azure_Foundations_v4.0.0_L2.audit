#TRUSTED 0a8b1680f62511af467109c807b631113fa4f563a2d77d4c5e3ef3c8d3c89022481796b56cb25c357029a2fd065f40e84cb25863116433cf4909c79d440562e8946ef0c46ab75b11eddedc76656c9bf16ced883bd385deb1a32315aef9de01f8161841f1fc47398e2e37963c2ff8e51aa84ff8488df0f29aa7606cae19aeb3884432b955f81fd642dc46b0e2dc6f91b603c2aac5ef5592e1224584ef3750b70a2e9bd4b327eee12637277b84ba3b4cbbb7955a3abf1399f10b2bce05cb13ba60a54136ace69ba6efbfad5b4061d169ee4ef1e29ce429a0cec0546abc0cd42908e8157ad981ab4087a75185ad34fa8b1d07c0b912aaf8f8f36b5081b70b75e16db3d9cdb72bb7b1c8ae1e701518563885f11d08103f9667f6dea8550e0f49b3c3880cf530297c0ede7d55af3706bd062da81ae2672d42fe8481f8a7063f1d27d9c6ecde62c36637619f4021ef3f9aaaebf7a87c0322c366924c6b3160225133602f704214892b94116a23d339928ce3cecd4e90791d30025f3b3549dd75b228d27f80c398fbd0e0b326d2d3c9c7d392f786774510a1790a784ddf288ca22d919086fcca0491519d87da1da554314972231294692f76e983d2cfeb215cf68d9c2183d5d5c9d41850dfa211c04afd128a98524ebd421fe1a7df1d6b35ff4fca65a399ec770df4e45d4c718f5489bbe9b1f4d13df72790827e53071badaf275614b1
#TRUST-RSA-SHA256 225b89a400997b1a48dfc4c300bcf91579e5000df0902ee5e7b69e1a924a0804be86c8b061d9c318918f19cc3e7e07aa94215f68fdd5a2e63ffadd60e8e7ba8e8232bb03c772e01e08bd232494d86870fa3221e68b3f1a43c2ad7f22a56925c0a116525c656a7cb5a9de0530f3aa8d60ec242c67807f3a4dfb11d793846f4845e72772f9db50e985cae891086890c082d7479d9332fef49a2a0950fcfce2b56c09bb49e693a354f4b55b76205cdd4c48296d2d945fe7334a234bce84929655cb72fcf6ac0767389d8932b1e20ad80dc31f6c61da742e7f175bfd0384df692927afe9976e5dd5fb9ba8af9f308f89c319109edff6dcfeb1bd89a2c246f6be185a3c99f97a4404b8b2e47205e3c8396e3b99daf4a9b7031825445c88ba8c0994d4189b7e05f7685bb77801a3593d072b14602f2c89a24a1f5bb83c2db73483480bf68906cde4a3e8e85ca3ce203b792fa9ea42cbb00d7001f4b05c4e9781d6631bbf441aaca7f9300e2393539f5559f4a37a6bab1139de1ef55880dc1f657b4285eb7cd3623acdb245d00cd317eaee73d85f2359a94730ef8fe325909cea01b2239b07faa310877d8698071bff6b2df5bee1e523ff4aa8d8bdb4a34fa6e8218d42788c589ca1d2193285fbd03f79d73c63e0698e20b3e0b968efea043aef08a0656f98b974373844ecb9a9cb326fac6be623c42b699cbb41660902a7d759940978
#
# This script is Copyright (C) 2004-2025 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This script is released under the Tenable Subscription License and
# may not be used from within scripts released under another license
# without authorization from Tenable, Inc.
#
# See the following licenses for details:
#
# http://static.tenable.com/prod_docs/Nessus_6_SLA_and_Subscription_Agreement.pdf
#
# @PROFESSIONALFEED@
# $Revision: 1.0 $
# $Date: 2025/06/24 $
#
# description : This .audit is designed against the CIS Microsoft Azure Foundations Benchmark 4.0.0
#
#<ui_metadata>
#<display_name>CIS Microsoft Azure Foundations v4.0.0 L2</display_name>
#<spec>
#  <type>CIS</type>
#  <name>Microsoft Azure Foundations</name>
#  <profile>L2</profile>
#  <version>4.0.0</version>
#  <link>https://workbench.cisecurity.org/benchmarks/19304</link>
#</spec>
#<labels>microsoft_azure,cis,microsoft_azure_foundations,cloud</labels>
#<benchmark_refs>CSCv6,CSCv7,CSCv8,LEVEL</benchmark_refs>
#</ui_metadata>

<check_type:"microsoft_azure">

<custom_item>
  description    : "10.2.2 Ensure 'Versioning' is set to 'Enabled' on Azure Blob Storage storage accounts"
  info           : "Enabling blob versioning allows for the automatic retention of previous versions of objects. With blob versioning enabled, earlier versions of a blob are accessible for data recovery in the event of modifications or deletions.

Blob versioning safeguards data integrity and enables recovery by retaining previous versions of stored objects, facilitating quick restoration from accidental deletion, modification, or malicious activity.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
  solution       : "Remediate from Azure Portal

 - Go to Storage accounts
 - Click the name of a storage account with blob storage.
 - In the Overview page, on the Properties tab, under Blob service click Disabled next to Versioning
 - Under Tracking check the box next to Enable versioning for blobs
 - Select the radio button next to Keep all versions or Delete versions after (in days)
 - If selecting to delete versions, enter a number of in the box after which to delete blob versions.
 - Click Save
 - Repeat steps 1-7 for each storage account with blob storage.

Remediate from Azure CLI

For each storage account requiring remediation, run the following command to enable blob versioning:

az storage account blob-service-properties update --account-name <storage-account> --enable-versioning true

Remediate from PowerShell

For each storage account requiring remediation, run the following command to enable blob versioning:

Update-AzStorageBlobServiceProperty -ResourceGroupName <resource-group> -StorageAccountName <storage-account> -IsVersioningEnabled $true

Impact:

Enabling blob versioning for a storage account creates a new version with each write operation to a blob, which can increase storage costs. To control these costs, a lifecycle management policy can be applied to automatically delete older versions."
  reference      : "800-53|CP-2,800-53|CP-10,800-53r5|CP-2,800-53r5|CP-10,CSCv7|10.1,CSCv8|11.1,CSF|DE.AE-4,CSF|ID.AM-5,CSF|ID.AM-6,CSF|ID.BE-1,CSF|ID.BE-5,CSF|PR.DS-4,CSF|PR.IP-7,CSF|PR.IP-9,CSF|RC.CO-3,CSF|RC.IM-1,CSF|RC.IM-2,CSF|RC.RP-1,CSF|RS.AN-2,CSF|RS.AN-4,CSF|RS.CO-1,CSF|RS.CO-3,CSF|RS.CO-4,CSF|RS.IM-1,CSF|RS.IM-2,CSF|RS.RP-1,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.IM-04,CSF2.0|PR.IR-02,CSF2.0|RC.CO-04,CSF2.0|RC.RP,CSF2.0|RC.RP-01,CSF2.0|RC.RP-02,CSF2.0|RC.RP-03,CSF2.0|RC.RP-05,GDPR|32.1.b,GDPR|32.1.c,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(ii),ISO-27001-2022|A.5.2,ISO-27001-2022|A.5.29,ISO-27001-2022|A.8.14,ISO-27001-2022|7.5.1,ISO-27001-2022|7.5.2,ISO-27001-2022|7.5.3,ITSG-33|CP-2,ITSG-33|CP-10,ITSG-33|CP-10a.,LEVEL|2A,NESA|T2.2.4,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listStorageAccounts"
  json_transform : '.[]|.subscriptionId as $id|.value[] | "Subscription ID: \($id), Name: \(.name)"'
  not_expect     : ".+"
  severity       : MEDIUM
</custom_item>

<if>
  <condition auto:"WARNING" type:"AND">
    <custom_item>
      description    : "locks"
      request        : "listManagementLocksByResourceGroup"
      json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgname|.value[]|"Subscription ID: \($subid), Resource Group: \($rgname), Lock Name: \(.name), Lock Level: \(.properties.level)"'
      not_expect     : ".+"
      severity       : MEDIUM
    </custom_item>

    <custom_item>
      description    : "storage accounts"
      request        : "listStorageAccounts"
      json_transform : '.[]|.subscriptionId as $id| .value[]| .name as $name| "Subscription ID: \($id), Name: \($name)"'
      not_expect     : ".+"
      severity       : MEDIUM
    </custom_item>
  </condition>

  <then>
    <report type:"PASSED">
      description : "10.3.11 Ensure Azure Resource Manager ReadOnly locks are considered for Azure Storage Accounts"
      info        : "Adding an Azure Resource Manager ReadOnly lock can prevent users from accidentally or maliciously deleting a storage account, modifying its properties and containers, or creating access assignments. The lock must be removed before the storage account can be deleted or updated. It provides more protection than a CannotDelete -type of resource manager lock.

This feature prevents POST operations on a storage account and containers to the Azure Resource Manager control plane,

management.azure.com

. Blocked operations include listKeys which prevents clients from obtaining the account shared access keys.

Microsoft does not recommend ReadOnly locks for storage accounts with Azure Files and Table service containers.

This Azure Resource Manager REST API documentation (spec) provides information about the control plane POST operations for

Microsoft.Storage

resources.

Applying a ReadOnly lock on storage accounts protects the confidentiality and availability of data by preventing the accidental or unauthorized deletion of the entire storage account and modification of the account, container properties, or access permissions. It can offer enhanced protection for blob and queue workloads with tradeoffs in usability and compatibility for clients using account shared access keys.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
      solution    : "Remediate from Azure Portal

 - Navigate to the storage account in the Azure portal.
 - Under the Settings section, select Locks
 - Select Add
 - Provide a Name, and choose ReadOnly for the type of lock.
 - Add a note about the lock if desired.

Remediate from Azure CLI

Replace the information within <> with appropriate values:

az lock create --name <lock> \\
               --resource-group <resource-group> \\
               --resource <storage-account> \\
               --lock-type ReadOnly \\
               --resource-type Microsoft.Storage/storageAccounts

Remediate from PowerShell

Replace the information within <> with appropriate values:

New-AzResourceLock -LockLevel ReadOnly `
                   -LockName <lock> `
                   -ResourceName <storage-account> `
                   -ResourceType Microsoft.Storage/storageAccounts `
                   -ResourceGroupName <resource-group>

Impact:

 - Prevents the deletion of the Storage account Resource entirely.
 - Prevents the deletion of the parent Resource Group containing the locked Storage account resource.
 - Prevents clients from obtaining the storage account shared access keys using a listKeys operation.
 - Requires Entra credentials to access blob and queue data in the Portal.
 - Data in Azure Files or the Table service may be inaccessible to clients using the account shared access keys.
 - Prevents modification of account properties, network settings, containers, and RBAC assignments.
 - Does not prevent access using existing account shared access keys issued to clients.
 - Does not prevent deletion of containers or other objects within the storage account."
      reference   : "800-171|3.1.7,800-171r3|03.01.07a.,800-53|AC-6(10),800-53r5|AC-6(10),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.10.6(a),CSF|PR.AC-4,CSF2.0|PR.AA-05,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO-27001-2022|A.5.15,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.18,ITSG-33|AC-6,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM23f,NIAv2|SS13c,NIAv2|SS15c,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|5.2.2,QCSC-v1|6.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
      see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
      show_output : YES
    </report>
  </then>
</if>

<custom_item>
  description    : "10.3.12 Ensure Redundancy is set to 'geo-redundant storage (GRS)' on critical Azure Storage Accounts"
  info           : "Geo-redundant storage (GRS) in Azure replicates data three times within the primary region using locally redundant storage (LRS) and asynchronously copies it to a secondary region hundreds of miles away. This setup ensures high availability and resilience by providing 16 nines (99.99999999999999%) durability over a year, safeguarding data against regional outages.

Enabling GRS protects critical data from regional failures by maintaining a copy in a geographically separate location. This significantly reduces the risk of data loss, supports business continuity, and meets high availability requirements for disaster recovery."
  solution       : "Remediate from Azure Portal

 - Go to Storage accounts
 - Click on a storage account.
 - Under Data management click Redundancy
 - From the Redundancy drop-down menu, select Geo-redundant storage (GRS)
 - Click Save
 - Repeat steps 1-5 for each storage account requiring remediation.

Remediate from Azure CLI

For each storage account requiring remediation, run the following command to enable geo-redundant storage:

az storage account update --resource-group <resource-group> --name <storage-account> --sku Standard_GRS

Remediate from PowerShell

For each storage account requiring remediation, run the following command to enable geo-redundant storage:

Set-AzStorageAccount -ResourceGroupName <resource-group> -Name <storage-account> -SkuName \"Standard_GRS\"

Impact:

Enabling geo-redundant storage on Azure storage accounts increases costs due to cross-region data replication."
  reference      : "800-53|CP-2,800-53|CP-10,800-53r5|CP-2,800-53r5|CP-10,CSCv7|10,CSCv8|11.1,CSF|DE.AE-4,CSF|ID.AM-5,CSF|ID.AM-6,CSF|ID.BE-1,CSF|ID.BE-5,CSF|PR.DS-4,CSF|PR.IP-7,CSF|PR.IP-9,CSF|RC.CO-3,CSF|RC.IM-1,CSF|RC.IM-2,CSF|RC.RP-1,CSF|RS.AN-2,CSF|RS.AN-4,CSF|RS.CO-1,CSF|RS.CO-3,CSF|RS.CO-4,CSF|RS.IM-1,CSF|RS.IM-2,CSF|RS.RP-1,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.IM-04,CSF2.0|PR.IR-02,CSF2.0|RC.CO-04,CSF2.0|RC.RP,CSF2.0|RC.RP-01,CSF2.0|RC.RP-02,CSF2.0|RC.RP-03,CSF2.0|RC.RP-05,GDPR|32.1.b,GDPR|32.1.c,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(ii),ISO-27001-2022|A.5.2,ISO-27001-2022|A.5.29,ISO-27001-2022|A.8.14,ISO-27001-2022|7.5.1,ISO-27001-2022|7.5.2,ISO-27001-2022|7.5.3,ITSG-33|CP-2,ITSG-33|CP-10,ITSG-33|CP-10a.,LEVEL|2A,NESA|T2.2.4,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listStorageAccounts"
  json_transform : '.[]|.subscriptionId as $id| .value[]| .name as $name| "Subscription ID: \($id), Name: \($name), SKU: \(.sku.name)"'
  expect         : "SKU: Standard_GRS"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "10.3.2.1 Ensure Private Endpoints are used to access Storage Accounts"
  info           : "Use private endpoints for your Azure Storage accounts to allow clients and services to securely access data located over a network via an encrypted Private Link. To do this, the private endpoint uses an IP address from the VNet for each service. Network traffic between disparate services securely traverses encrypted over the VNet. This VNet can also link addressing space, extending your network and accessing resources on it. Similarly, it can be a tunnel through public networks to connect remote infrastructures together. This creates further security through segmenting network traffic and preventing outside sources from accessing it.

Securing traffic between services through encryption protects the data from easy interception and reading."
  solution       : "Remediate from Azure Portal

 - Open the Storage Accounts blade
 - For each listed Storage Account, perform the following:
 - Under the Security + networking heading, click on Networking
 - Click on the Private endpoint connections tab at the top of the networking window
 - Click the + Private endpoint button
 - In the 1 - Basics tab/step:
 - Enter a name that will be easily recognizable as associated with the Storage Account (

Note

: The \"Network Interface Name\" will be automatically completed, but you can customize it if needed.)
 - Ensure that the Region matches the region of the Storage Account
 - Click Next

 - In the 2 - Resource tab/step:
 - Select the target sub-resource based on what type of storage resource is being made available
 - Click Next

 - In the 3 - Virtual Network tab/step:
 - Select the Virtual network that your Storage Account will be connecting to
 - Select the Subnet that your Storage Account will be connecting to
 - (Optional) Select other network settings as appropriate for your environment
 - Click Next

 - In the 4 - DNS tab/step:
 - (Optional) Select other DNS settings as appropriate for your environment
 - Click Next

 - In the 5 - Tags tab/step:
 - (Optional) Set any tags that are relevant to your organization
 - Click Next

 - In the 6 - Review + create tab/step:
 - A validation attempt will be made and after a few moments it should indicate Validation Passed - if it does not pass, double-check your settings before beginning more in depth troubleshooting.
 - If validation has passed, click Create then wait for a few minutes for the scripted deployment to complete.

Repeat the above procedure for each Private Endpoint required within every Storage Account.

Remediate from PowerShell

$storageAccount = Get-AzStorageAccount -ResourceGroupName '<ResourceGroupName>' -Name '<storageaccountname>'

$privateEndpointConnection = @{
                                Name = 'connectionName'
                                PrivateLinkServiceId = $storageAccount.Id
                                GroupID = \"blob|blob_secondary|file|file_secondary|table|table_secondary|queue|queue_secondary|web|web_secondary|dfs|dfs_secondary\"
}

$privateLinkServiceConnection = New-AzPrivateLinkServiceConnection @privateEndpointConnection

$virtualNetDetails = Get-AzVirtualNetwork -ResourceGroupName '<ResourceGroupName>' -Name '<name>'

$privateEndpoint = @{
                    ResourceGroupName = '<ResourceGroupName>'
                    Name = '<PrivateEndpointName>'
                    Location = '<location>'
                    Subnet = $virtualNetDetails.Subnets[0]
                    PrivateLinkServiceConnection = $privateLinkServiceConnection
}

New-AzPrivateEndpoint @privateEndpoint

Remediate from Azure CLI

az network private-endpoint create --resource-group <ResourceGroupName --location <location> --name <private endpoint name> --vnet-name <VNET Name> --subnet <subnet name> --private-connection-resource-id <storage account ID> --connection-name <private link service connection name> --group-id <blob|blob_secondary|file|file_secondary|table|table_secondary|queue|queue_secondary|web|web_secondary|dfs|dfs_secondary>

Impact:

If an Azure Virtual Network is not implemented correctly, this may result in the loss of critical network traffic.

Private endpoints are charged per hour of use. Refer to

https://azure.microsoft.com/en-us/pricing/details/private-link/

and

https://azure.microsoft.com/en-us/pricing/calculator/

to estimate potential costs."
  reference      : "800-171|3.4.6,800-171|3.4.7,800-171|3.13.1,800-171|3.13.2,800-171|3.13.5,800-171r3|03.04.06,800-171r3|03.13.01,800-171r3|03.16.01,800-53|CM-7,800-53|CP-6,800-53|CP-7,800-53|PL-8,800-53|PM-7,800-53|SA-8,800-53|SC-7,800-53r5|CM-7,800-53r5|CP-6,800-53r5|CP-7,800-53r5|PL-8,800-53r5|PM-7,800-53r5|SA-8,800-53r5|SC-7,CN-L3|8.1.10.6(j),CSCv7|14.1,CSCv8|12.2,CSF|DE.CM-1,CSF|ID.AM-3,CSF|PR.AC-5,CSF|PR.DS-5,CSF|PR.IP-1,CSF|PR.IP-2,CSF|PR.IP-4,CSF|PR.PT-3,CSF|PR.PT-4,CSF2.0|DE.CM-01,CSF2.0|ID.AM-03,CSF2.0|ID.AM-08,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.DS-11,CSF2.0|PR.IR-01,CSF2.0|PR.IR-03,CSF2.0|PR.IR-04,CSF2.0|PR.PS-01,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.c,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.5.8,ISO-27001-2022|A.5.14,ISO-27001-2022|A.5.29,ISO-27001-2022|A.7.5,ISO-27001-2022|A.8.14,ISO-27001-2022|A.8.16,ISO-27001-2022|A.8.20,ISO-27001-2022|A.8.27,ISO-27001-2022|A.8.28,ISO/IEC-27001|A.13.1.3,ITSG-33|CM-7,ITSG-33|CP-6,ITSG-33|CP-7,ITSG-33|SA-8,ITSG-33|SA-8a.,ITSG-33|SC-7,LEVEL|2A,NESA|T2.2.4,NESA|T3.4.1,NESA|T4.5.3,NESA|T4.5.4,NESA|T7.6.5,NIAv2|GS1,NIAv2|GS2a,NIAv2|GS2b,NIAv2|SS3,NIAv2|SS15a,NIAv2|VL2,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv3.2.1|2.2.2,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,SWIFT-CSCv1|2.3,TBA-FIISB|43.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listStorageAccounts"
  json_transform : '.[]|.subscriptionId as $id| .value[]| .name as $name| "Subscription ID: \($id), Name: \($name), Private Endpoint Connections: \(.properties.privateEndpointConnections | length > 0)"'
  not_expect     : "Private Endpoint Connections: false"
</custom_item>

<custom_item>
  description    : "10.3.5 Ensure 'Allow Azure services on the trusted services list to access this storage account' is Enabled for Storage Account Access"
  info           : "NOTE:

This recommendation assumes that the Public network access parameter is set to Enabled from selected virtual networks and IP addresses Please ensure the prerequisite recommendation has been implemented before proceeding:

 - Ensure Default Network Access Rule for Storage Accounts is Set to Deny

Some Azure services that interact with storage accounts operate from networks that can't be granted access through network rules. To help this type of service work as intended, allow the set of trusted Azure services to bypass the network rules. These services will then use strong authentication to access the storage account. If the Allow Azure services on the trusted services list to access this storage account exception is enabled, the following services are granted access to the storage account: Azure Backup, Azure Data Box, Azure DevTest Labs, Azure Event Grid, Azure Event Hubs, Azure File Sync, Azure HDInsight, Azure Import/Export, Azure Monitor, Azure Networking Services, and Azure Site Recovery (when registered in the subscription).

Turning on firewall rules for a storage account will block access to incoming requests for data, including from other Azure services. We can re-enable this functionality by allowing access to trusted Azure services through networking exceptions."
  solution       : "Remediate from Azure Portal

 - Go to Storage Accounts
 - For each storage account, under Security + networking click Networking
 - Click on the Firewalls and virtual networks heading.
 - Under Exceptions check the box next to Allow Azure services on the trusted services list to access this storage account
 - Click Save

Remediate from Azure CLI

Use the below command to update bypass to Azure services

az storage account update --name <StorageAccountName> --resource-group <resourceGroupName> --bypass AzureServices

Impact:

This creates authentication credentials for services that need access to storage resources so that services will no longer need to communicate via network request. There may be a temporary loss of communication as you set each Storage Account. It is recommended to not do this on mission-critical resources during business hours."
  reference      : "800-171|3.1.1,800-171|3.1.2,800-171|3.1.4,800-171|3.1.5,800-171|3.1.12,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-171|3.13.1,800-171|3.13.5,800-171|3.14.6,800-171|3.14.7,800-171r3|03.01.02,800-171r3|03.01.04,800-171r3|03.01.05a.,800-171r3|03.01.12,800-171r3|03.08.02,800-171r3|03.13.01,800-171r3|03.14.06,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|AC-17,800-53|AC-17(1),800-53|MP-2,800-53|SC-7,800-53|SI-4,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-17,800-53r5|AC-17(1),800-53r5|MP-2,800-53r5|SC-7,800-53r5|SI-4,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|7.1.3.5(a),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.4(c),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.5(b),CN-L3|8.1.10.6(a),CN-L3|8.1.10.6(f),CN-L3|8.1.10.6(i),CN-L3|8.1.10.6(j),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|13.3,CSCv8|3.3,CSCv8|13.5,CSF|DE.AE-1,CSF|DE.AE-2,CSF|DE.AE-3,CSF|DE.AE-4,CSF|DE.CM-1,CSF|DE.CM-5,CSF|DE.CM-6,CSF|DE.CM-7,CSF|DE.DP-2,CSF|DE.DP-3,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.AC-3,CSF|PR.AC-4,CSF|PR.AC-5,CSF|PR.DS-5,CSF|PR.IP-8,CSF|PR.PT-2,CSF|PR.PT-3,CSF|PR.PT-4,CSF|RS.AN-1,CSF|RS.CO-3,CSF2.0|DE.AE-02,CSF2.0|DE.AE-03,CSF2.0|DE.CM-01,CSF2.0|DE.CM-06,CSF2.0|DE.CM-09,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.5.3,ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.14,ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.33,ISO-27001-2022|A.6.7,ISO-27001-2022|A.7.7,ISO-27001-2022|A.7.10,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.16,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.6.2.2,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.13.1.3,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|AC-17,ITSG-33|AC-17(1),ITSG-33|MP-2,ITSG-33|MP-2a.,ITSG-33|SC-7,ITSG-33|SI-4,LEVEL|2A,NESA|M1.2.2,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T4.5.4,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|GS1,NIAv2|GS2a,NIAv2|GS2b,NIAv2|SS13c,NIAv2|SS15c,NIAv2|SS29,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,QCSC-v1|13.2,SWIFT-CSCv1|2.6,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3,TBA-FIISB|43.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listStorageAccounts"
  json_transform : '.[]|.subscriptionId as $id| .value[]| .name as $name| "Subscription ID: \($id), Name: \($name), Bypass: \(.properties.networkAcls.bypass)"'
  expect         : "Bypass: .*AzureServices"
  match_all      : YES
</custom_item>

<report type:"WARNING">
  description : "2.1.1.2.1 Ensure Critical Data is Encrypted with Customer Managed Keys (CMK)"
  info        : "Customer Managed Keys introduce additional depth to security by providing a means to manage access control for encryption keys. Where compliance and security frameworks indicate the need, and organizational capacity allows, sensitive data at rest can be encrypted using Customer Managed Keys (CMK) rather than Microsoft Managed keys.

By default in Azure, data at rest tends to be encrypted using Microsoft Managed Keys. If your organization wants to control and manage encryption keys for compliance and defense-in-depth, Customer Managed Keys can be established.

While it is possible to automate the assessment of this recommendation, the assessment status for this recommendation remains 'Manual' due to ideally limited scope. The scope of application - which workloads CMK is applied to - should be carefully considered to account for organizational capacity and targeted to workloads with specific need for CMK.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Impact:

If the key expires due to setting the 'activation date' and 'expiration date', the key must be rotated manually.

Using Customer Managed Keys may also incur additional man-hour requirements to create, store, manage, and protect the keys as needed."
  reference   : "800-171|3.5.2,800-171|3.13.16,800-171r3|03.05.07,800-171r3|03.13.08,800-53|IA-5(1),800-53|SC-28,800-53|SC-28(1),800-53r5|IA-5(1),800-53r5|SC-28,800-53r5|SC-28(1),CN-L3|8.1.4.7(b),CN-L3|8.1.4.8(b),CSCv7|14.8,CSCv8|3.11,CSF|PR.AC-1,CSF|PR.DS-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.DS-01,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(d),HIPAA|164.312(e)(2)(ii),ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.17,ISO-27001-2022|A.5.33,ITSG-33|IA-5(1),ITSG-33|SC-28,ITSG-33|SC-28a.,ITSG-33|SC-28(1),LEVEL|2M,NESA|T5.2.3,PCI-DSSv3.2.1|3.4,PCI-DSSv4.0|3.3.2,PCI-DSSv4.0|3.5.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|4.1,TBA-FIISB|28.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "2.2.2.1 Ensure Private Endpoints are used to access {service}"
  info        : "Use private endpoints to allow clients and services to securely access data located over a network via an encrypted Private Link. To do this, the private endpoint uses an IP address from the VNet for each service. Network traffic between disparate services securely traverses encrypted over the VNet. This VNet can also link addressing space, extending your network and accessing resources on it. Similarly, it can be a tunnel through public networks to connect remote infrastructures together. This creates further security through segmenting network traffic and preventing outside sources from accessing it.

Securing traffic between services through encryption protects the data from easy interception and reading.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Impact:

If an Azure Virtual Network is not implemented correctly, this may result in the loss of critical network traffic.

Private endpoints are charged per hour of use. Refer to

https://azure.microsoft.com/en-us/pricing/details/private-link/

and

https://azure.microsoft.com/en-us/pricing/calculator/

to estimate potential costs."
  reference   : "800-171|3.4.6,800-171|3.4.7,800-171|3.13.1,800-171|3.13.2,800-171|3.13.5,800-171r3|03.04.06,800-171r3|03.13.01,800-171r3|03.16.01,800-53|CM-7,800-53|CP-6,800-53|CP-7,800-53|PL-8,800-53|PM-7,800-53|SA-8,800-53|SC-7,800-53r5|CM-7,800-53r5|CP-6,800-53r5|CP-7,800-53r5|PL-8,800-53r5|PM-7,800-53r5|SA-8,800-53r5|SC-7,CN-L3|8.1.10.6(j),CSCv7|14.1,CSCv8|12.2,CSF|DE.CM-1,CSF|ID.AM-3,CSF|PR.AC-5,CSF|PR.DS-5,CSF|PR.IP-1,CSF|PR.IP-2,CSF|PR.IP-4,CSF|PR.PT-3,CSF|PR.PT-4,CSF2.0|DE.CM-01,CSF2.0|ID.AM-03,CSF2.0|ID.AM-08,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.DS-11,CSF2.0|PR.IR-01,CSF2.0|PR.IR-03,CSF2.0|PR.IR-04,CSF2.0|PR.PS-01,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.c,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.5.8,ISO-27001-2022|A.5.14,ISO-27001-2022|A.5.29,ISO-27001-2022|A.7.5,ISO-27001-2022|A.8.14,ISO-27001-2022|A.8.16,ISO-27001-2022|A.8.20,ISO-27001-2022|A.8.27,ISO-27001-2022|A.8.28,ISO/IEC-27001|A.13.1.3,ITSG-33|CM-7,ITSG-33|CP-6,ITSG-33|CP-7,ITSG-33|SA-8,ITSG-33|SA-8a.,ITSG-33|SC-7,LEVEL|2A,NESA|T2.2.4,NESA|T3.4.1,NESA|T4.5.3,NESA|T4.5.4,NESA|T7.6.5,NIAv2|GS1,NIAv2|GS2a,NIAv2|GS2b,NIAv2|SS3,NIAv2|SS15a,NIAv2|VL2,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv3.2.1|2.2.2,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,SWIFT-CSCv1|2.3,TBA-FIISB|43.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "3.1.3 Ensure that traffic is encrypted between cluster worker nodes"
  info        : "By default, data exchanged between worker nodes in an Azure Databricks cluster is not encrypted. To ensure that data is encrypted at all times, whether at rest or in transit, you can create an initialization script that configures your clusters to encrypt traffic between worker nodes using AES 256-bit encryption over a TLS 1.3 connection.

 - Protects sensitive data during transit between cluster nodes, mitigating risks of data interception or unauthorized access.
 - Aligns with organizational security policies and compliance requirements that mandate encryption of data in transit.
 - Enhances overall security posture by ensuring that all inter-node communications within the cluster are encrypted.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Create a JKS keystore:

 - Generate a Java KeyStore (JKS) file that will be used for SSL/TLS encryption.
 - Upload the keystore file to a secure directory in DBFS (e.g. /dbfs//jetty_ssl_driver_keystore.jks).

Develop an init script:

<xhtml:ol start=\"3\"> - Create an init script that performs the following tasks:
 - Retrieves the JKS keystore file and password.
 - Derives a shared encryption secret from the keystore.
 - Configures Spark driver and executor settings to enable encryption.

 - Example init script: #!/bin/bashset -euo pipefailkeystore_dbfs_file=\"/dbfs/<keystore-directory>/jetty_ssl_driver_keystore.jks\"max_attempts=30while [ ! -f ${keystore_dbfs_file} ]; do if [ \"$max_attempts\" == 0 ]; then echo \"ERROR: Unable to find the file : $keystore_dbfs_file. Failing the script.\" exit 1 fi sleep 2s ((max_attempts--))donesasl_secret=$(sha256sum $keystore_dbfs_file | cut -d' ' -f1)if [ -z \"${sasl_secret}\" ]; then echo \"ERROR: Unable to derive the secret. Failing the script.\" exit 1filocal_keystore_file=\"$DB_HOME/keys/jetty_ssl_driver_keystore.jks\"local_keystore_password=\"gb1gQqZ9ZIHS\"if [[ $DB_IS_DRIVER = \"TRUE\" ]]; then driver_conf=${DB_HOME}/driver/conf/spark-branch.conf echo \"Configuring driver conf at $driver_conf\" if [ ! -e $driver_conf ]; then echo \"spark.authenticate true\" >> $driver_conf echo \"spark.authenticate.secret $sasl_secret\" >> $driver_conf echo \"spark.authenticate.enableSaslEncryption true\" >> $driver_conf echo \"spark.network.crypto.enabled true\" >> $driver_conf echo \"spark.network.crypto.keyLength 256\" >> $driver_conf echo \"spark.network.crypto.keyFactoryAlgorithm PBKDF2WithHmacSHA1\" >> $driver_conf echo \"spark.io.encryption.enabled true\" >> $driver_conf echo \"spark.ssl.enabled true\" >> $driver_conf echo \"spark.ssl.keyPassword $local_keystore_password\" >> $driver_conf echo \"spark.ssl.keyStore $local_keystore_file\" >> $driver_conf echo \"spark.ssl.keyStorePassword $local_keystore_password\" >> $driver_conf echo \"spark.ssl.protocol TLSv1.3\" >> $driver_conf fifiexecutor_conf=${DB_HOME}/conf/spark.executor.extraJavaOptionsecho \"Configuring executor conf at $executor_conf\"if [ ! -e $executor_conf ]; then echo \"-Dspark.authenticate=true\" >> $executor_conf echo \"-Dspark.authenticate.secret=$sasl_secret\" >> $executor_conf echo \"-Dspark.authenticate.enableSaslEncryption=true\" >> $executor_conf echo \"-Dspark.network.crypto.enabled=true\" >> $executor_conf echo \"-Dspark.network.crypto.keyLength=256\" >> $executor_conf echo \"-Dspark.network.crypto.keyFactoryAlgorithm=PBKDF2WithHmacSHA1\" >> $executor_conf echo \"-Dspark.io.encryption.enabled=true\" >> $executor_conf echo \"-Dspark.ssl.enabled=true\" >> $executor_conf echo \"-Dspark.ssl.keyPassword=$local_keystore_password\" >> $executor_conf echo \"-Dspark.ssl.keyStore=$local_keystore_file\" >> $executor_conf echo \"-Dspark.ssl.keyStorePassword=$local_keystore_password\" >> $executor_conf echo \"-Dspark.ssl.protocol=TLSv1.3\" >> $executor_conffi
 - Save.

Impact:

 - Enabling encryption may introduce a performance penalty due to the computational overhead associated with encrypting and decrypting traffic. This can result in longer query execution times, especially for data-intensive operations.
 - Implementing encryption requires creating and managing init scripts, which adds complexity to cluster configuration and maintenance.
 - The shared encryption secret is derived from the hash of the keystore stored in DBFS. If the keystore is updated or rotated, all running clusters must be restarted to prevent authentication failures between Spark workers and drivers."
  reference   : "800-171|3.1.13,800-171|3.5.2,800-171|3.13.8,800-171r3|03.05.07,800-171r3|03.05.12,800-171r3|03.13.08,800-53|AC-17(2),800-53|IA-5,800-53|IA-5(1),800-53|SC-8,800-53|SC-8(1),800-53r5|AC-17(2),800-53r5|IA-5,800-53r5|IA-5(1),800-53r5|SC-8,800-53r5|SC-8(1),CN-L3|7.1.2.7(g),CN-L3|7.1.3.1(d),CN-L3|8.1.2.2(a),CN-L3|8.1.2.2(b),CN-L3|8.1.4.1(c),CN-L3|8.1.4.7(a),CN-L3|8.1.4.8(a),CN-L3|8.2.4.5(c),CN-L3|8.2.4.5(d),CN-L3|8.5.2.2,CSCv7|14.4,CSCv8|3.10,CSF|PR.AC-1,CSF|PR.AC-3,CSF|PR.DS-2,CSF|PR.DS-5,CSF|PR.PT-4,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.AA-05,CSF2.0|PR.DS-02,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),HIPAA|164.312(e)(1),HIPAA|164.312(e)(2)(i),ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.14,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.17,ISO-27001-2022|A.5.33,ISO-27001-2022|A.6.7,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.6.2.2,ISO/IEC-27001|A.10.1.1,ISO/IEC-27001|A.13.2.3,ITSG-33|AC-17(2),ITSG-33|IA-5,ITSG-33|IA-5(1),ITSG-33|SC-8,ITSG-33|SC-8a.,ITSG-33|SC-8(1),LEVEL|2M,NESA|T4.3.1,NESA|T4.3.2,NESA|T4.5.1,NESA|T4.5.2,NESA|T5.2.3,NESA|T5.4.2,NESA|T7.3.3,NESA|T7.4.1,NIAv2|AM37,NIAv2|IE8,NIAv2|IE9,NIAv2|IE12,NIAv2|NS5d,NIAv2|NS6b,NIAv2|NS29,NIAv2|SS24,PCI-DSSv3.2.1|2.3,PCI-DSSv3.2.1|4.1,PCI-DSSv4.0|2.2.7,PCI-DSSv4.0|4.2.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|2.1,SWIFT-CSCv1|2.6,SWIFT-CSCv1|4.1,TBA-FIISB|29.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<custom_item>
  description    : "3.1.8 Ensure that data at rest and in transit is encrypted in Azure Databricks using customer managed keys (CMK)"
  info           : "Azure Databricks encrypts data in transit using TLS 1.2+ to secure API, workspace, and cluster communications. By default, data at rest is encrypted using Microsoft-managed keys.

Organizations with stricter needs for control of encryption keys should enable customer-managed keys (CMK) for greater control over data encryption, auditing, and regulatory compliance. Azure Key Vault should be used to store and manage CMKs.

Enforcing encryption at rest and in transit in Azure Databricks:

 - Protects sensitive data from unauthorized access.
 - Ensures regulatory compliance (ISO 27001, GDPR, HIPAA, SOC 2).
 - Allows key revocation and rotation control with customer-managed keys (CMK).
 - Mitigates insider threats by preventing unauthorized access to raw storage."
  solution       : "NOTE: These remediations assume that an Azure KeyVault already exists in the subscription.

Remediate from Azure CLI

 - Create a dedicated key:

az keyvault key create --vault-name <keyvault-name> --name <key-name> --protection <\"software\" or \"hsm\"> <xhtml:ol start=\"2\"> - Assign permissions to Databricks:

az keyvault set-policy --name <keyvault-name> --resource-group <resource-group-name> --spn <databricks-spn> --key-permissions get wrapKey unwrapKey <xhtml:ol start=\"3\"> - Enable encryption with CMK:

az databricks workspace update --name <databricks-workspace-name> --resource-group <resource-group-name> --key-source \"Microsoft.KeyVault\" --key-name <key-name> --keyvault-uri <keyvault-uri>

Remediate from PowerShell

$Key = Add-AzKeyVaultKey -VaultName <keyvault-name> -Name <key-name> -Destination <\"software\" or \"hsm\">
Set-AzDatabricksWorkspace -ResourceGroupName \"<resource-group-name>\" -WorkspaceName \"<databricks-workspace-name>\" -EncryptionKeySource \"Microsoft.KeyVault\" -KeyVaultUri $Key.Id

Impact:

Enabling CMK encryption requires additional configuration. Key management introduces maintenance overhead (rotation, revocation, lifecycle management). Potential access issues will be encountered if keys are deleted or rotated incorrectly."
  reference      : "800-171|3.1.13,800-171|3.5.2,800-171|3.13.8,800-171|3.13.16,800-171r3|03.05.07,800-171r3|03.05.12,800-171r3|03.13.08,800-53|AC-17(2),800-53|IA-5,800-53|IA-5(1),800-53|SC-8,800-53|SC-8(1),800-53|SC-28,800-53|SC-28(1),800-53r5|AC-17(2),800-53r5|IA-5,800-53r5|IA-5(1),800-53r5|SC-8,800-53r5|SC-8(1),800-53r5|SC-28,800-53r5|SC-28(1),CN-L3|7.1.2.7(g),CN-L3|7.1.3.1(d),CN-L3|8.1.2.2(a),CN-L3|8.1.2.2(b),CN-L3|8.1.4.1(c),CN-L3|8.1.4.7(a),CN-L3|8.1.4.7(b),CN-L3|8.1.4.8(a),CN-L3|8.1.4.8(b),CN-L3|8.2.4.5(c),CN-L3|8.2.4.5(d),CN-L3|8.5.2.2,CSCv7|14.4,CSCv7|14.8,CSCv8|3.10,CSCv8|3.11,CSF|PR.AC-1,CSF|PR.AC-3,CSF|PR.DS-1,CSF|PR.DS-2,CSF|PR.DS-5,CSF|PR.PT-4,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.AA-05,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(d),HIPAA|164.312(e)(1),HIPAA|164.312(e)(2)(i),HIPAA|164.312(e)(2)(ii),ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.14,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.17,ISO-27001-2022|A.5.33,ISO-27001-2022|A.6.7,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.6.2.2,ISO/IEC-27001|A.10.1.1,ISO/IEC-27001|A.13.2.3,ITSG-33|AC-17(2),ITSG-33|IA-5,ITSG-33|IA-5(1),ITSG-33|SC-8,ITSG-33|SC-8a.,ITSG-33|SC-8(1),ITSG-33|SC-28,ITSG-33|SC-28a.,ITSG-33|SC-28(1),LEVEL|2A,NESA|T4.3.1,NESA|T4.3.2,NESA|T4.5.1,NESA|T4.5.2,NESA|T5.2.3,NESA|T5.4.2,NESA|T7.3.3,NESA|T7.4.1,NIAv2|AM37,NIAv2|IE8,NIAv2|IE9,NIAv2|IE12,NIAv2|NS5d,NIAv2|NS6b,NIAv2|NS29,NIAv2|SS24,PCI-DSSv3.2.1|2.3,PCI-DSSv3.2.1|3.4,PCI-DSSv3.2.1|4.1,PCI-DSSv4.0|2.2.7,PCI-DSSv4.0|3.3.2,PCI-DSSv4.0|3.5.1,PCI-DSSv4.0|4.2.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|2.1,SWIFT-CSCv1|2.6,SWIFT-CSCv1|4.1,TBA-FIISB|28.1,TBA-FIISB|29.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listDatabricks"
  json_transform : '.[] | .subscriptionId as $subid | [ .resourceGroups[].value[] | select(.properties.encryption.entities.managedDisk.keySource? != "Microsoft.Keyvault") | { "name": .name } ] | if (.[] | length) == 0 then "Subscription ID: \($subid) - no Databricks Workspaces or Workspaces without encryption" else (.[] | "Subscription ID: \($subid), Workspace: \(.name) does not have disk encryption properly configured") end'
  regex          : ".+"
  not_expect     : "does not have disk encryption properly configured"
</custom_item>

<report type:"WARNING">
  description : "4.1.1 Ensure only MFA enabled identities can access privileged Virtual Machine"
  info        : "Verify identities without MFA that can log in to a privileged virtual machine using separate login credentials. An adversary can leverage the access to move laterally and perform actions with the virtual machine's managed identity. Make sure the virtual machine only has necessary permissions, and revoke the admin-level permissions according to the principle of least privilege.

Integrating multi-factor authentication (MFA) as part of the organizational policy can greatly reduce the risk of an identity gaining control of valid credentials that may be used for additional tactics such as initial access, lateral movement, and collecting information. MFA can also be used to restrict access to cloud resources and APIs.

An Adversary may log into accessible cloud services within a compromised environment using Valid Accounts that are synchronized to move laterally and perform actions with the virtual machine's managed identity. The adversary may then perform management actions or access cloud-hosted resources as the logged-on managed identity.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - Log in to the Azure portal.
 - This can be remediated by enabling MFA for user, Removing user access or Reducing access of managed identities attached to virtual machines.

 -

Case I : Enable MFA for users having access on virtual machines.

 - Go to Microsoft Entra ID
 - For Per-user MFA :
 - Under Manage click Users
 - Click Per-user MFA
 - For each user requiring remediation, check the box next to their name.
 - Click Enable MFA
 - Click Enable

 - For Conditional Access :
 - Under Manage click Security
 - Under Protect click Conditional Access
 - Update the Conditional Access policy requiring MFA for all users, removing each user requiring remediation from the Exclude list.

 -

Case II : Removing user access on a virtual machine.

 - Select the Subscription then click on Access control (IAM)
 - Select Role assignments and search for Virtual Machine Administrator Login or Virtual Machine User Login or any role that provides access to log into virtual machines.
 - Click on Role Name Select Assignments and remove identities with no MFA configured.

 -

Case III : Reducing access of managed identities attached to virtual machines.

 - Select the Subscription then click on Access control (IAM)
 - Select Role Assignments from the top menu and apply filters on Assignment type as Privileged administrator roles and Type as Virtual Machines
 - Click on Role Name Select Assignments and remove identities access make sure this follows the least privileges principal.

Impact:

This recommendation requires the Entra ID P2 license to implement.

Ensure that identities provisioned to a virtual machine utilize an RBAC/ABAC group and are allocated a role using Azure PIM, and that the role settings require MFA or use another third-party PAM solution for accessing virtual machines."
  reference   : "800-171|3.5.3,800-171r3|03.05.03,800-53|IA-2(1),800-53r5|IA-2(1),CN-L3|7.1.2.7(b),CSCv7|4.5,CSCv8|6.5,CSF|PR.AC-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ISO-27001-2022|A.5.16,ITSG-33|IA-2(1),LEVEL|2M,NESA|T5.4.2,NIAv2|AM36,NIAv2|VL3c,QCSC-v1|5.2.2,QCSC-v1|13.2,SWIFT-CSCv1|1.2,TBA-FIISB|35.1,TBA-FIISB|36.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<custom_item>
  description    : "6.13 Ensure that 'User consent for applications' is set to 'Allow user consent for apps from verified publishers, for selected permissions'"
  info           : "Allow users to provide consent for selected permissions when a request is coming from a verified publisher.

If Microsoft Entra ID is running as an identity provider for third-party applications, permissions and consent should be limited to administrators or pre-approved. Malicious applications may attempt to exfiltrate data or abuse privileged user accounts.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
  solution       : "Remediate from Azure Portal

 - From Azure Home select the Portal Menu
 - Select Microsoft Entra ID
 - Under Manage select Enterprise applications
 - Under Security, select Consent and permissions`
 - Under Manage select User consent settings
 - Under User consent for applications select Allow user consent for apps from verified publishers, for selected permissions
 - Click Save

Impact:

Enforcing this setting may create additional requests that administrators need to review."
  reference      : "800-171|3.4.1,800-171|3.4.7,800-171|3.4.8,800-171|3.4.9,800-171r3|03.04.06,800-171r3|03.04.08,800-171r3|03.04.10,800-53|CM-7(2),800-53|CM-7(5),800-53|CM-8(3),800-53|CM-10,800-53|CM-11,800-53r5|CM-7(2),800-53r5|CM-7(5),800-53r5|CM-8(3),800-53r5|CM-10,800-53r5|CM-11,CN-L3|8.1.10.2(a),CN-L3|8.1.10.2(b),CSCv7|2.6,CSCv7|2.7,CSCv8|2.3,CSCv8|2.5,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.IP-1,CSF|PR.PT-3,CSF2.0|DE.CM-03,CSF2.0|DE.CM-09,CSF2.0|ID.AM-01,CSF2.0|ID.AM-02,CSF2.0|PR.PS-01,CSF2.0|PR.PS-02,GDPR|32.1.b,HIPAA|164.306(a)(1),ISO-27001-2022|A.5.9,ISO-27001-2022|A.5.32,ISO-27001-2022|A.8.9,ISO-27001-2022|A.8.19,ISO/IEC-27001|A.12.5.1,ISO/IEC-27001|A.12.6.2,ITSG-33|CM-7,ITSG-33|CM-7(2),ITSG-33|CM-8(3),LEVEL|2M,NESA|T1.2.1,NESA|T1.2.2,NIAv2|SS15a,PCI-DSSv3.2.1|2.2.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,SWIFT-CSCv1|2.3,SWIFT-CSCv1|5.1,TBA-FIISB|44.2.2,TBA-FIISB|49.2.3"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listAuthorizationPolicy"
  json_transform : 'if (.defaultUserRolePermissions.permissionGrantPoliciesAssigned | length) == 0 then "No permissionGrantPoliciesAssigned entries found" else (.defaultUserRolePermissions.permissionGrantPoliciesAssigned[] | "Permission Grant Policy assigned: \(.)") end'
  regex          : ".+"
  expect         : "^Manual Review Required$"
  severity       : MEDIUM
</custom_item>

<custom_item>
  description    : "6.16 Ensure that 'Guest invite restrictions' is set to 'Only users assigned to specific admin roles can invite guest users'"
  info           : "Restrict invitations to users with specific administrative roles only.

Restricting invitations to users with specific administrator roles ensures that only authorized accounts have access to cloud resources. This helps to maintain \"Need to Know\" permissions and prevents inadvertent access to data.

By default the setting Guest invite restrictions is set to Anyone in the organization can invite guest users including guests and non-admins This would allow anyone within the organization to invite guests and non-admins to the tenant, posing a security risk."
  solution       : "Remediate from Azure Portal

 - From Azure Home select the Portal Menu
 - Select Microsoft Entra ID
 - Under Manage select External Identities
 - Select External collaboration settings
 - Under Guest invite settings set Guest invite restrictions to Only users assigned to specific admin roles can invite guest users
 - Click Save

Remediate from Powershell

Enter the following:

Connect-MgGraph
Update-MgPolicyAuthorizationPolicy -AllowInvitesFrom \"adminsAndGuestInviters\"

Impact:

With the option of Only users assigned to specific admin roles can invite guest users selected, users with specific admin roles will be in charge of sending invitations to the external users, requiring additional overhead by them to manage user accounts. This will mean coordinating with other departments as they are onboarding new users."
  reference      : "800-171|3.1.1,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-171|3.5.2,800-171|3.5.5,800-171|3.5.6,800-171r3|03.01.01,800-171r3|03.01.02,800-171r3|03.01.05,800-171r3|03.01.05a.,800-171r3|03.01.05b.,800-171r3|03.03.08b.,800-171r3|03.05.05,800-171r3|03.05.12,800-171r3|03.15.01,800-53|AC-1,800-53|AC-2,800-53|AC-3,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53|IA-4,800-53|IA-5,800-53r5|AC-1,800-53r5|AC-2,800-53r5|AC-2(1),800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),800-53r5|IA-4,800-53r5|IA-5,CN-L3|7.1.2.7(b),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(e),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.1.10.6(c),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|16.2,CSCv8|6.1,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|ID.GV-1,CSF|ID.GV-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|GV.OC-03,CSF2.0|GV.OV-01,CSF2.0|GV.PO-01,CSF2.0|GV.PO-02,CSF2.0|GV.SC-03,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(b),HIPAA|164.312(d),ISO-27001-2022|A.5.1,ISO-27001-2022|A.5.2,ISO-27001-2022|A.5.4,ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.17,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.31,ISO-27001-2022|A.5.33,ISO-27001-2022|A.5.36,ISO-27001-2022|A.5.37,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.15,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO-27001-2022|5.2,ISO-27001-2022|5.3,ISO-27001-2022|7.5.1,ISO-27001-2022|7.5.2,ISO-27001-2022|7.5.3,ISO/IEC-27001|A.9.1.1,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-1,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),ITSG-33|IA-4,ITSG-33|IA-5,LEVEL|2A,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.2.3,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM29,NIAv2|AM30,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listAuthorizationPolicy"
  json_transform : '"Authorization Policy AllowInvitesFrom is set to \(.allowInvitesFrom)"'
  regex          : ".+"
  expect         : "Authorization Policy AllowInvitesFrom is set to (adminsAndGuestInviters|none)"
</custom_item>

<report type:"WARNING">
  description : "6.18 Ensure that 'Restrict user ability to access groups features in My Groups' is set to 'Yes'"
  info        : "Restrict access to group web interface in the Access Panel portal.

Self-service group management enables users to create and manage security groups or Office 365 groups in Microsoft Entra ID. Unless a business requires this day-to-day delegation for some users, self-service group management should be disabled. Any user can access the Access Panel, where they can reset their passwords, view their information, etc. By default, users are also allowed to access the Group feature, which shows groups, members, related resources (SharePoint URL, Group email address, Yammer URL, and Teams URL). By setting this feature to 'Yes', users will no longer have access to the web interface, but still have access to the data using the API. This is useful to prevent non-technical users from enumerating groups-related information, but technical users will still be able to access this information using APIs.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - From Azure Home select the Portal Menu
 - Select Microsoft Entra ID
 - Under Manage select Groups
 - Under Settings select General
 - Under Self Service Group Management set Restrict user ability to access groups features in My Groups to Yes
 - Click Save

Impact:

Setting to Yes could create administrative overhead by customers seeking certain group memberships that will have to be manually managed by administrators with appropriate permissions."
  reference   : "800-171|3.1.1,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-171r3|03.01.01,800-171r3|03.01.02,800-171r3|03.01.05,800-171r3|03.01.05a.,800-171r3|03.01.05b.,800-171r3|03.03.08b.,800-53|AC-2,800-53|AC-3,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53r5|AC-2,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.33,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.15,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),LEVEL|2M,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "6.19 Ensure that 'Users can create security groups in Azure portals, API or PowerShell' is set to 'No'"
  info        : "Restrict security group creation to administrators only.

When creating security groups is enabled, all users in the directory are allowed to create new security groups and add members to those groups. Unless a business requires this day-to-day delegation, security group creation should be restricted to administrators only.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - From Azure Home select the Portal Menu
 - Select Microsoft Entra ID
 - Under Manage select Groups
 - Under Settings select General
 - Under Security Groups set Users can create security groups in Azure portals, API or PowerShell to No
 - Click Save

Impact:

Enabling this setting could create a number of requests that would need to be managed by an administrator."
  reference   : "800-171|3.1.1,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-171r3|03.01.01,800-171r3|03.01.02,800-171r3|03.01.05,800-171r3|03.01.05a.,800-171r3|03.01.05b.,800-171r3|03.03.08b.,800-53|AC-2,800-53|AC-3,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53r5|AC-2,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.33,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.15,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),LEVEL|2M,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "6.20 Ensure that 'Owners can manage group membership requests in My Groups' is set to 'No'"
  info        : "Restrict security group management to administrators only.

Restricting security group management to administrators only prohibits users from making changes to security groups. This ensures that security groups are appropriately managed and their management is not delegated to non-administrators.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - From Azure Home select the Portal Menu
 - Select Microsoft Entra ID
 - Under Manage select Groups
 - Under Settings select General
 - Under Self Service Group Management set Owners can manage group membership requests in My Groups to No
 - Click Save

Impact:

Group Membership for user accounts will need to be handled by Admins and cause administrative overhead."
  reference   : "800-171|3.1.1,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-171r3|03.01.01,800-171r3|03.01.02,800-171r3|03.01.05,800-171r3|03.01.05a.,800-171r3|03.01.05b.,800-171r3|03.03.08b.,800-53|AC-2,800-53|AC-3,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53r5|AC-2,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.33,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.15,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),LEVEL|2M,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<custom_item>
  description    : "6.2.1 Ensure that 'trusted locations' are defined"
  info           : "Microsoft Entra ID Conditional Access allows an organization to configure Named locations and configure whether those locations are trusted or untrusted. These settings provide organizations the means to specify Geographical locations for use in conditional access policies, or define actual IP addresses and IP ranges and whether or not those IP addresses and/or ranges are trusted by the organization.

Defining trusted source IP addresses or ranges helps organizations create and enforce Conditional Access policies around those trusted or untrusted IP addresses and ranges. Users authenticating from trusted IP addresses and/or ranges may have less access restrictions or access requirements when compared to users that try to authenticate to Microsoft Entra ID from untrusted locations or untrusted source IP addresses/ranges."
  solution       : "Remediate from Azure Portal

 - In the Azure Portal, navigate to Microsoft Entra ID
 - Under Manage click Security
 - Under Protect click Conditional Access
 - Under Manage click Named locations
 - Within the Named locations blade, click on IP ranges location
 - Enter a name for this location setting in the Name text box
 - Click on the + sign
 - Add an IP Address Range in CIDR notation inside the text box that appears
 - Click on the Add button
 - Repeat steps 7 through 9 for each IP Range that needs to be added
 - If the information entered are trusted ranges, select the Mark as trusted location check box
 - Once finished, click on Create

Remediate from PowerShell

Create a new trusted IP-based Named location policy

[System.Collections.Generic.List`1[Microsoft.Open.MSGraph.Model.IpRange]]$ipRanges = @()
$ipRanges.Add(\"<first IP range in CIDR notation>\")
$ipRanges.Add(\"<second IP range in CIDR notation>\")
$ipRanges.Add(\"<third IP range in CIDR notation>\")
New-MgIdentityConditionalAccessNamedLocation -dataType \"#microsoft.graph.ipNamedLocation\" -DisplayName \"<name of IP Named location policy>\" -IsTrusted $true -IpRanges $ipRanges

Set an existing IP-based Named location policy to trusted

Update-MgIdentityConditionalAccessNamedLocation -PolicyId \"<ID of the policy>\" -dataType \"#microsoft.graph.ipNamedLocation\" -IsTrusted $true

Impact:

When configuring Named locations the organization can create locations using Geographical location data or by defining source IP addresses or ranges. Configuring Named locations using a Country location does not provide the organization the ability to mark those locations as trusted, and any Conditional Access policy relying on those Countries location setting will not be able to use the All trusted locations setting within the Conditional Access policy. They instead will have to rely on the Select locations setting. This may add additional resource requirements when configuring and will require thorough organizational testing.

In general, Conditional Access policies may completely prevent users from authenticating to Microsoft Entra ID, and thorough testing is recommended. To avoid complete lockout, a 'Break Glass' account with full Global Administrator rights is recommended in the event all other administrators are locked out of authenticating to Microsoft Entra ID. This 'Break Glass' account should be excluded from Conditional Access Policies and should be configured with the longest pass phrase feasible in addition to a FIDO2 security key or certificate kept in a very secure physical location. This account should only be used in the event of an emergency and complete administrator lockout.

NOTE: Starting July 2024, Microsoft will begin requiring MFA for All Users - including Break Glass Accounts. By the end of October 2024, this requirement will be enforced. Physical FIDO2 security keys, or a certificate kept on secure removable storage can fulfill this MFA requirement. If opting for a physical device, that device should be kept in a very secure, documented physical location."
  reference      : "800-171|3.1.1,800-171|3.4.6,800-171|3.4.7,800-171|3.13.1,800-171|3.13.2,800-171|3.13.5,800-171r3|03.01.01,800-171r3|03.01.02,800-171r3|03.04.06,800-171r3|03.13.01,800-171r3|03.16.01,800-53|AC-2(1),800-53|AC-3,800-53|CM-7,800-53|CP-6,800-53|CP-7,800-53|PL-8,800-53|PM-7,800-53|SA-8,800-53|SC-7,800-53r5|AC-2(1),800-53r5|AC-3,800-53r5|CM-7,800-53r5|CP-6,800-53r5|CP-7,800-53r5|PL-8,800-53r5|PM-7,800-53r5|SA-8,800-53r5|SC-7,CN-L3|7.1.3.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(j),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|11.1,CSCv8|6.7,CSCv8|12.2,CSF|DE.CM-1,CSF|ID.AM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.AC-5,CSF|PR.DS-5,CSF|PR.IP-1,CSF|PR.IP-2,CSF|PR.IP-4,CSF|PR.PT-3,CSF|PR.PT-4,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|ID.AM-03,CSF2.0|ID.AM-08,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.DS-11,CSF2.0|PR.IR-01,CSF2.0|PR.IR-03,CSF2.0|PR.IR-04,CSF2.0|PR.PS-01,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.c,GDPR|32.1.d,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO-27001-2022|A.5.8,ISO-27001-2022|A.5.14,ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.29,ISO-27001-2022|A.5.33,ISO-27001-2022|A.7.5,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.14,ISO-27001-2022|A.8.16,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO-27001-2022|A.8.27,ISO-27001-2022|A.8.28,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.13.1.3,ITSG-33|AC-2(1),ITSG-33|AC-3,ITSG-33|CM-7,ITSG-33|CP-6,ITSG-33|CP-7,ITSG-33|SA-8,ITSG-33|SA-8a.,ITSG-33|SC-7,LEVEL|2M,NESA|T2.2.4,NESA|T3.4.1,NESA|T4.2.1,NESA|T4.5.3,NESA|T4.5.4,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NESA|T7.6.5,NIAv2|AM3,NIAv2|AM28,NIAv2|GS1,NIAv2|GS2a,NIAv2|GS2b,NIAv2|NS5j,NIAv2|SS3,NIAv2|SS14e,NIAv2|SS15a,NIAv2|SS29,NIAv2|VL2,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv3.2.1|2.2.2,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|2.3,TBA-FIISB|31.1,TBA-FIISB|43.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listNamedLocations"
  json_transform : 'if (.[] | length) == 0 then "No Named Locations defined" else (.[] | .displayName as $displayName | .id as $id | .isTrusted as $isTrusted | .ipRanges[] | .cidrAddress as $cidrAddress | "DisplayName: \($displayName), ID: \($id), IsTrusted: \($isTrusted), IPRange: \($cidrAddress)") end'
  regex          : ".+"
  expect         : "IsTrusted: true"
</custom_item>

<report type:"WARNING">
  description : "6.21 Ensure that 'Users can create Microsoft 365 groups in Azure portals, API or PowerShell' is set to 'No'"
  info        : "Restrict Microsoft 365 group creation to administrators only.

Restricting Microsoft 365 group creation to administrators only ensures that creation of Microsoft 365 groups is controlled by the administrator. Appropriate groups should be created and managed by the administrator and group creation rights should not be delegated to any other user.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - From Azure Home select the Portal Menu
 - Select Microsoft Entra ID
 - Under Manage select Groups
 - Under Settings select General
 - Under Microsoft 365 Groups set Users can create Microsoft 365 groups in Azure portals, API or PowerShell to No
 - Click Save

Impact:

Enabling this setting could create a number of requests that would need to be managed by an administrator."
  reference   : "800-171|3.1.1,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-171r3|03.01.01,800-171r3|03.01.02,800-171r3|03.01.05,800-171r3|03.01.05a.,800-171r3|03.01.05b.,800-171r3|03.03.08b.,800-53|AC-2,800-53|AC-3,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53r5|AC-2,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.33,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.15,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),LEVEL|2M,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "6.2.2 Ensure that an exclusionary geographic Conditional Access policy is considered"
  info        : "CAUTION : If these policies are created without first auditing and testing the result, misconfiguration can potentially lock out administrators or create undesired access issues.

Conditional Access Policies can be used to block access from geographic locations that are deemed out-of-scope for your organization or application. The scope and variables for this policy should be carefully examined and defined.

Conditional Access, when used as a deny list for the tenant or subscription, is able to prevent ingress or egress of traffic to countries that are outside of the scope of interest (e.g.: customers, suppliers) or jurisdiction of an organization. This is an effective way to prevent unnecessary and long-lasting exposure to international threats such as APTs.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

Part 1 of 2 - Create the policy and enable it in Report-only mode.

 - From Azure Home open the portal menu in the top left, and select Microsoft Entra ID
 - Scroll down in the menu on the left, and select Security
 - Select on the left side Conditional Access
 - Select Policies
 - Click the + New policy button, then:
 - Provide a name for the policy.
 - Under Assignments select Users then:
 - Under Include select All users
 - Under Exclude check Users and groups and only select emergency access accounts and service accounts ( NOTE : Service accounts are excluded here because service accounts are non-interactive and cannot complete MFA)

 - Under Assignments select Target resources then:
 - Under Include select All cloud apps
 - Leave Exclude blank unless you have a well defined exception

 - Under Conditions select Locations then:
 - Select Include then add entries for locations for those that should be blocked
 - Select Exclude then add entries for those that should be allowed ( IMPORTANT : Ensure that all Trusted Locations are in the Exclude list.)

 - Under Access Controls select Grant select Block Access
 - Set Enable policy to Report-only
 - Click Create

Allow some time to pass to ensure the sign-in logs capture relevant conditional access events. These events will need to be reviewed to determine if additional considerations are necessary for your organization (e.g. legitimate locations are being blocked and investigation is needed for exception).

NOTE: The policy is not yet 'live,' since Report-only is being used to audit the effect of the policy.

Part 2 of 2 - Confirm that the policy is not blocking access that should be granted, then toggle to On

 - With your policy now in report-only mode, return to the Microsoft Entra blade and click on Sign-in logs
 - Review the recent sign-in events - click an event then review the event details (specifically the Report-only tab) to ensure:
 - The sign-in event you're reviewing occurred after turning on the policy in report-only mode
 - The policy name from step 6 above is listed in the Policy Name column
 - The Result column for the new policy shows that the policy was Not applied (indicating the location origin was not blocked)

 - If the above conditions are present, navigate back to the policy name in Conditional Access and open it.
 - Toggle the policy from Report-only to On
 - Click Save

Remediate from PowerShell

First, set up the conditions objects values before updating an existing conditional access policy or before creating a new one. You may need to use additional PowerShell cmdlets to retrieve specific IDs such as the Get-MgIdentityConditionalAccessNamedLocation which outputs the Location IDs for use with conditional access policies.

$conditions = New-Object -TypeName Microsoft.Open.MSGraph.Model.ConditionalAccessConditionSet

$conditions.Applications = New-Object -TypeName Microsoft.Open.MSGraph.Model.ConditionalAccessApplicationCondition
$conditions.Applications.IncludeApplications = <\"All\" | \"Office365\" | \"app ID\" | @(\"app ID 1\", \"app ID 2\", etc...>
$conditions.Applications.ExcludeApplications = <\"Office365\" | \"app ID\" | @(\"app ID 1\", \"app ID 2\", etc...)>

$conditions.Users = New-Object -TypeName Microsoft.Open.MSGraph.Model.ConditionalAccessUserCondition
$conditions.Users.IncludeUsers = <\"All\" | \"None\" | \"GuestsOrExternalUsers\" | \"Specific User ID\" | @(\"User ID 1\", \"User ID 2\", etc.)>
$conditions.Users.ExcludeUsers = <\"GuestsOrExternalUsers\" | \"Specific User ID\" | @(\"User ID 1\", \"User ID 2\", etc.)>
$conditions.Users.IncludeGroups = <\"group ID\" | \"All\" | @(\"Group ID 1\", \"Group ID 2\", etc...)>
$conditions.Users.ExcludeGroups = <\"group ID\" | @(\"Group ID 1\", \"Group ID 2\", etc...)>
$conditions.Users.IncludeRoles = <\"Role ID\" | \"All\" | @(\"Role ID 1\", \"Role ID 2\", etc...)>
$conditions.Users.ExcludeRoles = <\"Role ID\" | @(\"Role ID 1\", \"Role ID 2\", etc...)>

$conditions.Locations = New-Object -TypeName Microsoft.Open.MSGraph.Model.ConditionalAccessLocationCondition
$conditions.Locations.IncludeLocations = <\"Location ID\" | @(\"Location ID 1\", \"Location ID 2\", etc...) >
$conditions.Locations.ExcludeLocations = <\"AllTrusted\" | \"Location ID\" | @(\"Location ID 1\", \"Location ID 2\", etc...)>

$controls = New-Object -TypeName Microsoft.Open.MSGraph.Model.ConditionalAccessGrantControls
$controls._Operator = \"OR\"
$controls.BuiltInControls = \"block\"

Next, update the existing conditional access policy with the condition set options configured with the previous commands.

Update-MgIdentityConditionalAccessPolicy -PolicyId <policy ID> -Conditions $conditions -GrantControls $controls

To create a new conditional access policy that complies with this best practice, run the following commands after creating the condition set above

New-MgIdentityConditionalAccessPolicy -Name \"Policy Name\" -State <enabled|disabled> -Conditions $conditions -GrantControls $controls

Impact:

Microsoft Entra ID P1 or P2 is required. Limiting access geographically will deny access to users that are traveling or working remotely in a different part of the world. A point-to-site or site to site tunnel such as a VPN is recommended to address exceptions to geographic access policies."
  reference   : "800-171|3.1.1,800-171r3|03.01.01,800-171r3|03.01.02,800-53|AC-2(1),800-53|AC-3,800-53r5|AC-2(1),800-53r5|AC-3,CN-L3|7.1.3.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|12.1,CSCv8|6.7,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.33,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ITSG-33|AC-2(1),ITSG-33|AC-3,LEVEL|2M,NESA|T4.2.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM3,NIAv2|AM28,NIAv2|NS5j,NIAv2|SS14e,NIAv2|SS29,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,TBA-FIISB|31.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "6.2.3 Ensure that an exclusionary device code flow policy is considered"
  info        : "Conditional Access Policies can be used to prevent the Device code authentication flow. Device code flow should be permitted only for users that regularly perform duties that explicitly require the use of Device Code to authenticate, such as utilizing Azure with PowerShell.

Attackers use Device code flow in phishing attacks and, if successful, results in the attacker gaining access tokens and refresh tokens which are scoped to \"user_impersonation\", which can perform any action the user has permission to perform.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

Part 1 of 2 - Create the policy and enable it in Report-only mode.

 - From Azure Home open the portal menu in the top left and select Microsoft Entra ID
 - Scroll down in the menu on the left and select Security
 - Select on the left side Conditional Access
 - Select Policies
 - Click the + New policy button, then:
 - Provide a name for the policy.
 - Under Assignments select Users then:
 - Under Include select All users
 - Under Exclude check Users and groups and only select emergency access accounts

 - Under Assignments select Target resources then:
 - Under Include select All cloud apps
 - Leave Exclude blank unless you have a well defined exception

 - Under Conditions > Authentication Flows set Configure to Yes then:
 - Select Device code flow
 - Select Done

 - Under Access Controls > Grant select Block Access
 - Set Enable policy to Report-only
 - Click Create

Allow some time to pass to ensure the sign-in logs capture relevant conditional access events. These events will need to be reviewed to determine if additional considerations are necessary for your organization (e.g. many legitimate use cases of device code authentication are observed).

NOTE: The policy is not yet 'live,' since Report-only is being used to audit the effect of the policy.

Part 2 of 2 - Confirm that the policy is not blocking access that should be granted, then toggle to On

 - With your policy now in report-only mode, return to the Microsoft Entra blade and click on Sign-in logs
 - Review the recent sign-in events - click an event then review the event details (specifically the Report-only tab) to ensure:
 - The sign-in event you're reviewing occurred after turning on the policy in report-only mode
 - The policy name from step 6 above is listed in the Policy Name column
 - The Result column for the new policy shows that the policy was Not applied (indicating the device code authentication flow was not blocked)

 - If the above conditions are present, navigate back to the policy name in Conditional Access and open it.
 - Toggle the policy from Report-only to On
 - Click Save

Impact:

Microsoft Entra ID P1 or P2 is required.

This policy should be tested using the Report-only mode before implementation. Without a full and careful understanding of the accounts and personnel who require Device code authentication flow, implementing this policy can block authentication for users and devices who rely on Device code flow. For users and devices that rely on device code flow authentication, more secure alternatives should be implemented wherever possible."
  reference   : "800-171|3.1.1,800-171|3.5.2,800-171|3.5.5,800-171|3.5.6,800-171r3|03.01.01,800-171r3|03.05.05,800-171r3|03.05.12,800-171r3|03.15.01,800-53|AC-1,800-53|AC-2,800-53|IA-4,800-53|IA-5,800-53r5|AC-1,800-53r5|AC-2,800-53r5|AC-2(1),800-53r5|IA-4,800-53r5|IA-5,CN-L3|7.1.2.7(b),CN-L3|7.1.3.2(d),CN-L3|8.1.4.2(e),CN-L3|8.1.10.6(c),CSCv7|12.4,CSCv8|6.1,CSF|DE.CM-1,CSF|DE.CM-3,CSF|ID.GV-1,CSF|ID.GV-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|GV.OC-03,CSF2.0|GV.OV-01,CSF2.0|GV.PO-01,CSF2.0|GV.PO-02,CSF2.0|GV.SC-03,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ISO-27001-2022|A.5.1,ISO-27001-2022|A.5.2,ISO-27001-2022|A.5.4,ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.17,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.31,ISO-27001-2022|A.5.36,ISO-27001-2022|A.5.37,ISO-27001-2022|A.8.2,ISO-27001-2022|5.2,ISO-27001-2022|5.3,ISO-27001-2022|7.5.1,ISO-27001-2022|7.5.2,ISO-27001-2022|7.5.3,ISO/IEC-27001|A.9.1.1,ISO/IEC-27001|A.9.2.1,ITSG-33|AC-1,ITSG-33|AC-2,ITSG-33|IA-4,ITSG-33|IA-5,LEVEL|2M,NESA|M1.2.2,NESA|T5.2.3,NIAv2|AM28,NIAv2|AM29,NIAv2|AM30,NIAv2|NS5j,NIAv2|SS14e,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "6.2.4 Ensure that a multifactor authentication policy exists for all users"
  info        : "A Conditional Access policy can be enabled to ensure that users are required to use Multifactor Authentication (MFA) to login.

Note: Since 2024, Azure has been rolling out mandatory multifactor authentication. For more information:

 -

https://azure.microsoft.com/en-us/blog/announcing-mandatory-multi-factor-authentication-for-azure-sign-in

 -

https://learn.microsoft.com/en-us/entra/identity/authentication/concept-mandatory-multifactor-authentication

Multifactor authentication is strongly recommended to increase the confidence that a claimed identity can be proven to be the subject of the identity. This results in a stronger authentication chain and reduced likelihood of exploitation.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - From Azure Home open Portal menu in the top left, and select Microsoft Entra ID
 - Select Security
 - Select Conditional Access
 - Select Policies
 - Click + New policy
 - Enter a name for the policy.
 - Click the blue text under Users
 - Under Include select All users
 - Under Exclude check Users and groups
 - Select users this policy should not apply to and click Select
 - Click the blue text under Target resources
 - Select All cloud apps
 - Click the blue text under Grant
 - Under Grant access check Require multifactor authentication and click Select
 - Set Enable policy to Report-only
 - Click Create

After testing the policy in report-only mode, update the Enable policy setting from Report-only to On

Impact:

There is an increased cost associated with Conditional Access policies because of the requirement of Microsoft Entra ID P1 or P2 licenses. Additional support overhead may also need to be considered."
  reference   : "800-171|3.5.3,800-171r3|03.05.03,800-53|IA-2(1),800-53|IA-2(2),800-53r5|AC-19,800-53r5|IA-2(1),800-53r5|IA-2(2),CN-L3|7.1.2.7(b),CN-L3|7.1.3.1(a),CN-L3|7.1.3.1(e),CN-L3|8.1.4.1(a),CN-L3|8.1.4.2(a),CN-L3|8.5.4.1(a),CSCv7|4.5,CSCv7|16.3,CSCv8|6.3,CSCv8|6.4,CSF|PR.AC-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ISO-27001-2022|A.5.16,ITSG-33|IA-2(1),ITSG-33|IA-2(2),LEVEL|2M,NESA|T5.4.2,NIAv2|AM2,NIAv2|AM8,NIAv2|AM14b,NIAv2|AM36,NIAv2|VL3c,QCSC-v1|5.2.2,QCSC-v1|13.2,SWIFT-CSCv1|1.2,TBA-FIISB|35.1,TBA-FIISB|36.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "6.24 Ensure that a custom role is assigned permissions for administering resource locks"
  info        : "Resource locking is a powerful protection mechanism that can prevent inadvertent modification or deletion of resources within Azure subscriptions and resource groups, and it is a recommended NIST configuration.

Given that the resource lock functionality is outside of standard Role-Based Access Control (RBAC), it would be prudent to create a resource lock administrator role to prevent inadvertent unlocking of resources.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - In the Azure portal, navigate to a subscription or resource group.
 - Click Access control (IAM)
 - Click + Add
 - Click Add custom role
 - In the Custom role name field enter Resource Lock Administrator
 - In the Description field enter Can Administer Resource Locks
 - For Baseline permissions select Start from scratch
 - Click Next
 - Click Add permissions
 - In the Search for a permission box, type Microsoft.Authorization/locks
 - Click the result.
 - Check the box next to Permission
 - Click Add
 - Click Review + create
 - Click Create
 - Click OK
 - Click + Add
 - Click Add role assignment
 - In the Search by role name, description, permission, or ID box, type Resource Lock Administrator
 - Select the role.
 - Click Next
 - Click + Select members
 - Select appropriate members.
 - Click Select
 - Click Review + assign
 - Click Review + assign again.
 - Repeat steps 1-26 for each subscription or resource group requiring remediation.

Remediate from PowerShell:

Below is a PowerShell definition for a resource lock administrator role created at an Azure Management group level

Import-Module Az.Accounts
Connect-AzAccount

$role = Get-AzRoleDefinition \"User Access Administrator\"
$role.Id = $null
$role.Name = \"Resource Lock Administrator\"
$role.Description = \"Can Administer Resource Locks\"
$role.Actions.Clear()
$role.Actions.Add(\"Microsoft.Authorization/locks/*\")
$role.AssignableScopes.Clear()

* Scope at the Management group level Management group

$role.AssignableScopes.Add(\"/providers/Microsoft.Management/managementGroups/MG-Name\")

New-AzRoleDefinition -Role $role
Get-AzureRmRoleDefinition \"Resource Lock Administrator\"

Impact:

By adding this role, specific permissions may be granted for managing only resource locks rather than needing to provide the broad Owner or User Access Administrator role, reducing the risk of the user being able to cause unintentional damage."
  reference   : "800-171|3.1.1,800-171|3.1.4,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-171r3|03.01.01,800-171r3|03.01.02,800-171r3|03.01.04,800-171r3|03.01.05,800-171r3|03.01.05a.,800-171r3|03.01.05b.,800-171r3|03.03.08b.,800-171r3|03.08.02,800-53|AC-2,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53|MP-2,800-53r5|AC-2,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),800-53r5|MP-2,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|3.3,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-2,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.5.3,ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.33,ISO-27001-2022|A.7.7,ISO-27001-2022|A.7.10,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.15,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),ITSG-33|MP-2,ITSG-33|MP-2a.,LEVEL|2M,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "6.2.5 Ensure that multifactor authentication is required for risky sign-ins"
  info        : "Entra ID tracks the behavior of sign-in events. If the Entra ID domain is licensed with P2, the sign-in behavior can be used as a detection mechanism for additional scrutiny during the sign-in event. If this policy is set up, then Risky Sign-in events will prompt users to use multi-factor authentication (MFA) tokens on login for additional verification.

Enabling multi-factor authentication is a recommended setting to limit the potential of accounts being compromised and limiting access to authenticated personnel. Enabling this policy allows Entra ID's risk-detection mechanisms to force additional scrutiny on the login event, providing a deterrent response to potentially malicious sign-in events, and adding an additional authentication layer as a reaction to potentially malicious behavior.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - From Azure Home select the Portal Menu in the top left and select Microsoft Entra ID
 - Select Security
 - Select Conditional Access
 - Select Policies
 - Click + New policy
 - Enter a name for the policy.
 - Click the blue text under Users
 - Under Include select All users
 - Under Exclude check Users and groups
 - Select users this policy should not apply to and click Select
 - Click the blue text under Target resources
 - Select All cloud apps
 - Click the blue text under Conditions
 - Select Sign-in risk
 - Update the Configure toggle to Yes
 - Check the sign-in risk level this policy should apply to, e.g. High and Medium
 - Select Done
 - Click the blue text under Grant and check Require multifactor authentication then click the Select button.
 - Click the blue text under Session then check Sign-in frequency and select Every time and click the Select button.
 - Set Enable policy to Report-only
 - Click Create

After testing the policy in report-only mode, update the Enable policy setting from Report-only to On

Impact:

Risk Policies for Conditional Access require Microsoft Entra ID P2. Additional overhead to support or maintain these policies may also be required if users lose access to their MFA tokens."
  reference   : "800-171|3.1.1,800-171|3.5.3,800-171r3|03.01.01,800-171r3|03.01.02,800-171r3|03.05.03,800-53|AC-2(1),800-53|AC-3,800-53|IA-2(1),800-53|IA-2(2),800-53r5|AC-2(1),800-53r5|AC-3,800-53r5|AC-19,800-53r5|IA-2(1),800-53r5|IA-2(2),CN-L3|7.1.2.7(b),CN-L3|7.1.3.1(a),CN-L3|7.1.3.1(e),CN-L3|7.1.3.2(d),CN-L3|8.1.4.1(a),CN-L3|8.1.4.2(a),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|16.3,CSCv8|6.3,CSCv8|6.4,CSCv8|6.7,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.33,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ITSG-33|AC-2(1),ITSG-33|AC-3,ITSG-33|IA-2(1),ITSG-33|IA-2(2),LEVEL|2M,NESA|T4.2.1,NESA|T5.4.2,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM2,NIAv2|AM3,NIAv2|AM8,NIAv2|AM14b,NIAv2|AM28,NIAv2|AM36,NIAv2|NS5j,NIAv2|SS14e,NIAv2|SS29,NIAv2|VL3c,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|1.2,TBA-FIISB|31.1,TBA-FIISB|35.1,TBA-FIISB|36.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "6.25 Ensure that 'Subscription leaving Microsoft Entra tenant' and 'Subscription entering Microsoft Entra tenant' is set to 'Permit no one'"
  info        : "Users who are set as subscription owners are able to make administrative changes to the subscriptions and move them into and out of Microsoft Entra ID.

Permissions to move subscriptions in and out of a Microsoft Entra tenant must only be given to appropriate administrative personnel. A subscription that is moved into a Microsoft Entra tenant may be within a folder to which other users have elevated permissions. This prevents loss of data or unapproved changes of the objects within by potential bad actors.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - From the Azure Portal Home select the portal menu
 - Select Subscriptions
 - In the Advanced options drop-down menu, select Manage Policies
 - Set Subscription leaving Microsoft Entra tenant and Subscription entering Microsoft Entra tenant to Permit no one
 - Click Save changes

Impact:

Subscriptions will need to have these settings turned off to be moved."
  reference   : "800-171|3.1.1,800-171|3.1.5,800-171|3.1.6,800-171|3.5.2,800-171|3.5.5,800-171|3.5.6,800-171r3|03.01.01,800-171r3|03.01.06a.,800-171r3|03.01.06b.,800-171r3|03.05.05,800-171r3|03.05.12,800-171r3|03.15.01,800-53|AC-1,800-53|AC-2,800-53|AC-2(1),800-53|AC-6(2),800-53|AC-6(5),800-53|IA-4,800-53|IA-5,800-53r5|AC-1,800-53r5|AC-2,800-53r5|AC-2(1),800-53r5|AC-6(2),800-53r5|AC-6(5),800-53r5|IA-4,800-53r5|IA-5,CN-L3|7.1.2.7(b),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(e),CN-L3|8.1.10.6(a),CN-L3|8.1.10.6(c),CSCv7|4.3,CSCv8|5.4,CSCv8|6.1,CSCv8|6.2,CSF|DE.CM-1,CSF|DE.CM-3,CSF|ID.GV-1,CSF|ID.GV-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|GV.OC-03,CSF2.0|GV.OV-01,CSF2.0|GV.PO-01,CSF2.0|GV.PO-02,CSF2.0|GV.SC-03,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ISO-27001-2022|A.5.1,ISO-27001-2022|A.5.2,ISO-27001-2022|A.5.4,ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.17,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.31,ISO-27001-2022|A.5.36,ISO-27001-2022|A.5.37,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.18,ISO-27001-2022|5.2,ISO-27001-2022|5.3,ISO-27001-2022|7.5.1,ISO-27001-2022|7.5.2,ISO-27001-2022|7.5.3,ISO/IEC-27001|A.9.1.1,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.3,ITSG-33|AC-1,ITSG-33|AC-2,ITSG-33|AC-2(1),ITSG-33|AC-6(2),ITSG-33|AC-6(5),ITSG-33|IA-4,ITSG-33|IA-5,LEVEL|2M,NESA|M1.2.2,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.2.3,NESA|T5.6.1,NIAv2|AM1,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM29,NIAv2|AM30,NIAv2|AM32,NIAv2|AM33,NIAv2|NS5j,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|VL3a,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|1.2,SWIFT-CSCv1|5,SWIFT-CSCv1|5.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "6.2.6 Ensure that multifactor authentication is required for Windows Azure Service Management API"
  info        : "This recommendation ensures that users accessing the Windows Azure Service Management API (i.e. Azure Powershell, Azure CLI, Azure Resource Manager API, etc.) are required to use multi-factor authentication (MFA) credentials when accessing resources through the Windows Azure Service Management API.

Administrative access to the Windows Azure Service Management API should be secured with a higher level of scrutiny to authenticating mechanisms. Enabling multi-factor authentication is recommended to reduce the potential for abuse of Administrative actions, and to prevent intruders or compromised admin credentials from changing administrative settings.

IMPORTANT : While this recommendation allows exceptions to specific Users or Groups, they should be very carefully tracked and reviewed for necessity on a regular interval through an Access Review process. It is important that this rule be built to include \"All Users\" to ensure that all users not specifically excepted will be required to use MFA to access the Azure Service Management API.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - From the Azure Admin Portal dashboard, open Microsoft Entra ID
 - Click Security in the Entra ID blade.
 - Click Conditional Access in the Security blade.
 - Click Policies in the Conditional Access blade.
 - Click + New policy
 - Enter a name for the policy.
 - Click the blue text under Users
 - Under Include select All users
 - Under Exclude check Users and groups
 - Select users or groups to be exempted from this policy (e.g. break-glass emergency accounts, and non-interactive service accounts) then click the Select button.
 - Click the blue text under Target resources
 - Under Include click the Select apps radio button.
 - Click the blue text under Select
 - Check the box next to Windows Azure Service Management APIs then click the Select button.
 - Click the blue text under Grant
 - Under Grant access check the box for Require multi-factor authentication then click the Select button.
 - Before creating, set Enable policy to Report-only
 - Click Create

After testing the policy in report-only mode, update the Enable policy setting from Report-only to On

Impact:

Conditional Access policies require Microsoft Entra ID P1 or P2 licenses. Similarly, they may require additional overhead to maintain if users lose access to their MFA. Any users or groups which are granted an exception to this policy should be carefully tracked, be granted only minimal necessary privileges, and conditional access exceptions should be regularly reviewed or investigated."
  reference   : "800-171|3.5.3,800-171r3|03.05.03,800-53|IA-2(1),800-53r5|IA-2(1),CN-L3|7.1.2.7(b),CSCv7|4.5,CSCv8|6.5,CSF|PR.AC-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ISO-27001-2022|A.5.16,ITSG-33|IA-2(1),LEVEL|2M,NESA|T5.4.2,NIAv2|AM36,NIAv2|VL3c,QCSC-v1|5.2.2,QCSC-v1|13.2,SWIFT-CSCv1|1.2,TBA-FIISB|35.1,TBA-FIISB|36.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "6.2.7 Ensure that multifactor authentication is required to access Microsoft Admin Portals"
  info        : "This recommendation ensures that users accessing Microsoft Admin Portals (i.e. Microsoft 365 Admin, Microsoft 365 Defender, Exchange Admin Center, Azure Portal, etc.) are required to use multi-factor authentication (MFA) credentials when logging into an Admin Portal.

Administrative Portals for Microsoft Azure should be secured with a higher level of scrutiny to authenticating mechanisms. Enabling multi-factor authentication is recommended to reduce the potential for abuse of Administrative actions, and to prevent intruders or compromised admin credentials from changing administrative settings.

IMPORTANT : While this recommendation allows exceptions to specific Users or Groups, they should be very carefully tracked and reviewed for necessity on a regular interval through an Access Review process. It is important that this rule be built to include \"All Users\" to ensure that all users not specifically excepted will be required to use MFA to access Admin Portals.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - From the Azure Admin Portal dashboard, open Microsoft Entra ID
 - Click Security in the Entra ID blade.
 - Click Conditional Access in the Security blade.
 - Click Policies in the Conditional Access blade.
 - Click + New policy
 - Enter a name for the policy.
 - Click the blue text under Users
 - Under Include select All users
 - Under Exclude check Users and groups
 - Select users or groups to be exempted from this policy (e.g. break-glass emergency accounts, and non-interactive service accounts) then click the Select button.
 - Click the blue text under Target resources
 - Under Include click the Select apps radio button.
 - Click the blue text under Select
 - Check the box next to Microsoft Admin Portals then click the Select button.
 - Click the blue text under Grant
 - Under Grant access check the box for Require multifactor authentication then click the Select button.
 - Before creating, set Enable policy to Report-only
 - Click Create

After testing the policy in report-only mode, update the Enable policy setting from Report-only to On

Impact:

Conditional Access policies require Microsoft Entra ID P1 or P2 licenses. Similarly, they may require additional overhead to maintain if users lose access to their MFA. Any users or groups which are granted an exception to this policy should be carefully tracked, be granted only minimal necessary privileges, and conditional access exceptions should be reviewed or investigated."
  reference   : "800-171|3.5.3,800-171r3|03.05.03,800-53|IA-2(1),800-53r5|IA-2(1),CN-L3|7.1.2.7(b),CSCv7|4.5,CSCv8|6.5,CSF|PR.AC-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ISO-27001-2022|A.5.16,ITSG-33|IA-2(1),LEVEL|2M,NESA|T5.4.2,NIAv2|AM36,NIAv2|VL3c,QCSC-v1|5.2.2,QCSC-v1|13.2,SWIFT-CSCv1|1.2,TBA-FIISB|35.1,TBA-FIISB|36.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "7.1.1.10 Ensure that Intune logs are captured and sent to Log Analytics"
  info        : "Ensure that Intune logs are captured and fed into a central log analytics workspace.

Intune includes built-in logs that provide information about your environments. Sending logs to a Log Analytics workspace enables centralized analysis, correlation, and alerting for faster threat detection and response.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - Go to Intune
 - Click Reports
 - Under Azure monitor click Diagnostic settings
 - Click + Add diagnostic setting
 - Provide a Diagnostic setting name
 - Under Logs > Categories check the box next to each of the following logs:
 - AuditLogs
 - OperationalLogs
 - DeviceComplianceOrg
 - Devices
 - Windows365AuditLogs

 - Under Destination details check the box next to Send to Log Analytics workspace
 - Select a Subscription
 - Select a Log Analytics workspace
 - Click Save

Impact:

A Microsoft Intune plan is required to access Intune:

https://www.microsoft.com/en-gb/security/business/microsoft-intune-pricing

.

The amount of data logged and, thus, the cost incurred can vary significantly depending on the tenant size.

For information on Log Analytics workspace costs, visit:

https://learn.microsoft.com/en-us/azure/azure-monitor/logs/cost-logs

."
  reference   : "800-171|3.3.1,800-171|3.3.2,800-171|3.3.6,800-171r3|03.03.01,800-171r3|03.03.03,800-171r3|03.03.06a.,800-53|AU-2,800-53|AU-7,800-53|AU-12,800-53r5|AU-2,800-53r5|AU-7,800-53r5|AU-12,CN-L3|7.1.2.3(c),CN-L3|8.1.4.3(a),CSCv7|6.2,CSCv8|8.2,CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,CSF|RS.AN-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|DE.CM-09,CSF2.0|PR.PS-04,CSF2.0|RS.AN-03,CSF2.0|RS.AN-06,CSF2.0|RS.AN-07,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.8.15,ITSG-33|AU-2,ITSG-33|AU-7,ITSG-33|AU-12,LEVEL|2M,NESA|M1.2.2,NESA|M5.5.1,NIAv2|AM7,NIAv2|AM11a,NIAv2|AM11b,NIAv2|AM11c,NIAv2|AM11d,NIAv2|AM11e,NIAv2|SS30,NIAv2|VL8,PCI-DSSv3.2.1|10.1,QCSC-v1|3.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,QCSC-v1|13.2,SWIFT-CSCv1|6.4"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<custom_item>
  description    : "7.1.1.3 Ensure the storage account containing the container with activity logs is encrypted with Customer Managed Key (CMK)"
  info           : "Storage accounts with the activity log exports can be configured to use Customer Managed Keys (CMK).

Configuring the storage account with the activity log export container to use CMKs provides additional confidentiality controls on log data, as a given user must have read permission on the corresponding storage account and must be granted decrypt permission by the CMK.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
  solution       : "Remediate from Azure Portal

 - Go to Monitor
 - Select Activity log
 - Select Export Activity Logs
 - Select a Subscription
 - Note the name of the Storage Account for the diagnostic setting.
 - Navigate to Storage accounts
 - Click on the storage account.
 - Under Security + networking click Encryption
 - Next to Encryption type select Customer-managed keys
 - Complete the steps to configure a customer-managed key for encryption of the storage account.

Remediate from Azure CLI

az storage account update --name <name of the storage account> --resource-group <resource group for a storage account> --encryption-key-source=Microsoft.Keyvault --encryption-key-vault <Key Vault URI> --encryption-key-name <KeyName> --encryption-key-version <Key Version>

Remediate from PowerShell

Set-AzStorageAccount -ResourceGroupName <resource group name> -Name <storage account name> -KeyvaultEncryption -KeyVaultUri <key vault URI> -KeyName <key name>

Impact:

NOTE: You must have your key vault setup to utilize this.All Audit Logs will be encrypted with a key you provide. You will need to set up customer managed keys separately, and you will select which key to use via the instructions here. You will be responsible for the lifecycle of the keys, and will need to manually replace them at your own determined intervals to keep the data secure."
  reference      : "800-171|3.5.2,800-171|3.13.16,800-171r3|03.05.07,800-171r3|03.13.08,800-53|IA-5(1),800-53|SC-28,800-53|SC-28(1),800-53r5|IA-5(1),800-53r5|SC-28,800-53r5|SC-28(1),CN-L3|8.1.4.7(b),CN-L3|8.1.4.8(b),CSCv7|14.8,CSCv8|3.11,CSF|PR.AC-1,CSF|PR.DS-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.DS-01,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(d),HIPAA|164.312(e)(2)(ii),ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.17,ISO-27001-2022|A.5.33,ITSG-33|IA-5(1),ITSG-33|SC-28,ITSG-33|SC-28a.,ITSG-33|SC-28(1),LEVEL|2A,NESA|T5.2.3,PCI-DSSv3.2.1|3.4,PCI-DSSv4.0|3.3.2,PCI-DSSv4.0|3.5.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|4.1,TBA-FIISB|28.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listStorageAccounts"
  json_transform : '.[]|.subscriptionId as $id| .value[]| .name as $name| "Subscription ID: \($id), Name: \($name), Key Vault Properties: \(.properties.encryption.keyVaultProperties), Encryption Type: \(.properties.encryption.keySource)"'
  not_expect     : "(Key Vault Properties: null|Encryption Type: Microsoft\.Storage)"
  severity       : MEDIUM
</custom_item>

<report type:"WARNING">
  description : "7.1.1.5 Ensure that Network Security Group Flow logs are captured and sent to Log Analytics"
  info        : "Ensure that network flow logs are captured and fed into a central log analytics workspace.

Retirement Notice

On September 30, 2027, network security group (NSG) flow logs will be retired. Starting June 30, 2025, it will no longer be possible to create new NSG flow logs. Azure recommends migrating to virtual network flow logs. Review

https://azure.microsoft.com/en-gb/updates?id=Azure-NSG-flow-logs-Retirement

for more information.

For virtual network flow logs, consider applying the recommendation Ensure that virtual network flow logs are captured and sent to Log Analytics in this section.

Network Flow Logs provide valuable insight into the flow of traffic around your network and feed into both Azure Monitor and Azure Sentinel (if in use), permitting the generation of visual flow diagrams to aid with analyzing for lateral movement, etc.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - Navigate to Network Watcher
 - Under Logs select Flow logs
 - Select + Create
 - Select the desired Subscription.
 - For Flow log type select Network security group
 - Select + Select target resource
 - Select Network security group
 - Select a network security group.
 - Click Confirm selection
 - Select or create a new Storage Account.
 - If using a v2 storage account, input the retention in days to retain the log.
 - Click Next
 - Under Analytics for Flow log version select Version 2
 - Check the box next to Enable traffic analytics
 - Select a processing interval.
 - Select a Log Analytics Workspace
 - Select Next
 - Optionally add Tags.
 - Select Review + create
 - Select Create

Warning

The remediation policy creates remediation deployment and names them by concatenating the subscription name and the resource group name. The MAXIMUM permitted length of a deployment name is 64 characters. Exceeding this will cause the remediation task to fail.

Impact:

The impact of configuring NSG Flow logs is primarily one of cost and configuration. If deployed, it will create storage accounts that hold minimal amounts of data on a 5-day lifecycle before feeding to Log Analytics Workspace.This will increase the amount of data stored and used by Azure Monitor."
  reference   : "800-171|3.14.6,800-171|3.14.7,800-171r3|03.14.06,800-53|SI-4,800-53|SI-4(4),800-53r5|SI-4,800-53r5|SI-4(4),CN-L3|7.1.2.2(c),CN-L3|7.1.3.5(a),CN-L3|8.1.10.5(b),CN-L3|8.1.10.6(f),CSCv7|12.8,CSCv8|13.6,CSF|DE.AE-1,CSF|DE.AE-2,CSF|DE.AE-3,CSF|DE.AE-4,CSF|DE.CM-1,CSF|DE.CM-5,CSF|DE.CM-6,CSF|DE.CM-7,CSF|DE.DP-2,CSF|DE.DP-3,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.DS-5,CSF|PR.IP-8,CSF|RS.AN-1,CSF|RS.CO-3,CSF2.0|DE.AE-02,CSF2.0|DE.AE-03,CSF2.0|DE.CM-01,CSF2.0|DE.CM-06,CSF2.0|DE.CM-09,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.8.16,ITSG-33|SI-4,ITSG-33|SI-4(4),LEVEL|2M,NESA|M1.2.2,NIAv2|NS32,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|6.5"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "7.1.1.6 Ensure that logging for Azure AppService 'HTTP logs' is enabled"
  info        : "Enable AppServiceHTTPLogs diagnostic log category for Azure App Service instances to ensure all http requests are captured and centrally logged.

Capturing web requests can be important supporting information for security analysts performing monitoring and incident response activities. Once logging, these logs can be ingested into SIEM or other central aggregation point for the organization.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - Go to App Services

For each App Service :

<xhtml:ol start=\"2\"> - Under Monitoring go to Diagnostic settings
 - To update an existing diagnostic setting, click Edit setting against the setting. To create a new diagnostic setting, click Add diagnostic setting and provide a name for the new setting.
 - Check the checkbox next to HTTP logs
 - Configure a destination based on your specific logging consumption capability (for example Stream to an event hub and then consuming with SIEM integration for Event Hub logging).
 - Click Save

Impact:

Log consumption and processing will incur additional cost."
  reference   : "800-171|3.3.1,800-171|3.3.2,800-171r3|03.03.01,800-53|AU-2,800-53r5|AU-2,CN-L3|8.1.4.3(a),CSCv7|7.6,CSCv8|8.7,CSF|PR.PT-1,CSF2.0|PR.PS-04,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.8.15,ITSG-33|AU-2,LEVEL|2A,NESA|M1.2.2,NESA|M5.5.1,NIAv2|AM7,NIAv2|AM11a,NIAv2|AM11b,NIAv2|AM11c,NIAv2|AM11d,NIAv2|AM11e,NIAv2|SS30,NIAv2|VL8,QCSC-v1|8.2.1,QCSC-v1|13.2,SWIFT-CSCv1|6.4"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "7.1.1.7 Ensure that virtual network flow logs are captured and sent to Log Analytics"
  info        : "Ensure that virtual network flow logs are captured and fed into a central log analytics workspace.

Virtual network flow logs provide critical visibility into traffic patterns. Sending logs to a Log Analytics workspace enables centralized analysis, correlation, and alerting for faster threat detection and response.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - Go to Network Watcher
 - Under Logs click Flow logs
 - Click + Create
 - Select a subscription.
 - Next to Flow log type select Virtual network
 - Click + Select target resource
 - Select Virtual network
 - Select a virtual network.
 - Click Confirm selection
 - Select a storage account, or create a new storage account.
 - Set the retention in days for the storage account.
 - Click Next
 - Under Analytics for Flow logs version select Version 2
 - Check the box next to Enable traffic analytics
 - Select a processing interval.
 - Select a Log Analytics Workspace
 - Click Next
 - Optionally, add Tags
 - Click Review + create
 - Click Create
 - Repeat steps 1-20 for each subscription or virtual network requiring remediation.

Impact:

 - Virtual network flow logs are charged per gigabyte of network flow logs collected and come with a free tier of 5 GB/month per subscription.
 - If traffic analytics is enabled with virtual network flow logs, traffic analytics pricing applies at per gigabyte processing rates.
 - The storage of logs is charged separately."
  reference   : "800-171|3.14.6,800-171|3.14.7,800-171r3|03.14.06,800-53|SI-4,800-53|SI-4(4),800-53r5|SI-4,800-53r5|SI-4(4),CN-L3|7.1.2.2(c),CN-L3|7.1.3.5(a),CN-L3|8.1.10.5(b),CN-L3|8.1.10.6(f),CSCv7|12.8,CSCv8|13.6,CSF|DE.AE-1,CSF|DE.AE-2,CSF|DE.AE-3,CSF|DE.AE-4,CSF|DE.CM-1,CSF|DE.CM-5,CSF|DE.CM-6,CSF|DE.CM-7,CSF|DE.DP-2,CSF|DE.DP-3,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.DS-5,CSF|PR.IP-8,CSF|RS.AN-1,CSF|RS.CO-3,CSF2.0|DE.AE-02,CSF2.0|DE.AE-03,CSF2.0|DE.CM-01,CSF2.0|DE.CM-06,CSF2.0|DE.CM-09,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.8.16,ITSG-33|SI-4,ITSG-33|SI-4(4),LEVEL|2M,NESA|M1.2.2,NIAv2|NS32,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|6.5"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "7.1.1.8 Ensure that a Microsoft Entra diagnostic setting exists to send Microsoft Graph activity logs to an appropriate destination"
  info        : "Ensure that a Microsoft Entra diagnostic setting is configured to send Microsoft Graph activity logs to a suitable destination, such as a Log Analytics workspace, storage account, or event hub. This enables centralized monitoring and analysis of all HTTP requests that the Microsoft Graph service receives and processes for a tenant.

Microsoft Graph activity logs provide visibility into HTTP requests made to the Microsoft Graph service, helping detect unauthorized access, suspicious activity, and security threats. Configuring diagnostic settings in Microsoft Entra ensures these logs are collected and sent to an appropriate destination for monitoring, analysis, and retention.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - Go to Microsoft Entra ID
 - Under Monitoring click Diagnostic settings
 - Click + Add diagnostic setting
 - Provide a Diagnostic setting name
 - Under Logs > Categories check the box next to MicrosoftGraphActivityLogs
 - Configure an appropriate destination for the logs.
 - Click Save

Impact:

A Microsoft Entra ID P1 or P2 tenant license is required to access the Microsoft Graph activity logs.

The amount of data logged and, thus, the cost incurred can vary significantly depending on the tenant size and the applications in your tenant that interact with the Microsoft Graph APIs.

See the following pricing calculations for respective services:

 - Log Analytics:

https://learn.microsoft.com/en-us/azure/azure-monitor/logs/cost-logs#pricing-model

.
 - Azure Storage:

https://azure.microsoft.com/en-gb/pricing/details/storage/blobs/

.
 - Event Hubs:

https://azure.microsoft.com/en-gb/pricing/details/event-hubs/"
  reference   : "800-171|3.3.1,800-171|3.3.2,800-171|3.3.6,800-171r3|03.03.01,800-171r3|03.03.03,800-171r3|03.03.06a.,800-53|AU-2,800-53|AU-7,800-53|AU-12,800-53r5|AU-2,800-53r5|AU-7,800-53r5|AU-12,CN-L3|7.1.2.3(c),CN-L3|8.1.4.3(a),CSCv7|6.2,CSCv8|8.2,CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,CSF|RS.AN-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|DE.CM-09,CSF2.0|PR.PS-04,CSF2.0|RS.AN-03,CSF2.0|RS.AN-06,CSF2.0|RS.AN-07,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.8.15,ITSG-33|AU-2,ITSG-33|AU-7,ITSG-33|AU-12,LEVEL|2M,NESA|M1.2.2,NESA|M5.5.1,NIAv2|AM7,NIAv2|AM11a,NIAv2|AM11b,NIAv2|AM11c,NIAv2|AM11d,NIAv2|AM11e,NIAv2|SS30,NIAv2|VL8,PCI-DSSv3.2.1|10.1,QCSC-v1|3.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,QCSC-v1|13.2,SWIFT-CSCv1|6.4"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "7.1.1.9 Ensure that a Microsoft Entra diagnostic setting exists to send Microsoft Entra activity logs to an appropriate destination"
  info        : "Ensure that a Microsoft Entra diagnostic setting is configured to send Microsoft Entra activity logs to a suitable destination, such as a Log Analytics workspace, storage account, or event hub. This enables centralized monitoring and analysis of Microsoft Entra activity logs.

Microsoft Entra activity logs enables you to assess many aspects of your Microsoft Entra tenant. Configuring diagnostic settings in Microsoft Entra ensures these logs are collected and sent to an appropriate destination for monitoring, analysis, and retention.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - Go to Microsoft Entra ID
 - Under Monitoring click Diagnostic settings
 - Click + Add diagnostic setting
 - Provide a Diagnostic setting name
 - Under Logs > Categories check the box next to each of the following logs:
 - AuditLogs
 - SignInLogs
 - NonInteractiveUserSignInLogs
 - ServicePrincipalSignInLogs
 - ManagedIdentitySignInLogs
 - ProvisioningLogs
 - ADFSSignInLogs
 - RiskyUsers
 - UserRiskEvents
 - NetworkAccessTrafficLogs
 - RiskyServicePrincipals
 - ServicePrincipalRiskEvents
 - EnrichedOffice365AuditLogs
 - MicrosoftGraphActivityLogs
 - RemoteNetworkHealthLogs
 - NetworkAccessAlerts

 - Configure an appropriate destination for the logs.
 - Click Save

Impact:

To export sign-in data, your organization needs an Azure AD P1 or P2 license.

The amount of data logged and, thus, the cost incurred can vary significantly depending on the tenant size.

See the following pricing calculations for respective services:

 - Log Analytics:

https://learn.microsoft.com/en-us/azure/azure-monitor/logs/cost-logs#pricing-model

.
 - Azure Storage:

https://azure.microsoft.com/en-gb/pricing/details/storage/blobs/

.
 - Event Hubs:

https://azure.microsoft.com/en-gb/pricing/details/event-hubs/"
  reference   : "800-171|3.3.1,800-171|3.3.2,800-171|3.3.6,800-171r3|03.03.01,800-171r3|03.03.03,800-171r3|03.03.06a.,800-53|AU-2,800-53|AU-7,800-53|AU-12,800-53r5|AU-2,800-53r5|AU-7,800-53r5|AU-12,CN-L3|7.1.2.3(c),CN-L3|8.1.4.3(a),CSCv7|6.2,CSCv7|6.3,CSCv8|8.2,CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,CSF|RS.AN-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|DE.CM-09,CSF2.0|PR.PS-04,CSF2.0|RS.AN-03,CSF2.0|RS.AN-06,CSF2.0|RS.AN-07,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.8.15,ITSG-33|AU-2,ITSG-33|AU-7,ITSG-33|AU-12,LEVEL|2M,NESA|M1.2.2,NESA|M5.5.1,NIAv2|AM7,NIAv2|AM11a,NIAv2|AM11b,NIAv2|AM11c,NIAv2|AM11d,NIAv2|AM11e,NIAv2|SS30,NIAv2|VL8,PCI-DSSv3.2.1|10.1,QCSC-v1|3.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,QCSC-v1|13.2,SWIFT-CSCv1|6.4"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<custom_item>
  description    : "7.1.3.1 Ensure Application Insights are Configured"
  info           : "Application Insights within Azure act as an Application Performance Monitoring solution providing valuable data into how well an application performs and additional information when performing incident response. The types of log data collected include application metrics, telemetry data, and application trace logging data providing organizations with detailed information about application activity and application transactions. Both data sets help organizations adopt a proactive and retroactive means to handle security and performance related metrics within their modern applications.

Configuring Application Insights provides additional data not found elsewhere within Azure as part of a much larger logging and monitoring program within an organization's Information Security practice. The types and contents of these logs will act as both a potential cost saving measure (application performance) and a means to potentially confirm the source of a potential incident (trace logging). Metrics and Telemetry data provide organizations with a proactive approach to cost savings by monitoring an application's performance, while the trace logging data provides necessary details in a reactive incident response scenario by helping organizations identify the potential source of an incident within their application."
  solution       : "Remediate from Azure Portal

 - Navigate to Application Insights
 - Under the Basics tab within the PROJECT DETAILS section, select the Subscription
 - Select the Resource group
 - Within the INSTANCE DETAILS enter a Name
 - Select a Region
 - Next to Resource Mode select Workspace-based
 - Within the WORKSPACE DETAILS select the Subscription for the log analytics workspace.
 - Select the appropriate Log Analytics Workspace
 - Click Next:Tags >
 - Enter the appropriate Tags as Name Value pairs.
 - Click Next:Review+Create
 - Click Create

Remediate from Azure CLI

az monitor app-insights component create --app <app name> --resource-group <resource group name> --location <location> --kind \"web\" --retention-time <INT days to retain logs> --workspace <log analytics workspace ID> --subscription <subscription ID>

Remediate from PowerShell

New-AzApplicationInsights -Kind \"web\" -ResourceGroupName <resource group name> -Name <app insights name> -location <location> -RetentionInDays <INT days to retain logs> -SubscriptionID <subscription ID> -WorkspaceResourceId <log analytics workspace ID>

Impact:

Because Application Insights relies on a Log Analytics Workspace, an organization will incur additional expenses when using this service."
  reference      : "800-171|3.3.1,800-171|3.3.2,800-171|3.3.6,800-171r3|03.03.01,800-171r3|03.03.03,800-171r3|03.03.06a.,800-53|AU-2,800-53|AU-7,800-53|AU-12,800-53r5|AU-2,800-53r5|AU-7,800-53r5|AU-12,CN-L3|7.1.2.3(c),CN-L3|8.1.4.3(a),CSCv7|6.2,CSCv8|8.2,CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,CSF|RS.AN-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|DE.CM-09,CSF2.0|PR.PS-04,CSF2.0|RS.AN-03,CSF2.0|RS.AN-06,CSF2.0|RS.AN-07,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.8.15,ITSG-33|AU-2,ITSG-33|AU-7,ITSG-33|AU-12,LEVEL|2A,NESA|M1.2.2,NESA|M5.5.1,NIAv2|AM7,NIAv2|AM11a,NIAv2|AM11b,NIAv2|AM11c,NIAv2|AM11d,NIAv2|AM11e,NIAv2|SS30,NIAv2|VL8,PCI-DSSv3.2.1|10.1,QCSC-v1|3.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,QCSC-v1|13.2,SWIFT-CSCv1|6.4"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listInsightsComponents"
  json_transform : '.[]|.subscriptionId as $subid| if (.value[] | length) == 0 then "Subscription ID: \($subid) - Insights not configured" else (.value[] | "Subscription ID: \($subid), ID: \(.properties.AppId), Name: \(.name), Location: \(.location)") end'
  not_expect     : "Insights not configured"
</custom_item>

<report type:"WARNING">
  description : "7.1.5 Ensure that SKU Basic/Consumption is not used on artifacts that need to be monitored (Particularly for Production Workloads)"
  info        : "The use of Basic or Free SKUs in Azure whilst cost effective have significant limitations in terms of what can be monitored and what support can be realized from Microsoft. Typically, these SKU's do not have a service SLA and Microsoft may refuse to provide support for them. Consequently Basic/Free SKUs should never be used for production workloads.

Typically, production workloads need to be monitored and should have an SLA with Microsoft, using Basic SKUs for any deployed product will mean that that these capabilities do not exist.

The following resource types should use standard SKUs as a minimum.

 - Public IP Addresses
 - Network Load Balancers
 - REDIS Cache
 - SQL PaaS Databases
 - VPN Gateways

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Each resource has its own process for upgrading from basic to standard SKUs that should be followed if required.

 -

Public IP Address:

https://learn.microsoft.com/en-us/azure/virtual-network/ip-services/public-ip-upgrade

.

 -

Basic Load Balancer:

https://learn.microsoft.com/en-us/azure/load-balancer/load-balancer-basic-upgrade-guidance

.

 -

Azure Cache for Redis:

https://learn.microsoft.com/en-us/azure/azure-cache-for-redis/cache-how-to-scale

.

 -

Azure SQL Database:

https://learn.microsoft.com/en-us/azure/azure-sql/database/scale-resources

.

 -

VPN Gateway:

https://learn.microsoft.com/en-us/azure/vpn-gateway/gateway-sku-resize

.

Impact:

The impact of enforcing Standard SKU's is twofold

 - There will be a cost increase
 - The monitoring and service level agreements will be available and will support the production service.

All resources should be either tagged or in separate Management Groups/Subscriptions"
  reference   : "800-171r3|03.16.02,800-53|SA-22,800-53r5|SA-22,CSCv7|2.2,CSCv8|2.2,CSF2.0|ID.AM-08,GDPR|32.1.b,HIPAA|164.306(a)(1),LEVEL|2M"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<custom_item>
  description    : "7.2 Ensure that Resource Locks are set for Mission-Critical Azure Resources"
  info           : "Resource Manager Locks provide a way for administrators to lock down Azure resources to prevent deletion of, or modifications to, a resource. These locks sit outside of the Role Based Access Controls (RBAC) hierarchy and, when applied, will place restrictions on the resource for all users. These locks are very useful when there is an important resource in a subscription that users should not be able to delete or change. Locks can help prevent accidental and malicious changes or deletion.

As an administrator, it may be necessary to lock a subscription, resource group, or resource to prevent other users in the organization from accidentally deleting or modifying critical resources. The lock level can be set to to CanNotDelete or ReadOnly to achieve this purpose.

 -

CanNotDelete means authorized users can still read and modify a resource, but they cannot delete the resource.

 -

ReadOnly means authorized users can read a resource, but they cannot delete or update the resource. Applying this lock is similar to restricting all authorized users to the permissions granted by the Reader role.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
  solution       : "Remediate from Azure Portal

 - Navigate to the specific Azure Resource or Resource Group.
 - For each mission critical resource, click on Locks
 - Click Add
 - Give the lock a name and a description, then select the type, Read-only or Delete as appropriate.
 - Click OK.

Remediate from Azure CLI

To lock a resource, provide the name of the resource, its resource type, and its resource group name.

az lock create --name <LockName> --lock-type <CanNotDelete/Read-only> --resource-group <resourceGroupName> --resource-name <resourceName> --resource-type <resourceType>

Remediate from PowerShell

Get-AzResourceLock -ResourceName <Resource Name> -ResourceType <Resource Type> -ResourceGroupName <Resource Group Name> -Locktype <CanNotDelete/Read-only>

Impact:

There can be unintended outcomes of locking a resource. Applying a lock to a parent service will cause it to be inherited by all resources within. Conversely, applying a lock to a resource may not apply to connected storage, leaving it unlocked. Please see the documentation for further information."
  reference      : "800-171|3.1.1,800-171|3.1.4,800-171|3.1.5,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-171r3|03.01.02,800-171r3|03.01.04,800-171r3|03.01.05a.,800-171r3|03.08.02,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|MP-2,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|MP-2,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|3.3,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-2,CSF|PR.PT-3,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO-27001-2022|A.5.3,ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.33,ISO-27001-2022|A.7.7,ISO-27001-2022|A.7.10,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|MP-2,ITSG-33|MP-2a.,LEVEL|2M,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|SS13c,NIAv2|SS15c,NIAv2|SS29,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listManagementLocksByResourceGroup"
  json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgname|.value[]|"Subscription ID: \($subid), Resource Group: \($rgname), Lock Name: \(.name), Lock Type: \(.properties.level)"'
  not_expect     : ".+"
  severity       : MEDIUM
</custom_item>

<custom_item>
  description    : "8.5 Ensure that Network Security Group Flow Log retention period is 'greater than 90 days'"
  info           : "Network Security Group Flow Logs should be enabled and the retention period set to greater than or equal to 90 days.

Retirement Notice

On September 30, 2027, network security group (NSG) flow logs will be retired. Starting June 30, 2025, it will no longer be possible to create new NSG flow logs. Azure recommends migrating to virtual network flow logs. Review

https://azure.microsoft.com/en-gb/updates?id=Azure-NSG-flow-logs-Retirement

for more information.

For virtual network flow logs, consider applying the recommendation Ensure that virtual network flow log retention days is set to greater than or equal to 90 in this section.

Flow logs enable capturing information about IP traffic flowing in and out of network security groups. Logs can be used to check for anomalies and give insight into suspected breaches."
  solution       : "Remediate from Azure Portal

 - Go to Network Watcher
 - Select NSG flow logs blade in the Logs section
 - Select each Network Security Group from the list
 - Ensure Status is set to On
 - Ensure Retention (days) setting greater than 90 days
 - Select your storage account in the Storage account field
 - Select Save

Remediate from Azure CLI

Enable the NSG flow logs and set the Retention (days) to greater than or equal to 90 days.

az network watcher flow-log configure --nsg <NameorID of the Network Security Group> --enabled true --resource-group <resourceGroupName> --retention 91 --storage-account <NameorID of the storage account to save flow logs>

Impact:

This will keep IP traffic logs for longer than 90 days. As a level 2, first determine your need to retain data, then apply your selection here. As this is data stored for longer, your monthly storage costs will increase depending on your data use."
  reference      : "800-171r3|03.03.03b.,800-53|AU-4,800-53|AU-11,800-53r5|AU-4,800-53r5|AU-11,CSCv7|6.4,CSCv8|8.3,CSCv8|8.10,CSF|PR.DS-4,CSF|PR.PT-1,CSF2.0|PR.PS-04,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.5.28,ISO-27001-2022|A.8.6,ISO-27001-2022|A.8.15,ITSG-33|AU-4,ITSG-33|AU-11,LEVEL|2A,NESA|M5.2.3,NESA|T3.3.1,NESA|T3.6.2,NIAv2|SM7,PCI-DSSv3.2.1|10.7,PCI-DSSv4.0|10.5.1,QCSC-v1|8.2.1,QCSC-v1|13.2"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listNetworkWatcherFlowLogs"
  json_transform : '.[]|.subscriptionId as $id| .resourceGroups[]|.name as $name|.NetworkWatchers[]|.name as $nwname|.value[]|"Subscription ID: \($id), Resource Group: \($name), Network Watcher: \($nwname), Flow Logs Name: \(.name), Enabled: \(.properties.enabled), Retention Policy: \(.properties.retentionPolicy.days)"'
  expect         : 'Enabled: true, Retention Policy: (9[0-9]|[1-9][0-9][0-9]+|0$)'
  match_all      : YES
</custom_item>

<custom_item>
  description    : "8.6 Ensure that Network Watcher is 'Enabled' for Azure Regions that are in use"
  info           : "Enable Network Watcher for physical regions in Azure subscriptions.

Network diagnostic and visualization tools available with Network Watcher help users understand, diagnose, and gain insights to the network in Azure.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
  solution       : "Opting out of Network Watcher automatic enablement is a permanent change. Once you opt-out you cannot opt-in without contacting support.

To manually enable Network Watcher in each region where you want to use Network Watcher capabilities, follow the steps below.

Remediate from Azure Portal

 - Use the Search bar to search for and click on the Network Watcher service.
 - Click Create
 - Select a Region from the drop-down menu.
 - Click Add

Remediate from Azure CLI

az network watcher configure --locations <region> --enabled true --resource-group <resource_group>

Impact:

There are additional costs per transaction to run and store network data. For high-volume networks these charges will add up quickly."
  reference      : "800-171|3.4.6,800-171|3.4.7,800-171|3.13.1,800-171|3.13.2,800-171|3.13.5,800-171r3|03.04.06,800-171r3|03.13.01,800-171r3|03.16.01,800-53|CM-7,800-53|CP-6,800-53|CP-7,800-53|PL-8,800-53|PM-5,800-53|PM-7,800-53|SA-8,800-53|SC-7,800-53r5|CM-7,800-53r5|CP-6,800-53r5|CP-7,800-53r5|PL-8,800-53r5|PM-5,800-53r5|PM-7,800-53r5|SA-8,800-53r5|SC-7,CN-L3|8.1.10.6(j),CSCv7|11.2,CSCv7|12.1,CSCv8|12.2,CSCv8|12.4,CSF|DE.CM-1,CSF|ID.AM-3,CSF|PR.AC-5,CSF|PR.DS-5,CSF|PR.IP-1,CSF|PR.IP-2,CSF|PR.IP-4,CSF|PR.PT-3,CSF|PR.PT-4,CSF2.0|DE.CM-01,CSF2.0|ID.AM-01,CSF2.0|ID.AM-02,CSF2.0|ID.AM-03,CSF2.0|ID.AM-08,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.DS-11,CSF2.0|PR.IR-01,CSF2.0|PR.IR-03,CSF2.0|PR.IR-04,CSF2.0|PR.PS-01,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.c,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.5.8,ISO-27001-2022|A.5.14,ISO-27001-2022|A.5.29,ISO-27001-2022|A.7.5,ISO-27001-2022|A.8.14,ISO-27001-2022|A.8.16,ISO-27001-2022|A.8.20,ISO-27001-2022|A.8.27,ISO-27001-2022|A.8.28,ISO/IEC-27001|A.13.1.3,ITSG-33|CM-7,ITSG-33|CP-6,ITSG-33|CP-7,ITSG-33|SA-8,ITSG-33|SA-8a.,ITSG-33|SC-7,LEVEL|2A,NESA|T1.2.1,NESA|T1.2.2,NESA|T2.2.4,NESA|T3.4.1,NESA|T4.5.3,NESA|T4.5.4,NESA|T7.6.5,NIAv2|GS1,NIAv2|GS2a,NIAv2|GS2b,NIAv2|SS3,NIAv2|SS15a,NIAv2|VL2,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv3.2.1|2.2.2,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,SWIFT-CSCv1|2.3,TBA-FIISB|43.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listNetworkWatcher"
  json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgname|.NetworkWatchers[]|"SubscriptionID: \($subid)"+" ResourceGroup: \($rgname)"+" Network Watcher Name: \(.name)" + " Location: \(.location)" + " Provisioning State: \(.properties.provisioningState)"'
  regex          : "Provisioning State:"
  expect         : "^Manual Review Required$"
  severity       : MEDIUM
</custom_item>

<custom_item>
  description    : "8.8 Ensure that virtual network flow log retention days is set to greater than or equal to 90"
  info           : "Ensure that virtual network flow logs are retained for greater than or equal to 90 days.

Virtual network flow logs provide critical visibility into traffic patterns. Logs can be used to check for anomalies and give insight into suspected breaches."
  solution       : "Remediate from Azure Portal

 - Go to Network Watcher
 - Under Logs select Flow logs
 - Click Add filter
 - From the Filter drop-down menu, select Flow log type
 - From the Value drop-down menu, check Virtual network only.
 - Click Apply
 - Click the name of a virtual network flow log.
 - Under Storage Account set Retention days to 0 90 or a number greater than 90. If Retention days is set to 0 the logs are retained indefinitely with no retention policy.
 - Repeat steps 7 and 8 for each virtual network flow log requiring remediation.

Remediate from Azure CLI

Run the following command update the retention policy for a flow log in a network watcher, setting retention to 0 90 or a number greater than 90:

az network watcher flow-log update --location <location> --name <flow-log> --retention <number-of-days>

Repeat for each virtual network flow log requiring remediation.

Impact:

 - Virtual network flow logs are charged per gigabyte of network flow logs collected and come with a free tier of 5 GB/month per subscription.
 - If traffic analytics is enabled with virtual network flow logs, traffic analytics pricing applies at per gigabyte processing rates.
 - The storage of logs is charged separately, and the cost will depend on the amount of logs and the retention period."
  reference      : "800-171r3|03.03.03b.,800-53|AU-4,800-53|AU-11,800-53r5|AU-4,800-53r5|AU-11,CSCv7|6.4,CSCv8|8.3,CSCv8|8.10,CSF|PR.DS-4,CSF|PR.PT-1,CSF2.0|PR.PS-04,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.5.28,ISO-27001-2022|A.8.6,ISO-27001-2022|A.8.15,ITSG-33|AU-4,ITSG-33|AU-11,LEVEL|2A,NESA|M5.2.3,NESA|T3.3.1,NESA|T3.6.2,NIAv2|SM7,PCI-DSSv3.2.1|10.7,PCI-DSSv4.0|10.5.1,QCSC-v1|8.2.1,QCSC-v1|13.2"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listNetworkWatcherFlowLogs"
  json_transform : '.[]|.subscriptionId as $id| .resourceGroups[]|.name as $name|.NetworkWatchers[]|.name as $nwname|.value[]|"Subscription ID: \($id), Resource Group: \($name), Network Watcher: \($nwname), Flow Logs Name: \(.name), Enabled: \(.properties.enabled), Retention Policy: \(.properties.retentionPolicy.days)"'
  expect         : 'Enabled: true, Retention Policy: (9[0-9]|[1-9][0-9][0-9]+|0$)'
  match_all      : YES
</custom_item>

<report type:"WARNING">
  description : "9.1.16 Ensure that Microsoft Defender External Attack Surface Monitoring (EASM) is enabled"
  info        : "An organization's attack surface is the collection of assets with a public network identifier or URI that an external threat actor can see or access from outside your cloud. It is the set of points on the boundary of a system, a system element, system component, or an environment where an attacker can try to enter, cause an effect on, or extract data from, that system, system element, system component, or environment. The larger the attack surface, the harder it is to protect.

This tool can be configured to scan your organization's online infrastructure such as specified domains, hosts, CIDR blocks, and SSL certificates, and store them in an Inventory. Inventory items can be added, reviewed, approved, and removed, and may contain enrichments (\"insights\") and additional information collected from the tool's different scan engines and open-source intelligence sources.

A Defender EASM workspace will generate an Inventory of publicly exposed assets by crawling and scanning the internet using

Seeds

you provide when setting up the tool. Seeds can be FQDNs, IP CIDR blocks, and WHOIS records.

Defender EASM will generate Insights within 24-48 hours after Seeds are provided, and these insights include vulnerability data (CVEs), ports and protocols, and weak or expired SSL certificates that could be used by an attacker for reconnaissance or exploitation.

Results are classified High/Medium/Low and some of them include proposed mitigations.

This tool can monitor the externally exposed resources of an organization, provide valuable insights, and export these findings in a variety of formats (including CSV) for use in vulnerability management operations and red/purple team exercises.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - Go to Microsoft Defender EASM
 - Click + Create
 - Under Project details select a subscription.
 - Select or create a resource group.
 - Under Instance details enter a name for the workspace.
 - Select a region.
 - Click Review + create
 - Click Create
 - Once the deployment has completed, go to Microsoft Defender EASM
 - Click the workspace name.
 - Configure the workspace appropriately for your environment and organization.

Impact:

Microsoft Defender EASM workspaces are currently available as Azure Resources with a 30-day free trial period but can quickly accrue significant charges. The costs are calculated daily as (Number of \"billable\" inventory items) x (item cost per day; approximately: $0.017).

Estimated cost is not provided within the tool, and users are strongly advised to contact their Microsoft sales representative for pricing and set a calendar reminder for the end of the trial period.

For an EASM workspace having an Inventory of 5k-10k billable items (IP addresses, hostnames, SSL certificates, etc) a typical cost might be approximately $85-170 per day or $2500-5000 USD/month at the time of publication.

If the workspace is deleted by the last day of a free trial period, no charges are billed."
  reference   : "800-171|3.11.2,800-171|3.11.3,800-171r3|03.11.02,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.6,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.8.8,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2M,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "9.1.17 [LEGACY] Ensure That Microsoft Defender for DNS Is Set To 'On'"
  info        : "[ NOTE: As of August 1, 2023 customers with an existing subscription to Defender for DNS can continue to use the service, but new subscribers will receive alerts about suspicious DNS activity as part of Defender for Servers P2.]

Microsoft Defender for DNS scans all network traffic exiting from within a subscription.

DNS lookups within a subscription are scanned and compared to a dynamic list of websites that might be potential security threats. These threats could be a result of a security breach within your services, thus scanning for them could prevent a potential security threat from being introduced.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - Go to Microsoft Defender for Cloud
 - Under Management select Environment Settings
 - Click on the subscription name.
 - Select the Defender plans blade.
 - Select On under Status for DNS
 - Select Save

Remediate from Azure CLI

Enable Standard pricing tier for DNS:

az security pricing create -n 'DNS' --tier 'Standard'

Remediate from PowerShell

Enable Standard pricing tier for DNS:

Set-AzSecurityPricing -Name 'DNS' -PricingTier 'Standard'

Impact:

Enabling Microsoft Defender for DNS requires enabling Microsoft Defender for your subscription. Both will incur additional charges, with Defender for DNS being a small amount per million queries."
  reference   : "800-171|3.11.2,800-171|3.11.3,800-171r3|03.11.02,800-53|RA-5,800-53|SC-20,800-53|SC-21,800-53|SC-22,800-53r5|RA-5,800-53r5|SC-20,800-53r5|SC-21,800-53r5|SC-22,CSCv7|3.1,CSCv7|7.6,CSCv8|4.9,CSCv8|7.5,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.8.8,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,ITSG-33|SC-20,ITSG-33|SC-21,ITSG-33|SC-21a.,ITSG-33|SC-22,ITSG-33|SC-22a.,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T4.5.1,NESA|T7.7.1,NIAv2|NS17,NIAv2|NS18,NIAv2|NS19,NIAv2|NS20,NIAv2|NS21,NIAv2|NS22,NIAv2|NS23,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<custom_item>
  description    : "9.1.3.1 Ensure that Defender for Servers is set to 'On'"
  info           : "The Defender for Servers plan in Microsoft Defender for Cloud reduces security risk by providing actionable recommendations to improve and remediate machine security posture. Defender for Servers also helps to protect machines against real-time security threats and attacks.

Defender for Servers offers two paid plans:

Plan 1

The following components are enabled by default:

 - Log Analytics agent (deprecated)
 - Endpoint protection

Plan 1 also offers the following components, disabled by default:

 - Vulnerability assessment for machines
 - Guest Configuration agent (preview)

Plan 2

The following components are enabled by default:

 - Log Analytics agent (deprecated)
 - Vulnerability assessment for machines
 - Endpoint protection
 - Agentless scanning for machines

Plan 2 also offers the following components, disabled by default:

 - Guest Configuration agent (preview)
 - File Integrity Monitoring

Enabling Defender for Servers allows for greater defense-in-depth, with threat detection provided by the Microsoft Security Response Center (MSRC)."
  solution       : "Remediate from Azure Portal

 - Go to Microsoft Defender for Cloud
 - Under Management select Environment settings
 - Click on a subscription name.
 - Click Defender plans in the left pane.
 - Under Cloud Workload Protection (CWP) locate Servers in the Plan column, set Status to On
 - Select Save
 - Repeat steps 1-6 for each subscription requiring remediation.

Remediate from Azure CLI

Run the following command:

az security pricing create -n VirtualMachines --tier 'standard'

Remediate from PowerShell

Run the following command:

Set-AzSecurityPricing -Name 'VirtualMachines' -PricingTier 'Standard'

Impact:

Enabling Defender for Servers in Microsoft Defender for Cloud incurs an additional cost per resource. Refer to

https://azure.microsoft.com/en-us/pricing/details/defender-for-cloud/

and

https://azure.microsoft.com/en-us/pricing/calculator/

to estimate potential costs.

 - Plan 1: Subscription only
 - Plan 2: Subscription and workspace"
  reference      : "800-171|3.11.2,800-171|3.11.3,800-171|3.14.2,800-171|3.14.4,800-171|3.14.5,800-171r3|03.11.02,800-171r3|03.14.02,800-53|RA-5,800-53|SI-3,800-53r5|RA-5,800-53r5|SI-3,CN-L3|7.1.3.6(b),CN-L3|8.1.4.5,CN-L3|8.1.9.6(a),CN-L3|8.1.9.6(b),CN-L3|8.1.10.5(b),CN-L3|8.1.10.7(a),CN-L3|8.1.10.7(b),CSCv7|3.1,CSCv7|8.1,CSCv8|7.5,CSCv8|10.1,CSF|DE.CM-4,CSF|DE.CM-8,CSF|DE.DP-3,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.8.7,ISO-27001-2022|A.8.8,ISO/IEC-27001|A.12.2.1,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,ITSG-33|SI-3,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|GS8a,PCI-DSSv3.2.1|5.1,PCI-DSSv3.2.1|5.1.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|5.2.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7,TBA-FIISB|49.2.1,TBA-FIISB|49.2.2,TBA-FIISB|49.3.1,TBA-FIISB|49.3.2,TBA-FIISB|50.2.1,TBA-FIISB|51.2.4,TBA-FIISB|51.2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "VirtualMachines") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: VirtualMachines, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<report type:"WARNING">
  description : "9.1.3.2 Ensure that 'Vulnerability assessment for machines' component status is set to 'On'"
  info        : "Enable vulnerability assessment for machines on both Azure and hybrid (Arc enabled) machines.

Vulnerability assessment for machines scans for various security-related configurations and events such as system updates, OS vulnerabilities, and endpoint protection, then produces alerts on threat and vulnerability findings.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - From Azure Home select the Portal Menu
 - Select Microsoft Defender for Cloud
 - Under Management select Environment Settings
 - Select a subscription
 - Click on Settings & Monitoring
 - Set the Status of Vulnerability assessment for machines to On
 - Click Continue

Repeat the above for any additional subscriptions.

Impact:

Microsoft Defender for Servers plan 2 licensing is required, and configuration of Azure Arc introduces complexity beyond this recommendation."
  reference   : "800-171|3.11.2,800-171|3.11.3,800-171r3|03.11.02,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.5,CSCv8|7.6,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.8.8,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2M,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "9.1.3.3 Ensure that 'Endpoint protection' component status is set to 'On'"
  info        : "The Endpoint protection component enables Microsoft Defender for Endpoint (formerly 'Advanced Threat Protection' or 'ATP' or 'WDATP' - see additional info) to communicate with Microsoft Defender for Cloud.

IMPORTANT: When enabling integration between DfE & DfC it needs to be taken into account that this will have some side effects that may be undesirable.

 - For server 2019 & above if defender is installed (default for these server SKUs) this will trigger a deployment of the new unified agent and link to any of the extended configuration in the Defender portal.
 - If the new unified agent is required for server SKUs of Win 2016 or Linux and lower there is additional integration that needs to be switched on and agents need to be aligned.

Microsoft Defender for Endpoint integration brings comprehensive Endpoint Detection and Response (EDR) capabilities within Microsoft Defender for Cloud. This integration helps to spot abnormalities, as well as detect and respond to advanced attacks on endpoints monitored by Microsoft Defender for Cloud.

MDE works only with Standard Tier subscriptions.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - From Azure Home select the Portal Menu.
 - Go to Microsoft Defender for Cloud
 - Under Management select Environment Settings
 - Click on the subscription name.
 - Click Settings & monitoring
 - Set the Status for Endpoint protection to On
 - Click Continue

Remediate from Azure CLI

Use the below command to enable Standard pricing tier for Storage Accounts

az account get-access-token --query \"{subscription:subscription,accessToken:accessToken}\" --out tsv | xargs -L1 bash -c 'curl -X PUT -H \"Authorization: Bearer $1\" -H \"Content-Type: application/json\" https://management.azure.com/subscriptions/<subscriptionID>/providers/Microsoft.Security/settings/WDATP?api-version=2021-06-01 -d@\"input.json\"'

Where input.json contains the Request body json data as mentioned below.

{
  \"id\": \"/subscriptions/<Your_Subscription_Id>/providers/Microsoft.Security/settings/WDATP\",
  \"kind\": \"DataExportSettings\",
  \"type\": \"Microsoft.Security/settings\",
  \"properties\": {
    \"enabled\": true
  }
}

Impact:

Endpoint protection requires licensing and is included in these plans:

 - Defender for Servers plan 1
 - Defender for Servers plan 2"
  reference   : "800-171|3.11.2,800-171|3.11.3,800-171|3.14.2,800-171|3.14.4,800-171|3.14.5,800-171|3.14.6,800-171|3.14.7,800-171r3|03.11.02,800-171r3|03.14.02,800-171r3|03.14.06,800-53|RA-5,800-53|SI-3,800-53|SI-4,800-53r5|RA-5,800-53r5|SI-3,800-53r5|SI-4,CN-L3|7.1.3.5(a),CN-L3|7.1.3.6(b),CN-L3|8.1.4.5,CN-L3|8.1.9.6(a),CN-L3|8.1.9.6(b),CN-L3|8.1.10.5(b),CN-L3|8.1.10.6(f),CN-L3|8.1.10.7(a),CN-L3|8.1.10.7(b),CSCv7|3.1,CSCv8|7.5,CSCv8|10.1,CSCv8|13.2,CSF|DE.AE-1,CSF|DE.AE-2,CSF|DE.AE-3,CSF|DE.AE-4,CSF|DE.CM-1,CSF|DE.CM-4,CSF|DE.CM-5,CSF|DE.CM-6,CSF|DE.CM-7,CSF|DE.CM-8,CSF|DE.DP-2,CSF|DE.DP-3,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.DS-5,CSF|PR.IP-8,CSF|PR.IP-12,CSF|RS.AN-1,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|DE.AE-02,CSF2.0|DE.AE-03,CSF2.0|DE.CM-01,CSF2.0|DE.CM-06,CSF2.0|DE.CM-09,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.8.7,ISO-27001-2022|A.8.8,ISO-27001-2022|A.8.16,ISO/IEC-27001|A.12.2.1,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,ITSG-33|SI-3,ITSG-33|SI-4,LEVEL|2M,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|GS8a,PCI-DSSv3.2.1|5.1,PCI-DSSv3.2.1|5.1.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|5.2.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7,TBA-FIISB|49.2.1,TBA-FIISB|49.2.2,TBA-FIISB|49.3.1,TBA-FIISB|49.3.2,TBA-FIISB|50.2.1,TBA-FIISB|51.2.4,TBA-FIISB|51.2.7"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "9.1.3.4 Ensure that 'Agentless scanning for machines' component status is set to 'On'"
  info        : "Using disk snapshots, the agentless scanner scans for installed software, vulnerabilities, and plain text secrets.

The Microsoft Defender for Cloud agentless machine scanner provides threat detection, vulnerability detection, and discovery of sensitive information.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Audit from Azure Portal

 - From the Azure Portal Home page, select Microsoft Defender for Cloud
 - Under Management select Environment Settings
 - Select a subscription
 - Under Settings > Defender Plans click Settings & monitoring
 - Under the Component column, locate the row for Agentless scanning for machines
 - Select On
 - Click Continue in the top left

Repeat the above for any additional subscriptions.

Impact:

Agentless scanning for machines requires licensing and is included in these plans:

 - Defender CSPM
 - Defender for Servers plan 2"
  reference   : "800-171|3.11.2,800-171|3.11.3,800-171r3|03.11.02,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.5,CSCv8|7.6,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.8.8,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2M,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "9.1.3.5 Ensure that 'File Integrity Monitoring' component status is set to 'On'"
  info        : "File Integrity Monitoring (FIM) is a feature that monitors critical system files in Windows or Linux for potential signs of attack or compromise.

FIM provides a detection mechanism for compromised files. When FIM is enabled, critical system files are monitored for changes that might indicate a threat actor is attempting to modify system files for lateral compromise within a host operating system.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Audit from Azure Portal

 - From the Azure Portal Home page, select Microsoft Defender for Cloud
 - Under Management select Environment Settings
 - Select a subscription
 - Under Settings > Defender Plans click Settings & monitoring
 - Under the Component column, locate the row for File Integrity Monitoring
 - Select On
 - Click Continue in the top left

Repeat the above for any additional subscriptions.

Impact:

File Integrity Monitoring requires licensing and is included in these plans:

 - Defender for Servers plan 2"
  reference   : "800-171|3.11.2,800-171|3.11.3,800-171r3|03.11.02,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.5,CSCv8|7.6,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.8.8,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2M,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<custom_item>
  description    : "9.1.4.1 Ensure That Microsoft Defender for Containers Is Set To 'On'"
  info           : "Microsoft Defender for Containers helps improve, monitor, and maintain the security of containerized assets-including Kubernetes clusters, nodes, workloads, container registries, and images-across multi-cloud and on-premises environments.

By default, when enabling the plan through the Azure Portal, Microsoft Defender for Containers automatically configures the following components:

 - Agentless scanning for machines
 - Defender sensor for runtime protection
 - Azure Policy for enforcing security best practices
 - K8S API access for monitoring and threat detection
 - Registry access for vulnerability assessment

Note: Microsoft Defender for Container Registries ('ContainerRegistry') is deprecated and has been replaced by Microsoft Defender for Containers ('Containers').

Enabling Microsoft Defender for Containers enhances defense-in-depth by providing advanced threat detection, vulnerability assessment, and security monitoring for containerized environments, leveraging insights from the Microsoft Security Response Center (MSRC)."
  solution       : "Remediate from Azure Portal

 - Go to Microsoft Defender for Cloud
 - Under Management click Environment settings
 - Click the name of a subscription.
 - Under Settings click Defender plans
 - Under Cloud Workload Protection (CWP) in the row for Containers click On in the Status column.
 - If Monitoring coverage displays Partial click Settings under Partial
 - Set the status of each of the components to On
 - Click Continue
 - Click Save
 - Repeat steps 1-9 for each subscription.

Remediate from Azure CLI

Note: Microsoft Defender for Container Registries ('ContainerRegistry') is deprecated and has been replaced by Microsoft Defender for Containers ('Containers').

Run the below command to enable the Microsoft Defender for Containers plan and its components:

az security pricing create -n 'Containers' --tier 'standard' --extensions name=ContainerRegistriesVulnerabilityAssessments isEnabled=True --extensions name=AgentlessDiscoveryForKubernetes isEnabled=True --extensions name=AgentlessVmScanning isEnabled=True --extensions name=ContainerSensor isEnabled=True

Remediate from PowerShell

Note: Microsoft Defender for Container Registries ('ContainerRegistry') is deprecated and has been replaced by Microsoft Defender for Containers ('Containers').

Run the below command to enable the Microsoft Defender for Containers plan and its components:

Set-AzSecurityPricing -Name 'Containers' -PricingTier 'Standard' -Extension '[{\"name\":\"ContainerRegistriesVulnerabilityAssessments\",\"isEnabled\":\"True\"},{\"name\":\"AgentlessDiscoveryForKubernetes\",\"isEnabled\":\"True\"},{\"name\":\"AgentlessVmScanning\",\"isEnabled\":\"True\"},{\"name\":\"ContainerSensor\",\"isEnabled\":\"True\"}]'

Impact:

Microsoft Defender for Containers incurs a charge per vCore. Refer to

https://azure.microsoft.com/en-us/pricing/details/defender-for-cloud/

and

https://azure.microsoft.com/en-us/pricing/calculator/

to estimate potential costs."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-171r3|03.11.02,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.5,CSCv8|7.6,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.8.8,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "Containers") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: Containers, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "9.1.5.1 Ensure That Microsoft Defender for Storage Is Set To 'On'"
  info           : "Turning on Microsoft Defender for Storage enables threat detection for Storage, providing threat intelligence, anomaly detection, and behavior analytics in the Microsoft Defender for Cloud.

Enabling Microsoft Defender for Storage allows for greater defense-in-depth, with threat detection provided by the Microsoft Security Response Center (MSRC)."
  solution       : "Remediate from Azure Portal

 - Go to Microsoft Defender for Cloud
 - Under Management select Environment Settings
 - Click on the subscription name.
 - Select the Defender plans blade.
 - Set Status to On for Storage
 - Select Save

Remediate from Azure CLI

Ensure the output of the below command is Standard

az security pricing create -n StorageAccounts --tier 'standard'

Remediate from PowerShell

Set-AzSecurityPricing -Name 'StorageAccounts' -PricingTier 'Standard'

Impact:

Turning on Microsoft Defender for Storage incurs an additional cost per resource."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-171r3|03.11.02,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.5,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.8.8,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "StorageAccounts") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: StorageAccounts, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "9.1.6.1 Ensure That Microsoft Defender for App Services Is Set To 'On'"
  info           : "Turning on Microsoft Defender for App Service enables threat detection for App Service, providing threat intelligence, anomaly detection, and behavior analytics in the Microsoft Defender for Cloud.

Enabling Microsoft Defender for App Service allows for greater defense-in-depth, with threat detection provided by the Microsoft Security Response Center (MSRC)."
  solution       : "Remediate from Azure Portal

 - Go to Microsoft Defender for Cloud
 - Under Management select Environment Settings
 - Click on the subscription name
 - Select Defender plans
 - Set App Service Status to On
 - Select Save

Remediate from Azure CLI

Run the following command:

az security pricing create -n Appservices --tier 'standard'

Remediate from PowerShell

Run the following command:

Set-AzSecurityPricing -Name \"AppServices\" -PricingTier \"Standard\"

Impact:

Turning on Microsoft Defender for App Service incurs an additional cost per resource."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-171r3|03.11.02,800-53|RA-5,800-53|SA-15,800-53r5|RA-5,800-53r5|SA-15,CSCv7|3.1,CSCv8|7.5,CSCv8|7.6,CSCv8|16.11,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-2,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|ID.RA-09,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.5.8,ISO-27001-2022|A.8.8,ISO-27001-2022|A.8.25,ISO-27001-2022|A.8.26,ISO-27001-2022|A.8.30,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|SS5,NIAv2|SS6a,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "AppServices") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: AppServices, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "9.1.7.1 Ensure That Microsoft Defender for Azure Cosmos DB Is Set To 'On'"
  info           : "Microsoft Defender for Azure Cosmos DB scans all incoming network requests for threats to your Azure Cosmos DB resources.

In scanning Azure Cosmos DB requests within a subscription, requests are compared to a heuristic list of potential security threats. These threats could be a result of a security breach within your services, thus scanning for them could prevent a potential security threat from being introduced."
  solution       : "Remediate from Azure Portal

 - Go to Microsoft Defender for Cloud
 - Under Management select Environment Settings
 - Click on the subscription name.
 - Select the Defender plans blade.
 - On the Database row click on Select types >
 - Set the toggle switch next to Azure Cosmos DB to On
 - Click Continue
 - Click Save

Remediate from Azure CLI

Run the following command:

az security pricing create -n 'CosmosDbs' --tier 'standard'

Remediate from PowerShell

Use the below command to enable Standard pricing tier for Azure Cosmos DB

Set-AzSecurityPricing -Name 'CosmosDbs' -PricingTier 'Standard

Impact:

Enabling Microsoft Defender for Azure Cosmos DB requires enabling Microsoft Defender for your subscription. Both will incur additional charges."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-171r3|03.11.02,800-53|RA-5,800-53|SA-15,800-53r5|RA-5,800-53r5|SA-15,CSCv7|3.1,CSCv8|7.5,CSCv8|16.11,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-2,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|ID.RA-09,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.5.8,ISO-27001-2022|A.8.8,ISO-27001-2022|A.8.25,ISO-27001-2022|A.8.26,ISO-27001-2022|A.8.30,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|SS5,NIAv2|SS6a,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "CosmosDbs") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: CosmosDbs, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "9.1.7.2 Ensure That Microsoft Defender for Open-Source Relational Databases Is Set To 'On'"
  info           : "Turning on Microsoft Defender for Open-source relational databases enables threat detection for Open-source relational databases, providing threat intelligence, anomaly detection, and behavior analytics in the Microsoft Defender for Cloud.

Enabling Microsoft Defender for Open-source relational databases allows for greater defense-in-depth, with threat detection provided by the Microsoft Security Response Center (MSRC)."
  solution       : "Remediate from Azure Portal

 - Go to Microsoft Defender for Cloud
 - Under Management select Environment Settings
 - Click on the subscription name.
 - Select the Defender plans blade.
 - Click Select types > in the row for Databases
 - Set the toggle switch next to Open-source relational databases to On
 - Select Continue
 - Select Save

Remediate from Azure CLI

Run the following command:

az security pricing create -n 'OpenSourceRelationalDatabases' --tier 'standard'

Remediate from PowerShell

Use the below command to enable Standard pricing tier for Open-source relational databases

set-azsecuritypricing -name \"OpenSourceRelationalDatabases\" -pricingtier \"Standard\"

Impact:

Turning on Microsoft Defender for Open-source relational databases incurs an additional cost per resource."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-171r3|03.11.02,800-53|RA-5,800-53|SA-15,800-53r5|RA-5,800-53r5|SA-15,CSCv7|3.1,CSCv8|7.5,CSCv8|16.11,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-2,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|ID.RA-09,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.5.8,ISO-27001-2022|A.8.8,ISO-27001-2022|A.8.25,ISO-27001-2022|A.8.26,ISO-27001-2022|A.8.30,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|SS5,NIAv2|SS6a,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "OpenSourceRelationalDatabases") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: OpenSourceRelationalDatabases, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "9.1.7.3 Ensure That Microsoft Defender for (Managed Instance) Azure SQL Databases Is Set To 'On'"
  info           : "Turning on Microsoft Defender for Azure SQL Databases enables threat detection for Managed Instance Azure SQL databases, providing threat intelligence, anomaly detection, and behavior analytics in Microsoft Defender for Cloud.

Enabling Microsoft Defender for Azure SQL Databases allows for greater defense-in-depth, includes functionality for discovering and classifying sensitive data, surfacing and mitigating potential database vulnerabilities, and detecting anomalous activities that could indicate a threat to your database."
  solution       : "Remediate from Azure Portal

 - Go to Microsoft Defender for Cloud
 - Under Management select Environment Settings
 - Click on the subscription name.
 - Select the Defender plans blade.
 - Click Select types > in the row for Databases
 - Set the toggle switch next to Azure SQL Databases to On
 - Select Continue
 - Select Save

Remediate from Azure CLI

Run the following command:

az security pricing create -n SqlServers --tier 'standard'

Remediate from PowerShell

Run the following command:

Set-AzSecurityPricing -Name 'SqlServers' -PricingTier 'Standard'

Impact:

Turning on Microsoft Defender for Azure SQL Databases incurs an additional cost per resource."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-171r3|03.11.02,800-53|RA-5,800-53|SA-15,800-53r5|RA-5,800-53r5|SA-15,CSCv7|3.1,CSCv8|7.5,CSCv8|16.11,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-2,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|ID.RA-09,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.5.8,ISO-27001-2022|A.8.8,ISO-27001-2022|A.8.25,ISO-27001-2022|A.8.26,ISO-27001-2022|A.8.30,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|SS5,NIAv2|SS6a,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "SqlServers") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: SqlServers, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "9.1.7.4 Ensure That Microsoft Defender for SQL Servers on Machines Is Set To 'On'"
  info           : "Turning on Microsoft Defender for SQL servers on machines enables threat detection for SQL servers on machines, providing threat intelligence, anomaly detection, and behavior analytics in Microsoft Defender for Cloud.

Enabling Microsoft Defender for SQL servers on machines allows for greater defense-in-depth, functionality for discovering and classifying sensitive data, surfacing and mitigating potential database vulnerabilities, and detecting anomalous activities that could indicate a threat to your database."
  solution       : "Remediate from Azure Portal

 - Go to Microsoft Defender for Cloud
 - Under Management select Environment Settings
 - Click on the subscription name.
 - Select the Defender plans blade.
 - Click Select types > in the row for Databases
 - Set the toggle switch next to SQL servers on machines to On
 - Select Continue
 - Select Save

Remediate from Azure CLI

Run the following command:

az security pricing create -n SqlServerVirtualMachines --tier 'standard'

Remediate from PowerShell

Run the following command:

Set-AzSecurityPricing -Name 'SqlServerVirtualMachines' -PricingTier 'Standard'

Impact:

Turning on Microsoft Defender for SQL servers on machines incurs an additional cost per resource."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-171r3|03.11.02,800-53|RA-5,800-53|SA-15,800-53r5|RA-5,800-53r5|SA-15,CSCv7|3.1,CSCv8|7.5,CSCv8|16.11,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-2,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|ID.RA-09,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.5.8,ISO-27001-2022|A.8.8,ISO-27001-2022|A.8.25,ISO-27001-2022|A.8.26,ISO-27001-2022|A.8.30,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|SS5,NIAv2|SS6a,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "SqlServerVirtualMachines") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: SqlServerVirtualMachines, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "9.1.8.1 Ensure That Microsoft Defender for Key Vault Is Set To 'On'"
  info           : "Turning on Microsoft Defender for Key Vault enables threat detection for Key Vault, providing threat intelligence, anomaly detection, and behavior analytics in the Microsoft Defender for Cloud.

Enabling Microsoft Defender for Key Vault allows for greater defense-in-depth, with threat detection provided by the Microsoft Security Response Center (MSRC)."
  solution       : "Remediate from Azure Portal

 - Go to Microsoft Defender for Cloud
 - Under Management select Environment Settings
 - Click on the subscription name.
 - Select the Defender plans blade.
 - Select On under Status for Key Vault
 - Select Save

Remediate from Azure CLI

Enable Standard pricing tier for Key Vault:

az security pricing create -n 'KeyVaults' --tier 'Standard'

Remediate from PowerShell

Enable Standard pricing tier for Key Vault:

Set-AzSecurityPricing -Name 'KeyVaults' -PricingTier 'Standard'

Impact:

Turning on Microsoft Defender for Key Vault incurs an additional cost per resource."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-171r3|03.11.02,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.5,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.8.8,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "KeyVaults") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: KeyVaults, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "9.1.9.1 Ensure That Microsoft Defender for Resource Manager Is Set To 'On'"
  info           : "Microsoft Defender for Resource Manager scans incoming administrative requests to change your infrastructure from both CLI and the Azure portal.

Scanning resource requests lets you be alerted every time there is suspicious activity in order to prevent a security threat from being introduced."
  solution       : "Remediate from Azure Portal

 - Go to Microsoft Defender for Cloud
 - Under Management select Environment Settings
 - Click on the subscription name.
 - Select the Defender plans blade.
 - Select On under Status for Resource Manager
 - Select `Save.

Remediate from Azure CLI

Use the below command to enable Standard pricing tier for Defender for Resource Manager

az security pricing create -n 'Arm' --tier 'Standard'

Remediate from PowerShell

Use the below command to enable Standard pricing tier for Defender for Resource Manager

Set-AzSecurityPricing -Name 'Arm' -PricingTier 'Standard'

Impact:

Enabling Microsoft Defender for Resource Manager requires enabling Microsoft Defender for your subscription. Both will incur additional charges."
  reference      : "800-171|3.1.5,800-171|3.1.6,800-171|3.11.2,800-171|3.11.3,800-171r3|03.01.06a.,800-171r3|03.01.06b.,800-171r3|03.11.02,800-53|AC-6(2),800-53|AC-6(5),800-53|RA-5,800-53r5|AC-6(2),800-53r5|AC-6(5),800-53r5|RA-5,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.10.6(a),CSCv7|3.1,CSCv8|5.4,CSCv8|7.5,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.AC-4,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|PR.AA-05,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO-27001-2022|A.5.15,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.8,ISO-27001-2022|A.8.18,ISO/IEC-27001|A.9.2.3,ISO/IEC-27001|A.12.6.1,ITSG-33|AC-6(2),ITSG-33|AC-6(5),ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.6.1,NESA|T7.7.1,NIAv2|AM1,NIAv2|AM23f,NIAv2|AM32,NIAv2|AM33,NIAv2|SS13c,NIAv2|SS15c,NIAv2|VL3a,PCI-DSSv3.2.1|6.1,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|1.2,SWIFT-CSCv1|2.7,SWIFT-CSCv1|5.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "Arm") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: Arm, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<report type:"WARNING">
  description : "9.2.1 Ensure That Microsoft Defender for IoT Hub Is Set To 'On'"
  info        : "Microsoft Defender for IoT acts as a central security hub for IoT devices within your organization.

IoT devices are very rarely patched and can be potential attack vectors for enterprise networks. Updating their network configuration to use a central security hub allows for detection of these breaches.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

 - Go to IoT Hub
 - Select an IoT Hub to validate.
 - Select Overview in Defender for IoT
 - Click on Secure your IoT solution and complete the onboarding.

Impact:

Enabling Microsoft Defender for IoT will incur additional charges dependent on the level of usage."
  reference   : "800-171|3.11.2,800-171|3.11.3,800-171|3.14.6,800-171|3.14.7,800-171r3|03.11.02,800-171r3|03.14.06,800-53|RA-5,800-53|SI-4,800-53|SI-4(4),800-53r5|RA-5,800-53r5|SI-4,800-53r5|SI-4(4),CN-L3|7.1.2.2(c),CN-L3|7.1.3.5(a),CN-L3|8.1.10.5(b),CN-L3|8.1.10.6(f),CSCv7|3.1,CSCv8|7.5,CSCv8|13.6,CSF|DE.AE-1,CSF|DE.AE-2,CSF|DE.AE-3,CSF|DE.AE-4,CSF|DE.CM-1,CSF|DE.CM-5,CSF|DE.CM-6,CSF|DE.CM-7,CSF|DE.CM-8,CSF|DE.DP-2,CSF|DE.DP-3,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.DS-5,CSF|PR.IP-8,CSF|PR.IP-12,CSF|RS.AN-1,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|DE.AE-02,CSF2.0|DE.AE-03,CSF2.0|DE.CM-01,CSF2.0|DE.CM-06,CSF2.0|DE.CM-09,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.8.8,ISO-27001-2022|A.8.16,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,ITSG-33|SI-4,ITSG-33|SI-4(4),LEVEL|2M,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|NS32,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7,SWIFT-CSCv1|6.5"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<report type:"WARNING">
  description : "9.3.10 Ensure that Azure Key Vault Managed HSM is used when required"
  info        : "Azure Key Vault Managed HSM is a fully managed, highly available, single-tenant cloud service that safeguards cryptographic keys using FIPS 140-2 Level 3 validated HSMs.

Note: This recommendation to use Managed HSM applies only to scenarios where specific regulatory and compliance requirements mandate the use of a dedicated hardware security module.

Managed HSM is a fully managed, highly available, single-tenant service that ensures FIPS 140-2 Level 3 compliance. It provides centralized key management, isolated access control, and private endpoints for secure access. Integrated with Azure services, it supports migration from Key Vault, ensures data residency, and offers monitoring and auditing for enhanced security.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure CLI

Run the following command to set oid to be the OID of the signed-in user:

$oid = az ad signed-in-user show --query id -o tsv

Alternatively, prepare a space-separated list of OIDs to be provided as the administrators of the HSM.

Run the following command to create a Managed HSM:

az keyvault create --resource-group <resource-group> --hsm-name <hsm-name> --retention-days <retention-days> --administrators $oid

The command can take several minutes to complete.

After the HSM has been created, it must be activated before it can be used. Activation requires providing a minimum of three and a maximum of ten RSA key pairs, as well as the minimum number of keys required to decrypt the security domain (called a quorum).

OpenSSL can be used to generate the self-signed certificates, for example:

openssl req -newkey rsa:2048 -nodes -keyout cert_1.key -x509 -days 365 -out cert_1.cer

Run the following command to download the security domain and activate the Managed HSM:

az keyvault security-domain download --hsm-name <managed-hsm> --sd-wrapping-keys <key-1> <key-2> <key-3> --sd-quorum <quorum> --security-domain-file <managed-hsm-security-domain>.json

Store the security domain file and the RSA key pairs securely. They will be required for disaster recovery or for creating another Managed HSM that shares the same security domain so that the two can share keys.

The Managed HSM will now be in an active state and ready for use.

Impact:

Managed HSM incurs a cost of $0.40 to $5 per month for each actively used HSM-protected key, depending on the key type and quantity. Each key version is billed separately. Additionally, there is an hourly usage fee of $3.20 per Managed HSM pool."
  reference   : "800-171|3.13.4,800-171r3|03.13.04,800-53|SC-4,800-53r5|SC-4,CSCv7|2.10,CSCv8|3.12,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),ITSG-33|SC-4,ITSG-33|SC-4a.,LEVEL|2M"
  see_also    : "https://workbench.cisecurity.org/benchmarks/19304"
</report>

<custom_item>
  description    : "9.3.6 Ensure that Role Based Access Control for Azure Key Vault is enabled"
  info           : "The recommended way to access Key Vaults is to use the Azure Role-Based Access Control (RBAC) permissions model.

Azure RBAC is an authorization system built on Azure Resource Manager that provides fine-grained access management of Azure resources. It allows users to manage Key, Secret, and Certificate permissions. It provides one place to manage all permissions across all key vaults.

The new RBAC permissions model for Key Vaults enables a much finer grained access control for key vault secrets, keys, certificates, etc., than the vault access policy. This in turn will permit the use of privileged identity management over these roles, thus securing the key vaults with JIT Access management."
  solution       : "Remediate from Azure Portal

Key Vaults can be configured to use Azure role-based access control on creation.

For existing Key Vaults:

 - From Azure Home open the Portal Menu in the top left corner
 - Select Key Vaults
 - Select a Key Vault to audit
 - Select Access configuration
 - Set the Permission model radio button to Azure role-based access control taking note of the warning message
 - Click Save
 - Select Access Control (IAM)
 - Select the Role Assignments tab
 - Reapply permissions as needed to groups or users

Remediate from Azure CLI

To enable RBAC Authorization for each Key Vault, run the following Azure CLI command:

az keyvault update --resource-group <resource_group> --name <vault_name> --enable-rbac-authorization true

Remediate from PowerShell

To enable RBAC authorization on each Key Vault, run the following PowerShell command:

Update-AzKeyVault -ResourceGroupName <resource_group> -VaultName <vault_name> -EnableRbacAuthorization $True

Impact:

Implementation needs to be properly designed from the ground up, as this is a fundamental change to the way key vaults are accessed/managed. Changing permissions to key vaults will result in loss of service as permissions are re-applied. For the least amount of downtime, map your current groups and users to their corresponding permission needs."
  reference      : "800-171|3.1.1,800-171|3.1.4,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-171r3|03.01.01,800-171r3|03.01.02,800-171r3|03.01.04,800-171r3|03.01.05,800-171r3|03.01.05a.,800-171r3|03.01.05b.,800-171r3|03.03.08b.,800-171r3|03.08.02,800-53|AC-2,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53|MP-2,800-53r5|AC-2,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),800-53r5|MP-2,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|3.3,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-2,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.5.3,ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.33,ISO-27001-2022|A.7.7,ISO-27001-2022|A.7.10,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.15,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),ITSG-33|MP-2,ITSG-33|MP-2a.,LEVEL|2A,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listVaultsByResourceGroup"
  json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgn|.vaults[]|select(.properties != null)|"Subscription ID: \($subid), Resource Group: \($rgn), Vault Name: \(.name), Enable RBAC Authorization: \(.properties.enableRbacAuthorization)"'
  expect         : "Enable RBAC Authorization: true"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "9.3.7 Ensure that Public Network Access when using Private Endpoint is disabled"
  info           : "When Private endpoint is configured on a Key Vault, connections from Azure resources within the same subnet will use its private IP address. However, network traffic from the public internet can still flow connect to the Key Vault's public endpoint (mykeyvault.vault.azure.net) using its public IP address unless Public network access is set to \"Disabled\".

Setting the Public network access to \"Disabled\" with a Private Endpoint will remove the Vault's public endpoint from Azure public DNS, reducing its exposure to the public internet. Network traffic will use the Vault private endpoint IP address for all requests (mykeyvault.vault.privatelink.azure.net).

Removing a point of interconnection from the internet edge to your Key Vault can strengthen the network security boundary of your system and reduce the risk of exposing the control plane or vault objects to untrusted clients.

Although Azure resources are never truly isolated from the public internet, disabling the public endpoint removes a line of sight from the public internet and increases the effort required for an attack.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
  solution       : "Remediate from Azure Portal

Key Vaults can be configured to use Azure role-based access control on creation.

For existing Key Vaults:

 - From Azure Home open the Portal Menu in the top left corner
 - Select Key Vaults
 - Select a Key Vault to audit
 - Select Networking
 - NEXT

Remediate from Azure CLI

To disable Public network access for each Key Vault, run the following Azure CLI command:

az keyvault update --resource-group <resource_group> --name <vault_name> --public-network-access Disabled

Remediate from PowerShell

To enable RBAC authorization on each Key Vault, run the following PowerShell command:

Update-AzKeyVault -ResourceGroupName <resource_group> -VaultName <vault_name> -PublicNetworkAccess \"Disabled\"

Impact:

Implementation needs to be properly designed from the ground up, as this is a fundamental change to the network architecture of your system. It will increase the configuration effort and decrease the usability of the Key Vault, and is appropriate for workloads where security is the primary consideration."
  reference      : "800-171|3.1.1,800-171|3.1.4,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-171r3|03.01.01,800-171r3|03.01.02,800-171r3|03.01.04,800-171r3|03.01.05,800-171r3|03.01.05a.,800-171r3|03.01.05b.,800-171r3|03.03.08b.,800-171r3|03.08.02,800-53|AC-2,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53|MP-2,800-53r5|AC-2,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),800-53r5|MP-2,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|3.3,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-2,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO-27001-2022|A.5.3,ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.33,ISO-27001-2022|A.7.7,ISO-27001-2022|A.7.10,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.15,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),ITSG-33|MP-2,ITSG-33|MP-2a.,LEVEL|2A,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listVaultDetails"
  json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgn|.vaults[]|select(.properties != null)|"Subscription ID: \($subid), Resource Group: \($rgn), Vault Name: \(.name), Public Network Setting: \(.properties.publicNetworkAccess)"'
  not_expect     : ".+"
  severity       : MEDIUM
</custom_item>

<custom_item>
  description    : "9.3.8 Ensure that Private Endpoints are Used for Azure Key Vault"
  info           : "Private endpoints will secure network traffic from Azure Key Vault to the resources requesting secrets and keys.

Private endpoints will keep network requests to Azure Key Vault limited to the endpoints attached to the resources that are whitelisted to communicate with each other. Assigning the Key Vault to a network without an endpoint will allow other resources on that network to view all traffic from the Key Vault to its destination. In spite of the complexity in configuration, this is recommended for high security secrets."
  solution       : "Please see the additional information about the requirements needed before starting this remediation procedure.

Remediate from Azure Portal

 - From Azure Home open the Portal Menu in the top left.
 - Select Key Vaults.
 - Select a Key Vault to audit.
 - Select Networking in the left column.
 - Select Private endpoint connections from the top row.
 - Select + Create
 - Select the subscription the Key Vault is within, and other desired configuration.
 - Select Next
 - For resource type select Microsoft.KeyVault/vaults
 - Select the Key Vault to associate the Private Endpoint with.
 - Select Next
 - In the Virtual Networking field, select the network to assign the Endpoint.
 - Select other configuration options as desired, including an existing or new application security group.
 - Select Next
 - Select the private DNS the Private Endpoints will use.
 - Select Next
 - Optionally add Tags
 - Select Next : Review + Create
 - Review the information and select Create Follow the Audit Procedure to determine if it has successfully applied.
 - Repeat steps 3-19 for each Key Vault.

Remediate from Azure CLI

 - To create an endpoint, run the following command:

az network private-endpoint create --resource-group <resourceGroup --vnet-name <vnetName> --subnet <subnetName> --name <PrivateEndpointName> --private-connection-resource-id \"/subscriptions/<AZURE SUBSCRIPTION ID>/resourceGroups/<resourceGroup>/providers/Microsoft.KeyVault/vaults/<keyVaultName>\" --group-ids vault --connection-name <privateLinkConnectionName> --location <azureRegion> --manual-request <xhtml:ol start=\"2\"> - To manually approve the endpoint request, run the following command:

az keyvault private-endpoint-connection approve --resource-group <resourceGroup> --vault-name <keyVaultName> -name <privateLinkName> <xhtml:ol start=\"3\"> -

Determine the Private Endpoint's IP address to connect the Key Vault to the Private DNS you have previously created:

 -

Look for the property networkInterfaces then id; the value must be placed in the variable <privateEndpointNIC> within step 7.

az network private-endpoint show -g <resourceGroupName> -n <privateEndpointName> <xhtml:ol start=\"5\"> - Look for the property networkInterfaces then id; the value must be placed on <privateEndpointNIC> in step 7.

az network nic show --ids <privateEndpointName> <xhtml:ol start=\"6\"> - Create a Private DNS record within the DNS Zone you created for the Private Endpoint:

az network private-dns record-set a add-record -g <resourcecGroupName> -z \"privatelink.vaultcore.azure.net\" -n <keyVaultName> -a <privateEndpointNIC> <xhtml:ol start=\"7\"> - nslookup the private endpoint to determine if the DNS record is correct:

nslookup <keyVaultName>.vault.azure.net
nslookup <keyVaultName>.privatelink.vaultcore.azure.n

Impact:

Incorrect or poorly-timed changing of network configuration could result in service interruption. There are also additional costs tiers for running a private endpoint per petabyte or more of networking traffic."
  reference      : "800-171|3.4.6,800-171|3.4.7,800-171|3.13.1,800-171|3.13.2,800-171|3.13.5,800-171r3|03.04.06,800-171r3|03.13.01,800-171r3|03.16.01,800-53|CM-7,800-53|CP-6,800-53|CP-7,800-53|PL-8,800-53|PM-7,800-53|SA-8,800-53|SC-7,800-53r5|CM-7,800-53r5|CP-6,800-53r5|CP-7,800-53r5|PL-8,800-53r5|PM-7,800-53r5|SA-8,800-53r5|SC-7,CN-L3|8.1.10.6(j),CSCv7|14.1,CSCv8|12.2,CSF|DE.CM-1,CSF|ID.AM-3,CSF|PR.AC-5,CSF|PR.DS-5,CSF|PR.IP-1,CSF|PR.IP-2,CSF|PR.IP-4,CSF|PR.PT-3,CSF|PR.PT-4,CSF2.0|DE.CM-01,CSF2.0|ID.AM-03,CSF2.0|ID.AM-08,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.DS-11,CSF2.0|PR.IR-01,CSF2.0|PR.IR-03,CSF2.0|PR.IR-04,CSF2.0|PR.PS-01,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.c,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO-27001-2022|A.5.8,ISO-27001-2022|A.5.14,ISO-27001-2022|A.5.29,ISO-27001-2022|A.7.5,ISO-27001-2022|A.8.14,ISO-27001-2022|A.8.16,ISO-27001-2022|A.8.20,ISO-27001-2022|A.8.27,ISO-27001-2022|A.8.28,ISO/IEC-27001|A.13.1.3,ITSG-33|CM-7,ITSG-33|CP-6,ITSG-33|CP-7,ITSG-33|SA-8,ITSG-33|SA-8a.,ITSG-33|SC-7,LEVEL|2A,NESA|T2.2.4,NESA|T3.4.1,NESA|T4.5.3,NESA|T4.5.4,NESA|T7.6.5,NIAv2|GS1,NIAv2|GS2a,NIAv2|GS2b,NIAv2|SS3,NIAv2|SS15a,NIAv2|VL2,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv3.2.1|2.2.2,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,SWIFT-CSCv1|2.3,TBA-FIISB|43.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listVaultsByResourceGroup"
  json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgn|.vaults[]|select(.properties != null)|"Subscription ID: \($subid), Resource Group: \($rgn), Vault Name: \(.name), Private Endpoint Connections: \(.properties.privateEndpointConnections | length)"'
  not_expect     : "Private Endpoint Connections: 0"
</custom_item>

<custom_item>
  description    : "9.3.9 Ensure automatic key rotation is enabled within Azure Key Vault"
  info           : "Automated cryptographic key rotation in Key Vault allows users to configure Key Vault to automatically generate a new key version at a specified frequency. A key rotation policy can be defined for each individual key.

Automatic key rotation reduces risk by ensuring that keys are rotated without manual intervention.

Azure and NIST recommend that keys be rotated every two years or less. Refer to 'Table 1: Suggested cryptoperiods for key types' on page 46 of the following document for more information:

https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-57pt1r5.pdf

.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
  solution       : "Note: Azure CLI and PowerShell use the ISO8601 duration format for time spans. The format is P<timespanInISO8601Format>(Y,M,D) The leading P is required and is referred to as period The (Y,M,D) are for the duration of Year, Month, and Day, respectively. A time frame of 2 years, 2 months, 2 days would be P2Y2M2D For Azure CLI and PowerShell, it is easiest to supply the policy flags in ajson file for example:

{
  \"lifetimeActions\": [
    {
      \"trigger\": {
        \"timeAfterCreate\": \"P<timespanInISO8601Format>(Y,M,D)\",
        \"timeBeforeExpiry\" : null
      },
      \"action\": {
        \"type\": \"Rotate\"
      }
    },
    {
      \"trigger\": {
        \"timeBeforeExpiry\" : \"P<timespanInISO8601Format>(Y,M,D)\"
      },
      \"action\": {
        \"type\": \"Notify\"
      }
    }
  ],
  \"attributes\": {
    \"expiryTime\": \"P<timespanInISO8601Format>(Y,M,D)\"
  }
}

Remediate from Azure Portal

 - Go to Key Vaults
 - Select a Key Vault.
 - Under Objects select Keys
 - Select a key.
 - From the top row, select Rotation policy
 - Select an appropriate Expiry time
 - Set Enable auto rotation to Enabled
 - Set an appropriate Rotation option and Rotation time
 - Optionally, set a Notification time
 - Click Save
 - Repeat steps 1-10 for each Key Vault and Key.

Remediate from Azure CLI

Run the following command for each key to enable automatic rotation:

az keyvault key rotation-policy update --vault-name <vault-name> --name <key-name> --value <path/to/policy.json>

Remediate from PowerShell

Run the following command for each key to enable automatic rotation:

Set-AzKeyVaultKeyRotationPolicy -VaultName <vault-name> -Name <key-name> -PolicyPath <path/to/policy.json>

Impact:

There is an additional cost for each scheduled key rotation."
  reference      : "800-171|3.1.1,800-171r3|03.01.01,800-171r3|03.15.01,800-53|AC-1,800-53|AC-2,800-53|AC-2(1),800-53r5|AC-1,800-53r5|AC-2,800-53r5|AC-2(1),CN-L3|7.1.3.2(d),CN-L3|8.1.4.2(e),CN-L3|8.1.10.6(c),CSCv7|16.7,CSCv8|6.2,CSF|DE.CM-1,CSF|DE.CM-3,CSF|ID.GV-1,CSF|ID.GV-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|GV.OC-03,CSF2.0|GV.OV-01,CSF2.0|GV.PO-01,CSF2.0|GV.PO-02,CSF2.0|GV.SC-03,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO-27001-2022|A.5.1,ISO-27001-2022|A.5.2,ISO-27001-2022|A.5.4,ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.16,ISO-27001-2022|A.5.18,ISO-27001-2022|A.5.31,ISO-27001-2022|A.5.36,ISO-27001-2022|A.5.37,ISO-27001-2022|A.8.2,ISO-27001-2022|5.2,ISO-27001-2022|5.3,ISO-27001-2022|7.5.1,ISO-27001-2022|7.5.2,ISO-27001-2022|7.5.3,ISO/IEC-27001|A.9.1.1,ISO/IEC-27001|A.9.2.1,ITSG-33|AC-1,ITSG-33|AC-2,ITSG-33|AC-2(1),LEVEL|2A,NESA|M1.2.2,NIAv2|AM28,NIAv2|AM29,NIAv2|AM30,NIAv2|NS5j,NIAv2|SS14e,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listVaultsByResourceGroup"
  json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgn|.vaults[]|"Subscription ID: \($subid), Resource Group: \($rgn), Vault Name: \(.name)"'
  not_expect     : ".+"
  severity       : MEDIUM
</custom_item>

<custom_item>
  description    : "9.4.1 Ensure an Azure Bastion Host Exists"
  info           : "The Azure Bastion service allows secure remote access to Azure Virtual Machines over the Internet without exposing remote access protocol ports and services directly to the Internet. The Azure Bastion service provides this access using TLS over 443/TCP, and subscribes to hardened configurations within an organization's Azure Active Directory service.

The Azure Bastion service allows organizations a more secure means of accessing Azure Virtual Machines over the Internet without assigning public IP addresses to those Virtual Machines. The Azure Bastion service provides Remote Desktop Protocol (RDP) and Secure Shell (SSH) access to Virtual Machines using TLS within a web browser, thus preventing organizations from opening up 3389/TCP and 22/TCP to the Internet on Azure Virtual Machines. Additional benefits of the Bastion service includes Multi-Factor Authentication, Conditional Access Policies, and any other hardening measures configured within Azure Active Directory using a central point of access."
  solution       : "Remediate from Azure Portal

 - Click on Bastions
 - Select the Subscription
 - Select the Resource group
 - Type a Name for the new Bastion host
 - Select a Region
 - Choose Standard next to Tier
 - Use the slider to set the Instance count
 - Select the Virtual network or Create new
 - Select the Subnet named AzureBastionSubnet Create a Subnet named AzureBastionSubnet using a /26 CIDR range if it doesn't already exist.
 - Select the appropriate Public IP address option.
 - If Create new is selected for the Public IP address option, provide a Public IP address name
 - If Use existing is selected for Public IP address option, select an IP address from Choose public IP address
 - Click Next: Tags >
 - Configure the appropriate Tags
 - Click Next: Advanced >
 - Select the appropriate Advanced options
 - Click Next: Review + create >
 - Click Create

Remediate from Azure CLI

az network bastion create --location <location> --name <name of bastion host> --public-ip-address <public IP address name or ID> --resource-group <resource group name or ID> --vnet-name <virtual network containing subnet called \"AzureBastionSubnet\"> --scale-units <integer> --sku Standard [--disable-copy-paste true|false] [--enable-ip-connect true|false] [--enable-tunneling true|false]

Remediate from PowerShell

Create the appropriate Virtual network settings and Public IP Address settings.

$subnetName = \"AzureBastionSubnet\"
$subnet = New-AzVirtualNetworkSubnetConfig -Name $subnetName -AddressPrefix <IP address range in CIDR notation making sure to use a /26>
$virtualNet = New-AzVirtualNetwork -Name <virtual network name> -ResourceGroupName <resource group name> -Location <location> -AddressPrefix <IP address range in CIDR notation> -Subnet $subnet
$publicip = New-AzPublicIpAddress -ResourceGroupName <resource group name> -Name <public IP address name> -Location <location> -AllocationMethod Dynamic -Sku Standard

Create the Azure Bastion service using the information within the created variables from above.

New-AzBastion -ResourceGroupName <resource group name> -Name <bastion name> -PublicIpAddress $publicip -VirtualNetwork $virtualNet -Sku \"Standard\" -ScaleUnit <integer>

Impact:

The Azure Bastion service incurs additional costs and requires a specific virtual network configuration. The Standard tier offers additional configuration options compared to the Basic tier and may incur additional costs for those added features."
  reference      : "800-171|3.4.1,800-171|3.13.1,800-171|3.13.5,800-171r3|03.04.10,800-171r3|03.04.10c.,800-171r3|03.13.01,800-53|CA-9,800-53|CM-8,800-53|CM-8(1),800-53|SC-7,800-53r5|CA-9,800-53r5|CM-8,800-53r5|CM-8(1),800-53r5|SC-7,CN-L3|8.1.10.2(a),CN-L3|8.1.10.2(b),CN-L3|8.1.10.6(j),CSCv7|9.2,CSCv7|11.2,CSCv8|12.1,CSCv8|13.4,CSF|DE.CM-1,CSF|DE.CM-7,CSF|ID.AM-1,CSF|ID.AM-2,CSF|ID.AM-3,CSF|PR.AC-5,CSF|PR.DS-3,CSF|PR.DS-5,CSF|PR.PT-4,CSF2.0|DE.CM-01,CSF2.0|ID.AM-01,CSF2.0|ID.AM-02,CSF2.0|ID.AM-03,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,CSF2.0|PR.PS-01,GDPR|32.1.b,GDPR|32.1.d,GDPR|32.2,HIPAA|164.306(a)(1),ISO-27001-2022|A.5.9,ISO-27001-2022|A.5.14,ISO-27001-2022|A.8.9,ISO-27001-2022|A.8.16,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.13.1.3,ITSG-33|CM-8,ITSG-33|CM-8(1),ITSG-33|SC-7,LEVEL|2A,NESA|T1.2.1,NESA|T1.2.2,NESA|T4.5.4,NIAv2|GS1,NIAv2|GS2a,NIAv2|GS2b,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,SWIFT-CSCv1|2.1,TBA-FIISB|43.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/19304"
  request        : "listNetworkBastionHosts"
  json_transform : '.[]|.subscriptionId as $id| "Subscription ID: \($id), Bastian Hosts: \([ .value[] | .name ])"'
  expect         : "Bastian Hosts: \[.+\]"
</custom_item>

</check_type>
