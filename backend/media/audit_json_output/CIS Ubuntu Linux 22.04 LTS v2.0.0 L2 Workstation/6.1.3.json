{
  "type": "CMD_EXEC",
  "description": "6.1.3 Ensure cryptographic mechanisms are used to protect the integrity of audit tools",
  "info": "Audit tools include, but are not limited to, vendor-provided and open source audit tools needed to successfully view and manipulate audit information system activity and records. Audit tools include custom queries and report generators.\n\nProtecting the integrity of the tools used for auditing purposes is a critical step toward ensuring the integrity of audit information. Audit information includes all information (e.g., audit records, audit settings, and audit reports) needed to successfully audit information system activity.\n\nAttackers may replace the audit tools or inject code into the existing tools with the purpose of providing the capability to hide or erase system activity from the audit logs.\n\nAudit tools should be cryptographically signed in order to provide the capability to identify when the audit tools have been modified, manipulated, or replaced. An example is a checksum hash of the file or files.",
  "solution": "\"Edit /etc/aide/aide.conf and add or update the following selection lines:\n\n# Audit Tools\n/sbin/auditctl p+i+n+u+g+s+b+acl+xattrs+sha512\n/sbin/auditd p+i+n+u+g+s+b+acl+xattrs+sha512\n/sbin/ausearch p+i+n+u+g+s+b+acl+xattrs+sha512\n/sbin/aureport p+i+n+u+g+s+b+acl+xattrs+sha512\n/sbin/autrace p+i+n+u+g+s+b+acl+xattrs+sha512\n/sbin/augenrules p+i+n+u+g+s+b+acl+xattrs+sha512",
  "Note": "- IF - /etc/aide/aide.conf includes a @@x_include statement:",
  "Example": "@@x_include /etc/aide/aide.conf.d ^[a-zA-Z0-9_-]+$\n - @@x_include FILE\n - @@x_include DIRECTORY REGEX\n - @x_include is identical to @@include except that if a config file is executable it is run and the output is used as config.\n - If the executable file exits with status greater than zero or writes to stderr aide stops with an error.\n - For security reasons DIRECTORY and each executable config file must be owned by the current user and must not be group or world-writable.\"",
  "reference": "800-53|SI-7,800-53r5|SI-7,CSF|PR.DS-6,CSF2.0|DE.CM-09,CSF2.0|ID.RA-09,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.PS-02,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(c)(1),HIPAA|164.312(c)(2),HIPAA|164.312(e)(2)(i),ITSG-33|SI-7,ITSG-33|SI-7a.,LEVEL|2A,NESA|T3.4.1,NESA|T7.3.2,NESA|T7.3.3,PCI-DSSv3.2.1|10.5.5,QCSC-v1|3.2",
  "see_also": "https://workbench.cisecurity.org/benchmarks/17074",
  "cmd": "#!/bin/bash\n\n{\n   l_output=\\\"\\\" l_output2=\\\"\\\"\n   f_parameter_chk()\n   {\n      l_out=\\\"\\\" l_out2=\\\"\\\"\n      for l_string in \\\"${!A_out[@]}\\\"; do\n         l_file_parameter=\\\"$(grep -Po -- \\\"^\\\\h*$l_parameter_name\\\\b.*$\\\" <<< \\\"$l_string\\\")\\\"\n         if [ -n \\\"$l_file_parameter\\\" ]; then\n            l_file=\\\"$(printf '%s' \\\"${A_out[$l_file_parameter]}\\\")\\\"\n            l_out=\\\"$l_out\\\\n  - Exists as: \\\\\\\"$l_file_parameter\\\\n   - in the configuration file: \\\\\\\"$l_file\\\\\\\"\\\"\n            for l_var in \\\"${a_items[@]}\\\"; do\n               if ! grep -Pq -- \\\"\\\\b$l_var\\\\b\\\" <<< \\\"$l_file_parameter\\\"; then\n                  l_out2=\\\"$l_out2\\\\n  - Option: \\\\\\\"$l_var\\\\\\\" is missing from: \\\\\\\"$l_file_parameter\\\\\\\" in: \\\\\\\"$l_file\\\\\\\"\\\"\n               fi\n            done\n         fi\n      done\n      [ -n \\\"$l_out\\\" ] && l_output=\\\"$l_output\\\\n - Parameter: \\\\\\\"$l_parameter_name\\\\\\\":$l_out\\\"\n      [ -z \\\"$l_out2\\\" ] && l_output=\\\"$l_output\\\\n    - and includes \\\\\\\"$(printf '%s+' \\\"${a_items[@]}\\\")\\\\\\\"\\\"\n      [ -n \\\"$l_out2\\\" ] && l_output2=\\\"$l_output2\\\\n - Parameter: \\\\\\\"$l_parameter_name\\\\\\\":$l_out2\\\"\n      [[ -z \\\"$l_out\\\" && -z \\\"$l_out2\\\" ]] && l_output2=\\\"$l_output2\\\\n - Parameter: \\\\\\\"$l_parameter_name\\\\\\\" is not configured\\\"\n   }\n   f_check_config()\n   {\n      a_items=(\\\"p\\\" \\\"i\\\" \\\"n\\\" \\\"u\\\" \\\"g\\\" \\\"s\\\" \\\"b\\\" \\\"acl\\\" \\\"xattrs\\\" \\\"sha512\\\")\n      a_parlist=(\\\"/sbin/auditctl\\\" \\\"/sbin/auditd\\\" \\\"/sbin/ausearch\\\" \\\"/sbin/aureport\\\" \\\"/sbin/autrace\\\" \\\"/sbin/augenrules\\\")\n      unset A_out; declare -A A_out\n      while IFS= read -r l_out; do\n         if [ -n \\\"$l_out\\\" ]; then\n            if [[ $l_out =~ ^\\\\s*# ]]; then\n               l_file=\\\"${l_out//# /}\\\"\n            else\n               l_parameter=\\\"$l_out\\\"\n               A_out+=([\\\"$l_parameter\\\"]=\\\"$l_file\\\")\n            fi\n         fi\n      done < <(/usr/bin/systemd-analyze cat-config \\\"$l_config_file\\\" | grep -Pio '^\\\\h*([^#\\\\n\\\\r]+|#\\\\h*\\\\/[^#\\\\n\\\\r\\\\h]+\\\\.conf\\\\b)')\n\n      for l_parameter_name in \\\"${a_parlist[@]}\\\"; do\n         if [ -f \\\"$l_parameter_name\\\" ]; then\n            f_parameter_chk\n         else\n            l_output=\\\"$l_output\\\\n - ** Warning **\\\\n   Audit tool file: \\\\\\\"$l_parameter_name\\\\\\\" does not exist\\\\n   Please verify auditd is installed\\\"\n         fi\n      done\n   }\n   if [ -f \\\"/etc/aide/aide.conf\\\" ]; then\n      l_config_file=\\\"/etc/aide/aide.conf\\\" && f_check_config\n   elif [ -f \\\"/etc/aide.conf\\\" ]; then\n      l_config_file=\\\"/etc/aide.conf\\\" && f_check_config\n   else\n      l_output2=\\\"$l_output2\\\\n - AIDE configuration file not found.\\\\n  Please verify AIDE is installed on the system\\\"\n   fi\n   unset a_items; unset a_parlist; unset A_out\n   if [ -z \\\"$l_output2\\\" ]; then\n      echo -e \\\"\\\\n- Audit Result:\\\\n  ** PASS **\\\\n - * Correctly configured * :$l_output\\\"\n   else\n      echo -e \\\"\\\\n- Audit Result:\\\\n  ** FAIL **\\\\n - * Reasons for audit failure * :$l_output2\\\\n\\\"\n      [ -n \\\"$l_output\\\" ] && echo -e \\\"\\\\n - * Correctly configured * :\\\\n$l_output\\\\n\\\"\n   fi\n}",
  "expect": "(?i)^[\\\\s]*\\\\**[\\\\s]*pass:?[\\\\s]*\\\\**$"
}