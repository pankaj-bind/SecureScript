{
  "type": "CMD_EXEC",
  "description": "1.8.7 Ensure GDM disabling automatic mounting of removable media is not overridden",
  "info": "By default GNOME automatically mounts removable media when inserted as a convenience to the user\n\nBy using the lockdown mode in dconf, you can prevent users from changing specific settings.\n\nTo lock down a dconf key or subpath, create a locks subdirectory in the keyfile directory. The files inside this directory contain a list of keys or subpaths to lock. Just as with the keyfiles, you may add any number of files to this directory.\n\nExample Lock File:\n\n# Lock desktop screensaver settings\n/org/gnome/desktop/media-handling/automount\n/org/gnome/desktop/media-handling/automount-open\n\nWith automounting enabled anyone with physical access could attach a USB drive or disc and have its contents available in system even if they lacked permissions to mount it themselves.",
  "solution": "\"Run the following script to lock disable automatic mounting of media for all GNOME users:\n\n#!/usr/bin/env bash\n\n{\n   # Check if GNMOE Desktop Manager is installed. If package isn't installed, recommendation is Not Applicable\\n\n   # determine system's package manager\n   l_pkgoutput=\\\"\\\"\n   if command -v dpkg-query > /dev/null 2>&1; then\n      l_pq=\\\"dpkg-query -W\\\"\n   elif command -v rpm > /dev/null 2>&1; then\n      l_pq=\\\"rpm -q\\\"\n   fi\n   # Check if GDM is installed\n   l_pcl=\\\"gdm gdm3\\\" # Space seporated list of packages to check\n   for l_pn in $l_pcl; do\n      $l_pq \\\"$l_pn\\\" > /dev/null 2>&1 && l_pkgoutput=\\\"y\\\" && echo -e \\\"\\n - Package: \\\\\\\"$l_pn\\\\\\\" exists on the system\\n - remediating configuration if needed\\\"\n   done\n   # Check configuration (If applicable)\n   if [ -n \\\"$l_pkgoutput\\\" ]; then\n      # Look for automount to determine profile in use, needed for remaining tests\n      l_kfd=\\\"/etc/dconf/db/$(grep -Psril '^\\h*automount\\b' /etc/dconf/db/*/ | awk -F'/' '{split($(NF-1),a,\\\".\\\");print a[1]}').d\\\" #set directory of key file to be locked\n      # Look for automount-open to determine profile in use, needed for remaining tests\n      l_kfd2=\\\"/etc/dconf/db/$(grep -Psril '^\\h*automount-open\\b' /etc/dconf/db/*/ | awk -F'/' '{split($(NF-1),a,\\\".\\\");print a[1]}').d\\\" #set directory of key file to be locked\n      if [ -d \\\"$l_kfd\\\" ]; then # If key file directory doesn't exist, options can't be locked\n         if grep -Priq '^\\h*\\/org/gnome\\/desktop\\/media-handling\\/automount\\b' \\\"$l_kfd\\\"; then\n            echo \\\" - \\\\\\\"automount\\\\\\\" is locked in \\\\\\\"$(grep -Pril '^\\h*\\/org/gnome\\/desktop\\/media-handling\\/automount\\b' \\\"$l_kfd\\\")\\\\\\\"\\\"\n         else\n            echo \\\" - creating entry to lock \\\\\\\"automount\\\\\\\"\\\"\n            [ ! -d \\\"$l_kfd\\\"/locks ] && echo \\\"creating directory $l_kfd/locks\\\" && mkdir \\\"$l_kfd\\\"/locks\n            {\n               echo -e '\\n# Lock desktop media-handling automount setting'\n               echo '/org/gnome/desktop/media-handling/automount'\n            } >> \\\"$l_kfd\\\"/locks/00-media-automount\n         fi\n      else\n         echo -e \\\" - \\\\\\\"automount\\\\\\\" is not set so it can not be locked\\n - Please follow Recommendation \\\\\\\"Ensure GDM automatic mounting of removable media is disabled\\\\\\\" and follow this Recommendation again\\\"\n      fi\n      if [ -d \\\"$l_kfd2\\\" ]; then # If key file directory doesn't exist, options can't be locked\n         if grep -Priq '^\\h*\\/org/gnome\\/desktop\\/media-handling\\/automount-open\\b' \\\"$l_kfd2\\\"; then\n            echo \\\" - \\\\\\\"automount-open\\\\\\\" is locked in \\\\\\\"$(grep -Pril '^\\h*\\/org/gnome\\/desktop\\/media-handling\\/automount-open\\b' \\\"$l_kfd2\\\")\\\\\\\"\\\"\n         else\n            echo \\\" - creating entry to lock \\\\\\\"automount-open\\\\\\\"\\\"\n            [ ! -d \\\"$l_kfd2\\\"/locks ] && echo \\\"creating directory $l_kfd2/locks\\\" && mkdir \\\"$l_kfd2\\\"/locks\n            {\n               echo -e '\\n# Lock desktop media-handling automount-open setting'\n               echo '/org/gnome/desktop/media-handling/automount-open'\n            } >> \\\"$l_kfd2\\\"/locks/00-media-automount\n         fi\n      else\n         echo -e \\\" - \\\\\\\"automount-open\\\\\\\" is not set so it can not be locked\\n - Please follow Recommendation \\\\\\\"Ensure GDM automatic mounting of removable media is disabled\\\\\\\" and follow this Recommendation again\\\"\n      fi\n      # update dconf database\n      dconf update\n   else\n      echo -e \\\" - GNOME Desktop Manager package is not installed on the system\\n - Recommendation is not applicable\\\"\n   fi\n}",
  "Impact": "The use of portable hard drives is very common for workstation users\"",
  "reference": "800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-53|MP-2,800-53r5|MP-2,CSF|PR.PT-2,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ITSG-33|MP-2,ITSG-33|MP-2a.,LEVEL|2A,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1",
  "see_also": "https://workbench.cisecurity.org/benchmarks/13775",
  "cmd": "#!/bin/bash\n\n{\n   # Check if GNOME Desktop Manager is installed.\n   l_pkgoutput=\\\"\\\"\n   if command -v dpkg-query &> /dev/null; then\n      l_pq=\\\"dpkg-query -s\\\"\n   elif command -v rpm &> /dev/null; then\n      l_pq=\\\"rpm -q\\\"\n   fi\n   l_pcl=\\\"gdm gdm3\\\" # space-separated list of packages to check\n   for l_pn in $l_pcl; do\n      $l_pq \\\"$l_pn\\\" &> /dev/null && l_pkgoutput=\\\"$l_pkgoutput\\\\n - Package: \\\\\\\"$l_pn\\\\\\\" exists on the system\\\\n - Checking configuration\\\"\n   done\n   # Check for GDM configuration (If applicable)\n   if [ -n \\\"$l_pkgoutput\\\" ]; then\n      l_output=\\\"\\\"\n      l_output2=\\\"\\\"\n      # Search /etc/dconf/db/local.d/ for automount settings\n      l_automount_setting=$(grep -Psir -- '^\\\\h*automount=false\\\\b' /etc/dconf/db/local.d/*)\n      l_automount_open_setting=$(grep -Psir -- '^\\\\h*automount-open=false\\\\b' /etc/dconf/db/local.d/*)\n      # Check for automount setting\n      if [[ -n \\\"$l_automount_setting\\\" ]]; then\n         l_output=\\\"$l_output\\\\n - \\\\\\\"automount\\\\\\\" setting found\\\"\n      else\n         l_output2=\\\"$l_output2\\\\n - \\\\\\\"automount\\\\\\\" setting not found\\\"\n      fi\n      # Check for automount-open setting\n      if [[ -n \\\"$l_automount_open_setting\\\" ]]; then\n         l_output=\\\"$l_output\\\\n - \\\\\\\"automount-open\\\\\\\" setting found\\\"\n      else\n         l_output2=\\\"$l_output2\\\\n - \\\\\\\"automount-open\\\\\\\" setting not found\\\"\n      fi\n   else\n      l_output=\\\"$l_output\\\\n - GNOME Desktop Manager package is not installed on the system\\\\n  - Recommendation is not applicable\\\"\n   fi\n   # Report results. If no failures in l_output2, we pass\n   [ -n \\\"$l_pkgoutput\\\" ] && echo -e \\\"\\\\n$l_pkgoutput\\\"\n   if [ -z \\\"$l_output2\\\" ]; then\n      echo -e \\\"\\\\n- Audit Result:\\\\n  ** PASS **\\\\n$l_output\\\\n\\\"\n   else\n      echo -e \\\"\\\\n- Audit Result:\\\\n  ** FAIL **\\\\n - Reason(s) for audit failure:\\\\n$l_output2\\\\n\\\"\n      [ -n \\\"$l_output\\\" ] && echo -e \\\"\\\\n- Correctly set:\\\\n$l_output\\\\n\\\"\n   fi\n}",
  "expect": "(?i)^[\\\\s]*\\\\**[\\\\s]*pass:?[\\\\s]*\\\\**$"
}