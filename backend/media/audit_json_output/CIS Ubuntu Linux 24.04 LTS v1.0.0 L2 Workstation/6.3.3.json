{
  "type": "CMD_EXEC",
  "description": "6.3.3 Ensure cryptographic mechanisms are used to protect the integrity of audit tools",
  "info": "\"Audit tools include, but are not limited to, vendor-provided and open source audit tools needed to successfully view and manipulate audit information system activity and records. Audit tools include custom queries and report generators.\n\naide.conf is case-sensitive. Leading and trailing white spaces are ignored. Each config lines must end with new line.\n\nAIDE uses the backslash character \\ as escape character for ' ' (space), '@' and '' (backslash) (e.g. '\\ ' or '@'). To literally match a '' in a file path with a regular expression you have to escape the backslash twice (i.e. '\\\\').\n\nThere are three types of lines in aide.conf :\n\n - The configuration options which are used to set configuration parameters and define groups.\n - (restricted) rules that are used to indicate which files are added to the database.\n - Macro lines define or undefine variables within the config file.",
  "Note": "- IF - /etc/aide/aide.conf includes a @@x_include statement:\n\n -\n\n<DIRECTORY>\n\nand each executable config file must be owned by the current user or root\n - They must not be group or world-writable",
  "@x_include": "- is identical to @@include except that if a config file is executable is is run and the output is used as config.\n - If the executable file exits with status greater than zero or writes to stderr aide stops with an error.\n - For security reasons\n\n<DIRECTORY>\n\nand each executable config file must be owned by the current user or root. They must not be group- or world-writable.\n - @@x_include _<FILE>_ (added in AIDE v0.17):\n - `@@x_include\n\n<DIRECTORY>\n\n<REGEX>\n\n[RULE_PREFIX] (added in AIDE v0.17)\n\n@@x_include_setenv\n\n<VAR>\n\n<VALUE>\n\n(added in AIDE v0.17)\n\n - Adds the variable\n\n<VAR>\n\nwith the value\n\n<VALUE>\n\nto the environment used for config file execution.\n - Environment variable names are limited to alphanumeric characters (A-Za-z0-9) and the underscore '_' and must not begin with a digit.\n\nProtecting the integrity of the tools used for auditing purposes is a critical step toward ensuring the integrity of audit information. Audit information includes all information (e.g., audit records, audit settings, and audit reports) needed to successfully audit information system activity.\n\nAttackers may replace the audit tools or inject code into the existing tools with the purpose of providing the capability to hide or erase system activity from the audit logs.\n\nAudit tools should be cryptographically signed in order to provide the capability to identify when the audit tools have been modified, manipulated, or replaced. An example is a checksum hash of the file or files.\"",
  "solution": "\"Run the following command to determine the absolute path to the non-symlinked version on the audit tools:\n\n# readlink -f /sbin\n\nThe output will be either /usr/sbin - OR - /sbin Ensure the correct path is used.\n\nEdit /etc/aide/aide.conf and add or update the following selection lines replacing <PATH> with the correct path returned in the command above:\n\n# Audit Tools\n<PATH>/auditctl p+i+n+u+g+s+b+acl+xattrs+sha512\n<PATH>/auditd p+i+n+u+g+s+b+acl+xattrs+sha512\n<PATH>/ausearch p+i+n+u+g+s+b+acl+xattrs+sha512\n<PATH>/aureport p+i+n+u+g+s+b+acl+xattrs+sha512\n<PATH>/autrace p+i+n+u+g+s+b+acl+xattrs+sha512\n<PATH>/augenrules p+i+n+u+g+s+b+acl+xattrs+sha512\n\nExample\n\n# printf '%s\\n' \\\"\\\" \\\"# Audit Tools\\\" \\\"$(readlink -f /sbin/auditctl) p+i+n+u+g+s+b+acl+xattrs+sha512\\\" \\\"$(readlink -f /sbin/auditd) p+i+n+u+g+s+b+acl+xattrs+sha512\\\" \\\"$(readlink -f /sbin/ausearch) p+i+n+u+g+s+b+acl+xattrs+sha512\\\" \\\"$(readlink -f /sbin/aureport) p+i+n+u+g+s+b+acl+xattrs+sha512\\\" \\\"$(readlink -f /sbin/autrace) p+i+n+u+g+s+b+acl+xattrs+sha512\\\" \\\"$(readlink -f /sbin/augenrules) p+i+n+u+g+s+b+acl+xattrs+sha512\\\" >> /etc/aide/aide.conf",
  "Example": "@@x_include /etc/aide.conf.d ^[a-zA-Z0-9_-]+$\"",
  "reference": "800-53|SI-7,800-53r5|SI-7,CSF|PR.DS-6,CSF2.0|DE.CM-09,CSF2.0|ID.RA-09,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.PS-02,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(c)(1),HIPAA|164.312(c)(2),HIPAA|164.312(e)(2)(i),ITSG-33|SI-7,ITSG-33|SI-7a.,LEVEL|2A,NESA|T3.4.1,NESA|T7.3.2,NESA|T7.3.3,PCI-DSSv3.2.1|10.5.5,QCSC-v1|3.2",
  "see_also": "https://workbench.cisecurity.org/benchmarks/18959",
  "cmd": "#!/bin/bash\n\n{\n   a_output=() a_output2=() l_tool_dir=\\\"$(readlink -f /sbin)\\\";\n   a_items=(\\\"p\\\" \\\"i\\\" \\\"n\\\" \\\"u\\\" \\\"g\\\" \\\"s\\\" \\\"b\\\" \\\"acl\\\" \\\"xattrs\\\" \\\"sha512\\\")\n   l_aide_cmd=\\\"$(whereis aide | awk '{print $2}')\\\";\n   a_audit_files=(\\\"auditctl\\\" \\\"auditd\\\" \\\"ausearch\\\" \\\"aureport\\\" \\\"autrace\\\" \\\"augenrules\\\")\n   if [ -f \\\"$l_aide_cmd\\\" ] && command -v \\\"$l_aide_cmd\\\" &>/dev/null; then\n      a_aide_conf_files=(\\\"$(find -L /etc -type f -name 'aide.conf')\\\")\n      f_file_par_chk()\n      {\n         a_out2=()\n         for l_item in \\\"${a_items[@]}\\\"; do\n            ! grep -Psiq -- '(\\\\h+|\\\\+)'\\\"$l_item\\\"'(\\\\h+|\\\\+)' <<< \\\"$l_out\\\" && \\\\\n            a_out2+=(\\\"  - Missing the \\\\\\\"$l_item\\\\\\\" option\\\")\n         done\n         if [ \\\"${#a_out2[@]}\\\" -gt \\\"0\\\" ]; then\n            a_output2+=(\\\" - Audit tool file: \\\\\\\"$l_file\\\\\\\"\\\" \\\"${a_out2[@]}\\\")\n         else\n            a_output+=(\\\" - Audit tool file: \\\\\\\"$l_file\\\\\\\" includes:\\\" \\\"   \\\\\\\"${a_items[*]}\\\\\\\"\\\")\n         fi\n      }\n      for l_file in \\\"${a_audit_files[@]}\\\"; do\n         if [ -f \\\"$l_tool_dir/$l_file\\\" ]; then\n            l_out=\\\"$(\\\"$l_aide_cmd\\\" --config \\\"${a_aide_conf_files[@]}\\\" -p f:\\\"$l_tool_dir/$l_file\\\")\\\";\n            f_file_par_chk\n         else\n            a_output+=(\\\"  - Audit tool file \\\\\\\"$l_file\\\\\\\" doesn't exist\\\")\n         fi\n      done\n   else\n      a_output2+=(\\\"  - The command \\\\\\\"aide\\\\\\\" was not found\\\"  \\\"    Please install AIDE\\\")\n   fi\n   if [ \\\"${#a_output2[@]}\\\" -le 0 ]; then\n      printf '%s\\\\n' \\\"\\\" \\\"- Audit Result:\\\" \\\"  ** PASS **\\\" \\\"${a_output[@]}\\\" \\\"\\\";\n   else\n      printf '%s\\\\n' \\\"\\\" \\\"- Audit Result:\\\" \\\"  ** FAIL **\\\" \\\" - Reason(s) for audit failure:\\\" \\\"${a_output2[@]}\\\";\n      [ \\\"${#a_output[@]}\\\" -gt 0 ] && printf '%s\\\\n' \\\"\\\" \\\"- Correctly set:\\\" \\\"${a_output[@]}\\\" \\\"\\\";\n   fi\n}",
  "expect": "(?i)^[\\\\s]*\\\\**[\\\\s]*pass:?[\\\\s]*\\\\**$"
}