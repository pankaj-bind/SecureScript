{
  "type": "CMD_EXEC",
  "description": "6.1.4.1 Ensure access to all logfiles has been configured",
  "info": "Log files contain information from many services on the the local system, or in the event of a centralized log server, others systems logs as well.\n\nIn general log files are found in /var/log/ although application can be configured to store logs elsewhere. Should your application store logs in another, ensure to run the same test on that location.\n\nIt is important that log files have the correct permissions to ensure that sensitive data is protected and that only the appropriate users / groups have access to them.",
  "solution": "\"Run the following script to update permissions and ownership on files in /var/log\n\nAlthough the script is not destructive, ensure that the output of the audit procedure is captured in the event that the remediation causes issues.\n\n#!/usr/bin/env bash\n\n{\n   a_output2=()\n   f_file_test_fix()\n   {\n      a_out2=()\n      maxperm=\\\"$( printf '%o' $(( 0777 & ~$perm_mask)) )\\\"\n      if [ $(( $l_mode & $perm_mask )) -gt 0 ]; then\n         a_out2+=(\\\" o Mode: \\\\\\\"$l_mode\\\\\\\" should be \\\\\\\"$maxperm\\\\\\\" or more restrictive\\\" \\\" x Removing excess permissions\\\")\n         chmod \\\"$l_rperms\\\" \\\"$l_fname\\\"\n      fi\n      if [[ ! \\\"$l_user\\\" =~ $l_auser ]]; then\n         a_out2+=(\\\" o Owned by: \\\\\\\"$l_user\\\\\\\" and should be owned by \\\\\\\"${l_auser//|/ or }\\\\\\\"\\\" \\\" x Changing ownership to: \\\\\\\"$l_fix_account\\\\\\\"\\\")\n         chown \\\"$l_fix_account\\\" \\\"$l_fname\\\"\n      fi\n      if [[ ! \\\"$l_group\\\" =~ $l_agroup ]]; then\n         a_out2+=(\\\" o Group owned by: \\\\\\\"$l_group\\\\\\\" and should be group owned by \\\\\\\"${l_agroup//|/ or }\\\\\\\"\\\" \\\" x Changing group ownership to: \\\\\\\"$l_fix_account\\\\\\\"\\\")\n         chgrp \\\"$l_fix_account\\\" \\\"$l_fname\\\"\n      fi\n      [ \\\"${#a_out2[@]}\\\" -gt 0 ] && a_output2+=(\\\" - File: \\\\\\\"$l_fname\\\\\\\" is:\\\" \\\"${a_out2[@]}\\\")\n   }\n   l_fix_account='root'\n   while IFS= read -r -d $'\\0' l_file; do\n      while IFS=: read -r l_fname l_mode l_user l_group; do\n         if grep -Pq -- '\\/(apt)\\h*$' <<< \\\"$(dirname \\\"$l_fname\\\")\\\"; then\n            perm_mask='0133' l_rperms=\\\"u-x,go-wx\\\" l_auser=\\\"root\\\" l_agroup=\\\"(root|adm)\\\"; f_file_test_fix\n         else\n            case \\\"$(basename \\\"$l_fname\\\")\\\" in\n               lastlog | lastlog.* | wtmp | wtmp.* | wtmp-* | btmp | btmp.* | btmp-* | README)\n                  perm_mask='0113' l_rperms=\\\"ug-x,o-wx\\\" l_auser=\\\"root\\\" l_agroup=\\\"(root|utmp)\\\"\n                  f_file_test_fix ;;\n               cloud-init.log* | localmessages* | waagent.log*)\n                  perm_mask='0133' l_rperms=\\\"u-x,go-wx\\\" l_auser=\\\"(root|syslog)\\\" l_agroup=\\\"(root|adm)\\\"\n                  f_file_test_fix ;;\n               secure | auth.log | syslog | messages)\n                  perm_mask='0137' l_rperms=\\\"u-x,g-wx,o-rwx\\\" l_auser=\\\"(root|syslog)\\\" l_agroup=\\\"(root|adm)\\\"\n                  f_file_test_fix ;;\n               SSSD | sssd)\n                  perm_mask='0117' l_rperms=\\\"ug-x,o-rwx\\\" l_auser=\\\"(root|SSSD)\\\" l_agroup=\\\"(root|SSSD)\\\"\n                  f_file_test_fix ;;\n               gdm | gdm3)\n                  perm_mask='0117' l_rperms=\\\"ug-x,o-rwx\\\" l_auser=\\\"root\\\" l_agroup=\\\"(root|gdm|gdm3)\\\"\n                  f_file_test_fix ;;\n               *.journal | *.journal~)\n                  perm_mask='0137' l_rperms=\\\"u-x,g-wx,o-rwx\\\" l_auser=\\\"root\\\" l_agroup=\\\"(root|systemd-journal)\\\"\n                  f_file_test_fix ;;\n               *)\n                  perm_mask='0137' l_rperms=\\\"u-x,g-wx,o-rwx\\\" l_auser=\\\"(root|syslog)\\\" l_agroup=\\\"(root|adm)\\\"\n                  if [ \\\"$l_user\\\" = \\\"root\\\" ] || ! grep -Pq -- \\\"^\\h*$(awk -F: '$1==\\\"'\\\"$l_user\\\"'\\\" {print $7}' /etc/passwd)\\b\\\" /etc/shells; then\n                     ! grep -Pq -- \\\"$l_auser\\\" <<< \\\"$l_user\\\" && l_auser=\\\"(root|syslog|$l_user)\\\"\n                     ! grep -Pq -- \\\"$l_agroup\\\" <<< \\\"$l_group\\\" && l_agroup=\\\"(root|adm|$l_group)\\\"\n                  fi\n                  f_file_test_fix ;;\n            esac\n         fi\n      done < <(stat -Lc '%n:%#a:%U:%G' \\\"$l_file\\\")\n   done < <(find -L /var/log -type f \\( -perm /0137 -o ! -user root -o ! -group root \\) -print0)\n   if [ \\\"${#a_output2[@]}\\\" -le 0 ]; then # If all files passed, then we report no changes\n      a_output+=(\\\" - All files in \\\\\\\"/var/log/\\\\\\\" have appropriate permissions and ownership\\\")\n      printf '\\n%s' \\\"- All files in \\\\\\\"/var/log/\\\\\\\" have appropriate permissions and ownership\\\" \\\" o No changes required\\\" \\\"\\\"\n   else\n      printf '\\n%s' \\\"${a_output2[@]}\\\" \\\"\\\"\n   fi\n}",
  "Note": "You may also need to change the configuration for your logging software or services for any logs that had incorrect permissions.\n\nIf there are services that log to other locations, ensure that those log files have the appropriate permissions.\"",
  "reference": "800-171|3.1.1,800-171|3.1.4,800-171|3.1.5,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-171r3|03.01.02,800-171r3|03.01.04,800-171r3|03.01.05a.,800-171r3|03.08.02,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|MP-2,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|MP-2,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|3.3,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-2,CSF|PR.PT-3,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO-27001-2022|A.5.3,ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.33,ISO-27001-2022|A.7.7,ISO-27001-2022|A.7.10,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|MP-2,ITSG-33|MP-2a.,LEVEL|1A,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|SS13c,NIAv2|SS15c,NIAv2|SS29,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3",
  "see_also": "https://workbench.cisecurity.org/benchmarks/18959",
  "cmd": "#!/bin/bash\n\n{\n   a_output=(); a_output2=()\n   f_file_test_chk()\n   {\n      a_out2=()\n      maxperm=\\\"$( printf '%o' $(( 0777 & ~$perm_mask)) )\\\"\n      [ $(( $l_mode & $perm_mask )) -gt 0 ] && \\\\\n         a_out2+=(\\\"   o Mode: \\\\\\\"$l_mode\\\\\\\" should be \\\\\\\"$maxperm\\\\\\\" or more restrictive\\\")\n      [[ ! \\\"$l_user\\\" =~ $l_auser ]] && \\\\\n         a_out2+=(\\\"   o Owned by: \\\\\\\"$l_user\\\\\\\" and should be owned by \\\\\\\"${l_auser//|/ or }\\\\\\\"\\\")\n      [[ ! \\\"$l_group\\\" =~ $l_agroup ]] && \\\\\n         a_out2+=(\\\"   o Group owned by: \\\\\\\"$l_group\\\\\\\" and should be group owned by \\\\\\\"${l_agroup//|/ or }\\\\\\\"\\\")\n      [ \\\"${#a_out2[@]}\\\" -gt 0 ] && a_output2+=(\\\" - File: \\\\\\\"$l_fname\\\\\\\" is:\\\" \\\"${a_out2[@]}\\\")\n   }\n   while IFS= read -r -d $'\\\\0' l_file; do\n      while IFS=: read -r l_fname l_mode l_user l_group; do\n         if grep -Pq -- '\\\\/(apt)\\\\h*$' <<< \\\"$(dirname \\\"$l_fname\\\")\\\"; then\n            perm_mask='0133' l_auser=\\\"root\\\" l_agroup=\\\"(root|adm)\\\"; f_file_test_chk\n         else\n            case \\\"$(basename \\\"$l_fname\\\")\\\" in\n               lastlog | lastlog.* | wtmp | wtmp.* | wtmp-* | btmp | btmp.* | btmp-* | README)\n                  perm_mask='0113' l_auser=\\\"root\\\" l_agroup=\\\"(root|utmp)\\\"\n                  f_file_test_chk ;;\n               cloud-init.log* | localmessages* | waagent.log*)\n                  perm_mask='0133' l_auser=\\\"(root|syslog)\\\" l_agroup=\\\"(root|adm)\\\"\n                  file_test_chk ;;\n               secure{,*.*,.*,-*} | auth.log | syslog | messages)\n                  perm_mask='0137' l_auser=\\\"(root|syslog)\\\" l_agroup=\\\"(root|adm)\\\"\n                  f_file_test_chk ;;\n               SSSD | sssd)\n                  perm_mask='0117' l_auser=\\\"(root|SSSD)\\\" l_agroup=\\\"(root|SSSD)\\\"\n                  f_file_test_chk ;;\n               gdm | gdm3)\n                  perm_mask='0117' l_auser=\\\"root\\\" l_agroup=\\\"(root|gdm|gdm3)\\\"\n                  f_file_test_chk ;;\n               *.journal | *.journal~)\n                  perm_mask='0137' l_auser=\\\"root\\\" l_agroup=\\\"(root|systemd-journal)\\\"\n                  f_file_test_chk ;;\n               *)\n                  perm_mask='0137' l_auser=\\\"(root|syslog)\\\" l_agroup=\\\"(root|adm)\\\"\n                  if [ \\\"$l_user\\\" = \\\"root\\\" ] || ! grep -Pq -- \\\"^\\\\h*$(awk -F: '$1==\\\"'\\\"$l_user\\\"'\\\" {print $7}' /etc/passwd)\\\\b\\\" /etc/shells; then\n                     ! grep -Pq -- \\\"$l_auser\\\" <<< \\\"$l_user\\\" && l_auser=\\\"(root|syslog|$l_user)\\\"\n                     ! grep -Pq -- \\\"$l_agroup\\\" <<< \\\"$l_group\\\" && l_agroup=\\\"(root|adm|$l_group)\\\"\n                  fi\n                  f_file_test_chk ;;\n            esac\n         fi\n      done < <(stat -Lc '%n:%#a:%U:%G' \\\"$l_file\\\")\n   done < <(find -L /var/log -type f \\\\( -perm /0137 -o ! -user root -o ! -group root \\\\) -print0)\n   if [ \\\"${#a_output2[@]}\\\" -le 0 ]; then\n      a_output+=(\\\"  - All files in \\\\\\\"/var/log/\\\\\\\" have appropriate permissions and ownership\\\")\n      printf '\\\\n%s' \\\"- Audit Result:\\\" \\\"  ** PASS **\\\" \\\"${a_output[@]}\\\" \\\"\\\"\n   else\n      printf '\\\\n%s' \\\"- Audit Result:\\\" \\\"  ** FAIL **\\\" \\\" - Reason(s) for audit failure:\\\" \\\"${a_output2[@]}\\\" \\\"\\\"\n   fi\n}",
  "expect": "(?i)^[\\\\s]*\\\\**[\\\\s]*pass:?[\\\\s]*\\\\**$",
  "timeout": "@FIND_TIMEOUT@"
}