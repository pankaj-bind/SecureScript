{
  "check_type": "CONDITIONAL",
  "condition": {
    "auto_status": "FAILED",
    "type": "AND",
    "rules": [
      {
        "type": "CMD_EXEC",
        "description": "/etc/sudoers use_pty",
        "cmd": "/bin/grep -rPi -- '^\\\\h*Defaults\\\\h+([^#\\\\n\\\\r]+,,\\\\h*)?use_pty\\\\b' /etc/sudoers*",
        "expect": "Defaults[\\\\s]*use_pty$"
      },
      {
        "type": "CMD_EXEC",
        "description": "/etc/sudoers !use_pty",
        "cmd": "/bin/grep -rPi -- '^\\\\h*Defaults\\\\h+([^#\\\\n\\\\r]+,\\\\h*)?!use_pty\\\\b' /etc/sudoers* | /bin/awk '{print} END {if (NR == 0) print \\\"pass\\\" ; else print \\\"fail\\\"}'",
        "expect": "^pass$"
      }
    ]
  },
  "then": {
    "report": {
      "description": "5.2.2 Ensure sudo commands use pty",
      "info": "sudo can be configured to run only from a pseudo terminal ( pseudo-pty ).\n\nAttackers can run a malicious program using sudo which would fork a background process that remains even when the main program has finished executing.",
      "solution": "\"Edit the file /etc/sudoers with visudo or a file in /etc/sudoers.d/ with visudo -f <PATH TO FILE> and add the following line:\n\nDefaults use_pty\n\nEdit the file /etc/sudoers with visudo and any files in /etc/sudoers.d/ with visudo -f <PATH TO FILE> and remove any occurrence of !use_pty",
      "Note": "- sudo will read each file in /etc/sudoers.d skipping file names that end in ~ or contain a character to avoid causing problems with package manager or editor temporary/backup files.\n - Files are parsed in sorted lexical order. That is, /etc/sudoers.d/01_first will be parsed before /etc/sudoers.d/10_second\n - Be aware that because the sorting is lexical, not numeric, /etc/sudoers.d/1_whoops would be loaded after /etc/sudoers.d/10_second\n - Using a consistent number of leading zeroes in the file names can be used to avoid such problems.",
      "Impact": "WARNING: Editing the sudo configuration incorrectly can cause sudo to stop functioning. Always use visudo to modify sudo configuration files.\"",
      "reference": "800-171|3.1.5,800-171|3.1.6,800-171r3|03.01.06a.,800-171r3|03.01.06b.,800-53|AC-6(2),800-53|AC-6(5),800-53r5|AC-6(2),800-53r5|AC-6(5),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.10.6(a),CSCv7|5.1,CSCv8|5.4,CSF|PR.AC-4,CSF2.0|PR.AA-05,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO-27001-2022|A.5.15,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.18,ISO/IEC-27001|A.9.2.3,ITSG-33|AC-6(2),ITSG-33|AC-6(5),LEVEL|1A,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.6.1,NIAv2|AM1,NIAv2|AM23f,NIAv2|AM32,NIAv2|AM33,NIAv2|SS13c,NIAv2|SS15c,NIAv2|VL3a,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|5.2.2,QCSC-v1|6.2,SWIFT-CSCv1|1.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3",
      "see_also": "https://workbench.cisecurity.org/benchmarks/18959",
      "show_output": true,
      "type": "PASSED"
    }
  }
}