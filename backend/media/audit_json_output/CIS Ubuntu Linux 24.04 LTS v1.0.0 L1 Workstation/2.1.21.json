{
  "type": "CMD_EXEC",
  "description": "2.1.21 Ensure mail transfer agent is configured for local-only mode",
  "info": "Mail Transfer Agents (MTA), such as sendmail and Postfix, are used to listen for incoming mail and transfer the messages to the appropriate user or mail server. If the system is not intended to be a mail server, it is recommended that the MTA be configured to only process local mail.\n\nThe software for all Mail Transfer Agents is complex and most have a long history of security issues. While it is important to ensure that the system can process local mail messages, it is not necessary to have the MTA's daemon listening on a port unless the server is intended to be a mail server that receives and processes mail from other systems.",
  "solution": "\"Edit /etc/postfix/main.cf and add the following line to the RECEIVING MAIL section. If the line already exists, change it to look like the line below:\n\ninet_interfaces = loopback-only\n\nRun the following command to restart postfix :\n\n# systemctl restart postfix",
  "Note": "- This recommendation is designed around the postfix mail server.\n - Depending on your environment you may have an alternative MTA installed such as exim4. If this is the case consult the documentation for your installed MTA to configure the recommended state.\"",
  "reference": "800-171|3.4.2,800-171|3.4.6,800-171|3.4.7,800-171r3|03.04.02,800-171r3|03.04.06,800-53|CM-6,800-53|CM-7,800-53r5|CM-6,800-53r5|CM-7,CSCv7|9.2,CSCv8|4.8,CSF|PR.IP-1,CSF|PR.PT-3,CSF2.0|DE.CM-09,CSF2.0|PR.PS-01,GDPR|32.1.b,HIPAA|164.306(a)(1),ISO-27001-2022|A.8.9,ITSG-33|CM-6,ITSG-33|CM-7,LEVEL|1A,NIAv2|SS15a,PCI-DSSv3.2.1|2.2.2,SWIFT-CSCv1|2.3",
  "see_also": "https://workbench.cisecurity.org/benchmarks/18959",
  "cmd": "#!/bin/bash\n\n{\n   a_output=(); a_output2=(); a_port_list=(\\\"25\\\" \\\"465\\\" \\\"587\\\")\n   for l_port_number in \\\"${a_port_list[@]}\\\"; do\n      if ss -plntu | grep -P -- ':'\\\"$l_port_number\\\"'\\\\b' | grep -Pvq -- '\\\\h+(127\\\\.0\\\\.0\\\\.1|\\\\[?::1\\\\]?):'\\\"$l_port_number\\\"'\\\\b'; then\n         a_output2+=(\\\" - Port \\\\\\\"$l_port_number\\\\\\\" is listening on a non-loopback network interface\\\")\n      else\n         a_output+=(\\\" - Port \\\\\\\"$l_port_number\\\\\\\" is not listening on a non-loopback network interface\\\")\n      fi\n   done\n   if command -v postconf &> /dev/null; then\n      l_interfaces=\\\"$(postconf -n inet_interfaces)\\\"\n   elif command -v exim &> /dev/null; then\n      l_interfaces=\\\"$(exim -bP local_interfaces)\\\"\n   elif command -v sendmail &> /dev/null; then\n      l_interfaces=\\\"$(grep -i \\\"0 DaemonPortOptions=\\\" /etc/mail/sendmail.cr | grep -oP '?<=Addr=)[^,+]+')\\\"\n   fi\n   if [ -n \\\"$l_interfaces\\\" ]; then\n      if grep -Pqi '\\\\ball\\\\b' <<< \\\"$l_interfaces\\\"; then\n         a_output2+=(\\\" - MTA is bound to all network interfaces\\\")\n      elif ! grep -Pqi '(inet_interfaces\\\\h*=\\\\h*)?(0\\\\.0\\\\.0\\\\.0|::1|loopback-only)' <<< \\\"$l_interfaces\\\"; then\n         a_output2+=(\\\" - MTA is bound to a network interface\\\" \\\"   \\\\\\\"$l_interfaces\\\\\\\"\\\")\n      else\n         a_output+=(\\\" - MTA is not bound to a non loopback network interface\\\" \\\"   \\\\\\\"$l_interfaces\\\\\\\"\\\")\n      fi\n   else\n      a_output+=(\\\" - MTA not detected or in use\\\")\n   fi\n   if [ \\\"${#a_output2[@]}\\\" -le 0 ]; then\n      printf '%s\\\\n' \\\"\\\" \\\"- Audit Result:\\\" \\\"  ** PASS **\\\" \\\"${a_output[@]}\\\"\n   else\n      printf '%s\\\\n' \\\"\\\" \\\"- Audit Result:\\\" \\\"  ** FAIL **\\\" \\\"  * Reasons for audit failure *\\\" \\\"${a_output2[@]}\\\" \\\"\\\"\n      [ \\\"${#a_output[@]}\\\" -gt 0 ] && printf '%s\\\\n' \\\"- Correctly set:\\\" \\\"${a_output[@]}\\\"\n   fi\n}",
  "expect": "(?i)^[\\\\s]*\\\\**[\\\\s]*pass:?[\\\\s]*\\\\**$"
}