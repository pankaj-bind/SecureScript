{
  "type": "CMD_EXEC",
  "description": "5.1.1 Ensure permissions on /etc/ssh/sshd_config are configured",
  "info": "The file /etc/ssh/sshd_config and files ending inconf in the /etc/ssh/sshd_config.d directory, contain configuration specifications for sshd\n\nconfiguration specifications for sshd need to be protected from unauthorized changes by non-privileged users.",
  "solution": "Run the following script to set ownership and permissions on /etc/ssh/sshd_config and files ending inconf in the /etc/ssh/sshd_config.d directory:\n\n#!/usr/bin/env bash\n\n{\n   chmod u-x,og-rwx /etc/ssh/sshd_config\n   chown root:root /etc/ssh/sshd_config\n   while IFS= read -r -d $'\\0' l_file; do\n      if [ -e \\\"$l_file\\\" ]; then\n         chmod u-x,og-rwx \\\"$l_file\\\"\n         chown root:root \\\"$l_file\\\"\n      fi\n   done < <(find /etc/ssh/sshd_config.d -type f -print0 2>/dev/null)\n}\n\n- IF - other locations are listed in an Include statement, *.conf files in these locations access should also be modified.",
  "reference": "800-171|3.1.1,800-171|3.1.4,800-171|3.1.5,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-171r3|03.01.02,800-171r3|03.01.04,800-171r3|03.01.05a.,800-171r3|03.08.02,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|MP-2,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|MP-2,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|3.3,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-2,CSF|PR.PT-3,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO-27001-2022|A.5.3,ISO-27001-2022|A.5.10,ISO-27001-2022|A.5.15,ISO-27001-2022|A.5.33,ISO-27001-2022|A.7.7,ISO-27001-2022|A.7.10,ISO-27001-2022|A.8.2,ISO-27001-2022|A.8.3,ISO-27001-2022|A.8.18,ISO-27001-2022|A.8.20,ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|MP-2,ITSG-33|MP-2a.,LEVEL|1A,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|SS13c,NIAv2|SS15c,NIAv2|SS29,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3",
  "see_also": "https://workbench.cisecurity.org/benchmarks/18959",
  "cmd": "#!/bin/bash\n\n{\n   l_output=\\\"\\\" l_output2=\\\"\\\"\n   perm_mask='0177' && maxperm=\\\"$( printf '%o' $(( 0777 & ~$perm_mask)) )\\\"\n   SSHD_FILES_CHK()\n   {\n      while IFS=: read -r l_mode l_user l_group; do\n         l_out2=\\\"\\\"\n         [ $(( $l_mode & $perm_mask )) -gt 0 ] && l_out2=\\\"$l_out2\\\\n  - Is mode: \\\\\\\"$l_mode\\\\\\\" should be: \\\\\\\"$maxperm\\\\\\\" or more restrictive\\\"\n         [ \\\"$l_user\\\" != \\\"root\\\" ] && l_out2=\\\"$l_out2\\\\n  - Is owned by \\\\\\\"$l_user\\\\\\\" should be owned by \\\\\\\"root\\\\\\\"\\\"\n         [ \\\"$l_group\\\" != \\\"root\\\" ] && l_out2=\\\"$l_out2\\\\n  - Is group owned by \\\\\\\"$l_user\\\\\\\" should be group owned by \\\\\\\"root\\\\\\\"\\\"\n         if [ -n \\\"$l_out2\\\" ]; then\n            l_output2=\\\"$l_output2\\\\n - File: \\\\\\\"$l_file\\\\\\\":$l_out2\\\"\n         else\n            l_output=\\\"$l_output\\\\n - File: \\\\\\\"$l_file\\\\\\\":\\\\n  - Correct: mode ($l_mode), owner ($l_user), and group owner ($l_group) configured\\\"\n         fi\n      done < <(stat -Lc '%#a:%U:%G' \\\"$l_file\\\")\n   }\n   [ -e \\\"/etc/ssh/sshd_config\\\" ] && l_file=\\\"/etc/ssh/sshd_config\\\" && SSHD_FILES_CHK\n   while IFS= read -r -d $'\\\\0' l_file; do\n      [ -e \\\"$l_file\\\" ] && SSHD_FILES_CHK\n   done < <(find -L /etc/ssh/sshd_config.d -type f  \\\\( -perm /077 -o ! -user root -o ! -group root \\\\) -print0)\n   if [ -z \\\"$l_output2\\\" ]; then\n      echo -e \\\"\\\\n- Audit Result:\\\\n  *** PASS ***\\\\n- * Correctly set * :\\\\n$l_output\\\\n\\\"\n   else\n      echo -e \\\"\\\\n- Audit Result:\\\\n  ** FAIL **\\\\n - * Reasons for audit failure * :\\\\n$l_output2\\\\n\\\"\n      [ -n \\\"$l_output\\\" ] && echo -e \\\" - * Correctly set * :\\\\n$l_output\\\\n\\\"\n   fi\n}",
  "expect": "(?i)^[\\\\s]*\\\\**[\\\\s]*pass:?[\\\\s]*\\\\**$"
}