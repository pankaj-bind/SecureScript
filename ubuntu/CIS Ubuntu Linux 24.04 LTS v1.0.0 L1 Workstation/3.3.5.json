{
  "type": "CMD_EXEC",
  "description": "3.3.5 Ensure icmp redirects are not accepted",
  "info": "ICMP redirect messages are packets that convey routing information and tell your host (acting as a router) to send packets via an alternate path. It is a way of allowing an outside routing device to update your system routing tables.\n\nICMP redirect messages are packets that convey routing information and tell your host (acting as a router) to send packets via an alternate path. It is a way of allowing an outside routing device to update your system routing tables. By setting net.ipv4.conf.all.accept_redirects net.ipv4.conf.default.accept_redirects net.ipv6.conf.all.accept_redirects and net.ipv6.conf.default.accept_redirects to 0 the system will not accept any ICMP redirect messages, and therefore, won't allow outsiders to update the system's routing tables.",
  "solution": "\"Set the following parameters in /etc/sysctl.conf or a file in /etc/sysctl.d/ ending inconf :\n\n - net.ipv4.conf.all.accept_redirects = 0\n - net.ipv4.conf.default.accept_redirects = 0",
  "Example": "# printf '%s\\n' \\\"net.ipv6.conf.all.accept_redirects = 0\\\" \\\"net.ipv6.conf.default.accept_redirects = 0\\\" >> /etc/sysctl.d/60-netipv6_sysctl.conf\n\nRun the following script to set the active kernel parameters:\n\n#!/usr/bin/env bash\n\n{\n   sysctl -w net.ipv6.conf.all.accept_redirects=0\n   sysctl -w net.ipv6.conf.default.accept_redirects=0\n   sysctl -w net.ipv6.route.flush=1\n}",
  "Note": "If these settings appear in a canonically later file, or later in the same file, these settings will be overwritten\"",
  "reference": "800-171|3.4.2,800-171|3.4.6,800-171|3.4.7,800-171r3|03.04.02,800-171r3|03.04.06,800-53|CM-6,800-53|CM-7,800-53r5|CM-6,800-53r5|CM-7,CSCv7|9.2,CSCv8|4.8,CSF|PR.IP-1,CSF|PR.PT-3,CSF2.0|DE.CM-09,CSF2.0|PR.PS-01,GDPR|32.1.b,HIPAA|164.306(a)(1),ISO-27001-2022|A.8.9,ITSG-33|CM-6,ITSG-33|CM-7,LEVEL|1A,NIAv2|SS15a,PCI-DSSv3.2.1|2.2.2,SWIFT-CSCv1|2.3",
  "see_also": "https://workbench.cisecurity.org/benchmarks/18959",
  "cmd": "#!/bin/bash\n\n{\n   a_output=(); a_output2=(); l_ipv6_disabled=\\\"\\\"\n   a_parlist=(\\\"net.ipv4.conf.all.accept_redirects=0\\\" \\\"net.ipv4.conf.default.accept_redirects=0\\\" \\\"net.ipv6.conf.all.accept_redirects=0\\\" \\\"net.ipv6.conf.default.accept_redirects=0\\\")\n   l_ufwscf=\\\"$([ -f /etc/default/ufw ] && awk -F= '/^\\\\s*IPT_SYSCTL=/ {print $2}' /etc/default/ufw)\\\"\n   f_ipv6_chk()\n   {\n      l_ipv6_disabled=\\\"no\\\"\n      ! grep -Pqs -- '^\\\\h*0\\\\b' /sys/module/ipv6/parameters/disable && l_ipv6_disabled=\\\"yes\\\"\n      if sysctl net.ipv6.conf.all.disable_ipv6 | grep -Pqs -- \\\"^\\\\h*net\\\\.ipv6\\\\.conf\\\\.all\\\\.disable_ipv6\\\\h*=\\\\h*1\\\\b\\\" && \\\\\n         sysctl net.ipv6.conf.default.disable_ipv6 | grep -Pqs -- \\\"^\\\\h*net\\\\.ipv6\\\\.conf\\\\.default\\\\.disable_ipv6\\\\h*=\\\\h*1\\\\b\\\"; then\n         l_ipv6_disabled=\\\"yes\\\"\n      fi\n   }\n   f_kernel_parameter_chk()\n   {\n      l_running_parameter_value=\\\"$(sysctl \\\"$l_parameter_name\\\" | awk -F= '{print $2}' | xargs)\\\" # Check running configuration\n      if grep -Pq -- '\\\\b'\\\"$l_parameter_value\\\"'\\\\b' <<< \\\"$l_running_parameter_value\\\"; then\n         a_output+=(\\\" - \\\\\\\"$l_parameter_name\\\\\\\" is correctly set to \\\\\\\"$l_running_parameter_value\\\\\\\"\\\"\n         \\\"    in the running configuration\\\")\n      else\n         a_output2+=(\\\" - \\\\\\\"$l_parameter_name\\\\\\\" is incorrectly set to \\\\\\\"$l_running_parameter_value\\\\\\\"\\\" \\\\\n         \\\"    in the running configuration\\\" \\\\\n         \\\"    and should have a value of: \\\\\\\"$l_value_out\\\\\\\"\\\")\n      fi\n      unset A_out; declare -A A_out # Check durable setting (files)\n      while read -r l_out; do\n         if [ -n \\\"$l_out\\\" ]; then\n            if [[ $l_out =~ ^\\\\s*# ]]; then\n               l_file=\\\"${l_out//# /}\\\"\n            else\n               l_kpar=\\\"$(awk -F= '{print $1}' <<< \\\"$l_out\\\" | xargs)\\\"\n               [ \\\"$l_kpar\\\" = \\\"$l_parameter_name\\\" ] && A_out+=([\\\"$l_kpar\\\"]=\\\"$l_file\\\")\n            fi\n         fi\n      done < <(\\\"$l_systemdsysctl\\\" --cat-config | grep -Po '^\\\\h*([^#\\\\n\\\\r]+|#\\\\h*\\\\/[^#\\\\n\\\\r\\\\h]+\\\\.conf\\\\b)')\n      if [ -n \\\"$l_ufwscf\\\" ]; then # Account for systems with UFW (Not covered by systemd-sysctl --cat-config)\n         l_kpar=\\\"$(grep -Po \\\"^\\\\h*$l_parameter_name\\\\b\\\" \\\"$l_ufwscf\\\" | xargs)\\\"\n         l_kpar=\\\"${l_kpar//\\\\//.}\\\"\n         [ \\\"$l_kpar\\\" = \\\"$l_parameter_name\\\" ] && A_out+=([\\\"$l_kpar\\\"]=\\\"$l_ufwscf\\\")\n      fi\n      if (( ${#A_out[@]} > 0 )); then # Assess output from files and generate output\n         while IFS=\\\"=\\\" read -r l_fkpname l_file_parameter_value; do\n            l_fkpname=\\\"${l_fkpname// /}\\\"; l_file_parameter_value=\\\"${l_file_parameter_value// /}\\\"\n            if grep -Pq -- '\\\\b'\\\"$l_parameter_value\\\"'\\\\b' <<< \\\"$l_file_parameter_value\\\"; then\n               a_output+=(\\\" - \\\\\\\"$l_parameter_name\\\\\\\" is correctly set to \\\\\\\"$l_file_parameter_value\\\\\\\"\\\" \\\\\n               \\\"    in \\\\\\\"$(printf '%s' \\\"${A_out[@]}\\\")\\\\\\\"\\\")\n            else\n               a_output2+=(\\\" - \\\\\\\"$l_parameter_name\\\\\\\" is incorrectly set to \\\\\\\"$l_file_parameter_value\\\\\\\"\\\"\n               \\\"    in \\\\\\\"$(printf '%s' \\\"${A_out[@]}\\\")\\\\\\\"\\\" \\\\\n               \\\"    and should have a value of: \\\\\\\"$l_value_out\\\\\\\"\\\")\n            fi\n         done < <(grep -Po -- \\\"^\\\\h*$l_parameter_name\\\\h*=\\\\h*\\\\H+\\\" \\\"${A_out[@]}\\\")\n      else\n         a_output2+=(\\\" - \\\\\\\"$l_parameter_name\\\\\\\" is not set in an included file\\\" \\\\\n         \\\"    ** Note: \\\\\\\"$l_parameter_name\\\\\\\" May be set in a file that's ignored by load procedure **\\\")\n      fi\n   }\n   l_systemdsysctl=\\\"$(readlink -f /lib/systemd/systemd-sysctl)\\\"\n   while IFS=\\\"=\\\" read -r l_parameter_name l_parameter_value; do # Assess and check parameters\n      l_parameter_name=\\\"${l_parameter_name// /}\\\"; l_parameter_value=\\\"${l_parameter_value// /}\\\"\n      l_value_out=\\\"${l_parameter_value//-/ through }\\\"; l_value_out=\\\"${l_value_out//|/ or }\\\"\n      l_value_out=\\\"$(tr -d '(){}' <<< \\\"$l_value_out\\\")\\\"\n      if grep -q '^net.ipv6.' <<< \\\"$l_parameter_name\\\"; then\n         [ -z \\\"$l_ipv6_disabled\\\" ] && f_ipv6_chk\n         if [ \\\"$l_ipv6_disabled\\\" = \\\"yes\\\" ]; then\n            a_output+=(\\\" - IPv6 is disabled on the system, \\\\\\\"$l_parameter_name\\\\\\\" is not applicable\\\")\n         else\n            f_kernel_parameter_chk\n         fi\n      else\n         f_kernel_parameter_chk\n      fi\n   done < <(printf '%s\\\\n' \\\"${a_parlist[@]}\\\")\n   if [ \\\"${#a_output2[@]}\\\" -le 0 ]; then\n      printf '%s\\\\n' \\\"\\\" \\\"- Audit Result:\\\" \\\"  ** PASS **\\\" \\\"${a_output[@]}\\\" \\\"\\\"\n   else\n      printf '%s\\\\n' \\\"\\\" \\\"- Audit Result:\\\" \\\"  ** FAIL **\\\" \\\" - Reason(s) for audit failure:\\\" \\\"${a_output2[@]}\\\"\n      [ \\\"${#a_output[@]}\\\" -gt 0 ] && printf '%s\\\\n' \\\"\\\" \\\"- Correctly set:\\\" \\\"${a_output[@]}\\\" \\\"\\\"\n   fi\n}",
  "expect": "(?i)^[\\\\s]*\\\\**[\\\\s]*pass:?[\\\\s]*\\\\**$"
}